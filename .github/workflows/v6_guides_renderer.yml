name: Render v6 Guides (per-page)

on:
  workflow_dispatch: {}

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Playwright
        run: |
          python -m pip install --upgrade pip
          python -m pip install playwright
          python -m playwright install --with-deps chromium

      - name: Render guides
        run: |
          python - <<'PY'
          import hashlib
          import json
          import os
          from collections import deque
          from datetime import datetime, timezone
          from urllib.parse import urlparse, urljoin
          from pathlib import Path as PathlibPath
          from playwright.sync_api import sync_playwright

          ENTRY_URL = "https://www.tradingview.com/pine-script-docs/welcome/"
          DOMAIN = "www.tradingview.com"
          PATH_PREFIX = "/pine-script-docs/"
          EXCLUDE_PATH_PREFIXES = (
              "/pine-script-reference/",
              "/blog/",
              "/community/",
              "/support/",
              "/forum/",
          )

          def utc_run_id() -> str:
              return datetime.now(timezone.utc).strftime("%Y%m%dT%H%M%SZ")

          def canonicalize(url: str) -> str:
              parsed = urlparse(url)
              if parsed.scheme not in ("http", "https"):
                  return ""
              if parsed.netloc != DOMAIN:
                  return ""
              path = parsed.path or "/"
              if not path.startswith(PATH_PREFIX):
                  return ""
              for prefix in EXCLUDE_PATH_PREFIXES:
                  if path.startswith(prefix):
                      return ""
              if path == PATH_PREFIX:
                  return ""
              return f"https://{DOMAIN}{path}"

          def slugify(path: str) -> str:
              path = path.strip("/")
              if not path:
                  return "index"
              return path.replace("/", "__")

          run_id = utc_run_id()
          output_root = PathlibPath("raw") / "rendered" / "v6" / "guides" / run_id
          output_root.mkdir(parents=True, exist_ok=True)

          with sync_playwright() as p:
              browser = p.chromium.launch(headless=True)
              version_attr = getattr(browser, "version", None)
              if callable(version_attr):
                  browser_version = version_attr()
              else:
                  browser_version = "unknown"
              context = browser.new_context(
                  viewport={"width": 1440, "height": 900},
                  locale="en-US",
                  timezone_id="UTC",
                  user_agent="PineScript-Builder rendered acquisition/0.1",
              )

              queue = deque([ENTRY_URL])
              seen = set()
              rendered = []

              while queue:
                  url = queue.popleft()
                  canon = canonicalize(url)
                  if not canon or canon in seen:
                      continue
                  seen.add(canon)

                  page = context.new_page()
                  page.goto(canon, wait_until="domcontentloaded", timeout=60000)
                  page.wait_for_timeout(1000)
                  html = page.content()

                  hrefs = page.evaluate(
                      """
                      () => Array.from(document.querySelectorAll('a[href]'))
                        .map(a => a.getAttribute('href'))
                        .filter(h => h)
                      """
                  )
                  for href in hrefs:
                      next_url = urljoin(canon, href)
                      next_canon = canonicalize(next_url)
                      if next_canon and next_canon not in seen:
                          queue.append(next_canon)

                  page.close()

                  parsed = urlparse(canon)
                  slug = slugify(parsed.path)
                  html_file = output_root / f"{slug}.html"
                  manifest_file = output_root / f"{slug}.manifest.json"

                  html_bytes = html.encode("utf-8")
                  checksum = hashlib.sha256(html_bytes).hexdigest()

                  with html_file.open("wb") as handle:
                      handle.write(html_bytes)

                  manifest = {
                      "manifest_version": "1.0",
                      "canonical_url": canon,
                      "doc_type": "guide",
                      "pine_version": "v6",
                      "run_id": run_id,
                      "capture_method": "rendered_playwright",
                      "capture_timestamp": datetime.now(timezone.utc)
                      .isoformat()
                      .replace("+00:00", "Z"),
                      "render_engine": "playwright",
                      "browser_name": "chromium",
                      "browser_version": browser_version,
                      "user_agent": "PineScript-Builder rendered acquisition/0.1",
                      "viewport": {"width": 1440, "height": 900},
                      "locale": "en-US",
                      "timezone": "UTC",
                      "render_wait_strategy": "domcontentloaded",
                      "max_wait_seconds": 60,
                      "post_render_delay_ms": 1000,
                      "anchor_count_total": 0,
                      "anchor_counts_by_prefix": {},
                      "artifact_path": str(html_file),
                      "artifact_size_bytes": len(html_bytes),
                      "artifact_checksum_sha256": checksum,
                      "status": "complete",
                      "notes": "anchors_not_used",
                  }

                  with manifest_file.open("w", encoding="utf-8") as handle:
                      json.dump(manifest, handle, indent=2, sort_keys=True)
                      handle.write("\n")

                  rendered.append((canon, html_file, manifest_file))

              browser.close()

          if not rendered:
              raise SystemExit("no_guides_rendered")

          for _, html_file, manifest_file in rendered:
              if not html_file.exists() or not manifest_file.exists():
                  raise SystemExit(f"missing_artifact:{html_file}")
          PY

      - name: Commit artifacts
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add raw/rendered/v6/guides
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "chore: add v6 guides rendered artifacts"
          git push

<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><script data-astro-exec="">
			const url = window.location.href;
			const expectedUrl = url.replace(
				/^https:\/\/(?!beta)(\w+\.)?tradingview\.com/,
				'https://www.tradingview.com',
			);
			if (url !== expectedUrl) {
				window.location.replace(expectedUrl);
			}
		</script><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="none"><link rel="icon" href="https://static.tradingview.com/static/images/favicon.ico"><link rel="icon" type="image/svg+xml" href="/pine-script-docs/favicon.svg"><title>Writing / Profiling and optimization</title><meta name="og:title" content="Writing / Profiling and optimization"><meta name="twitter:title" content="Writing / Profiling and optimization"><meta name="description" content="Everything you need to know about Pine Script®."><meta name="og:description" content="Everything you need to know about Pine Script®."><meta name="twitter:description" content="Everything you need to know about Pine Script®."><meta name="keywords" content="tradingview, pine, script, indicators, strategies"><meta name="og:image" content="/pine-script-docs/meta-image.png?1"><meta name="twitter:image" content="/pine-script-docs/meta-image.png?1"><meta name="og:image:width" content="1200"><meta name="og:image:height" content="630"><meta name="og:url" content="https://www.tradingview.com/pine-script-docs/writing/profiling-and-optimization/"><meta name="twitter:url" content="https://www.tradingview.com/pine-script-docs/writing/profiling-and-optimization/"><meta name="og:type" content="website"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@TradingView"><link rel="canonical" href="https://www.tradingview.com/pine-script-docs/writing/profiling-and-optimization/"><link rel="sitemap" href="/pine-script-docs/sitemap-index.xml"><link rel="stylesheet" href="/pine-script-docs/_astro/index.DfaRTfPD.css">
<link rel="stylesheet" href="/pine-script-docs/_astro/index.B9ah8c5K.css">
<style>.tv-spinner{display:none;position:absolute;margin:0 auto;border:0 solid rgb(149 152 161 / 20%);border-radius:50%;border-top-color:var(--tv-spinner-color, #2962ff);border-left-color:var(--tv-spinner-color, #2962ff);animation:tv-spinner-container-rotate .9s linear infinite}.tv-spinner-shown{display:block}.tv-spinner-size-large{top:calc(50% - 32px);left:calc(50% - 32px);width:56px;height:56px;border-width:4px}@keyframes tv-spinner-container-rotate{to{transform:rotate(360deg)}}:root{--page-background-color: #fff;background-color:var(--page-background-color)}:root[data-theme=dark]{--page-background-color: #000}body{background-color:var(--page-background-color)}#redirect-link{display:flex;position:absolute;inset:0;align-items:center;justify-content:center}#spinner{display:block;position:absolute;opacity:1;transition:opacity .2s}
.twitter-tweet:not(.twitter-tweet-rendered){padding:var(--tc-padding, 1em);border:1px solid var(--tc-border-color, #cfd9de)}.twitter-tweet:not(.twitter-tweet-rendered)>:first-child{margin-top:0}.twitter-tweet:not(.twitter-tweet-rendered)>:last-child{margin-bottom:0}lite-youtube{background-color:#000;position:relative;display:block;contain:content;background-position:center center;background-size:cover;cursor:pointer;max-width:720px}lite-youtube:before{content:attr(data-title);display:block;position:absolute;top:0;background-image:linear-gradient(180deg,#000000ab,#0000008a 14%,#00000026 54%,#0000000d 72%,#0000 94%);height:99px;width:100%;font-family:YouTube Noto,Roboto,Arial,Helvetica,sans-serif;color:#eee;text-shadow:0 0 2px rgba(0,0,0,.5);font-size:18px;padding:25px 20px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;box-sizing:border-box}lite-youtube:hover:before{color:#fff}lite-youtube:after{content:"";display:block;padding-bottom:56.25%}lite-youtube>iframe{width:100%;height:100%;position:absolute;top:0;left:0;border:0}lite-youtube>.lty-playbtn{display:block;width:100%;height:100%;background:no-repeat center/68px 48px;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 68 48"><path d="M66.52 7.74c-.78-2.93-2.49-5.41-5.42-6.19C55.79.13 34 0 34 0S12.21.13 6.9 1.55c-2.93.78-4.63 3.26-5.42 6.19C.06 13.05 0 24 0 24s.06 10.95 1.48 16.26c.78 2.93 2.49 5.41 5.42 6.19C12.21 47.87 34 48 34 48s21.79-.13 27.1-1.55c2.93-.78 4.64-3.26 5.42-6.19C67.94 34.95 68 24 68 24s-.06-10.95-1.48-16.26z" fill="red"/><path d="M45 24 27 14v20" fill="white"/></svg>');position:absolute;cursor:pointer;z-index:1;filter:grayscale(100%);transition:filter .1s cubic-bezier(0,0,.2,1);border:0}lite-youtube:hover>.lty-playbtn,lite-youtube .lty-playbtn:focus{filter:none}lite-youtube.lyt-activated{cursor:unset}lite-youtube.lyt-activated:before,lite-youtube.lyt-activated>.lty-playbtn{opacity:0;pointer-events:none}.lyt-visually-hidden{clip:rect(0 0 0 0);clip-path:inset(50%);height:1px;overflow:hidden;position:absolute;white-space:nowrap;width:1px}lite-youtube>iframe{all:unset!important;width:100%!important;height:100%!important;position:absolute!important;inset:0!important;border:0!important}lite-vimeo{font-size:10px;background-color:#000;position:relative;display:block;contain:content;background-position:center center;background-size:cover}lite-vimeo:after{content:"";display:block;padding-bottom:56.25%}lite-vimeo>iframe{all:unset!important;width:100%!important;height:100%!important;position:absolute!important;inset:0!important;border:0!important}lite-vimeo>.ltv-playbtn{content:"";position:absolute;inset:0;width:100%;background:transparent;outline:0;border:0;cursor:pointer}lite-vimeo>.ltv-playbtn:before{width:6.5em;height:4em;background:#172322bf;opacity:.8;border-radius:.25rem;transition:all .2s cubic-bezier(0,0,.2,1)}lite-vimeo>.ltv-playbtn:focus:before{outline:auto}lite-vimeo:hover>.ltv-playbtn:before{background-color:#00adef;background-color:var(--ltv-color, #00adef);opacity:1}lite-vimeo>.ltv-playbtn:after{border-style:solid;border-width:1em 0 1em 1.7em;border-color:transparent transparent transparent #fff}lite-vimeo>.ltv-playbtn:before,lite-vimeo>.ltv-playbtn:after{content:"";position:absolute;top:50%;left:50%;transform:translate3d(-50%,-50%,0)}lite-vimeo.ltv-activated:before,lite-vimeo.ltv-activated>.ltv-playbtn{cursor:unset;opacity:0;pointer-events:none}
</style><script type="module" src="/pine-script-docs/_astro/hoisted.wfEHaJbk.js" data-astro-exec=""></script><style id="tv-pine-light" type="text/css" media="screen">.monaco-editor-tv-pine-light { 
.mtk1 { color: #131722; }
.mtk2 { color: #ffffff; }
.mtk3 { color: #808080; }
.mtk4 { color: #ff0000; }
.mtk5 { color: #0451a5; }
.mtk6 { color: #0000ff; }
.mtk7 { color: #098658; }
.mtk8 { color: #008000; }
.mtk9 { color: #9598a1; }
.mtk10 { color: #dd0000; }
.mtk11 { color: #cc2929; }
.mtk12 { color: #f57f17; }
.mtk13 { color: #000000; }
.mtk14 { color: #383838; }
.mtk15 { color: #0c3299; }
.mtk16 { color: #2962ff; }
.mtk17 { color: #8e24aa; }
.mtk18 { color: #22ab94; }
.mtk19 { color: #cd3131; }
.mtk20 { color: #863b00; }
.mtk21 { color: #af00db; }
.mtk22 { color: #800000; }
.mtk23 { color: #e00000; }
.mtk24 { color: #3030c0; }
.mtk25 { color: #666666; }
.mtk26 { color: #778899; }
.mtk27 { color: #c700c7; }
.mtk28 { color: #a31515; }
.mtk29 { color: #388e3c; }
.mtk30 { color: #4f76ac; }
.mtk31 { color: #008080; }
.mtk32 { color: #001188; }
.mtk33 { color: #2a2e39; }
.mtk34 { color: #4864aa; }
.mtki { font-style: italic; }
.mtkb { font-weight: bold; }
.mtku { text-decoration: underline; text-underline-position: under; }
.mtks { text-decoration: line-through; }
.mtks.mtku { text-decoration: underline line-through; text-underline-position: under; } }</style></head> <body> <div id="search-content-blur" hidden=""></div> <script data-astro-exec="">
	/* eslint-disable @typescript-eslint/typedef */
	window.ThemeProvider = (() => {
		function getCurrent() {
			return (
				// eslint-disable-next-line no-restricted-syntax
				typeof localStorage !== 'undefined' &&
				localStorage.getItem('tv-docs-theme')
			);
		}
		const storedTheme = getCurrent();
		const theme =
			storedTheme ||
			(window.matchMedia('(prefers-color-scheme: light)').matches ?
				'light'
			:	'dark');
		document.documentElement.dataset.theme =
			theme === 'light' ? 'light' : 'dark';
		document.documentElement.classList.toggle(
			'theme-dark',
			theme === 'dark',
		); // add support for ui-lib themes
		document.documentElement.classList.toggle(
			'sl-theme-dark',
			theme === 'dark',
		); // add support for shoelace themes

		return {
			updatePickers(themeArg = storedTheme || 'auto') {
				let currentTheme = themeArg;
				if (currentTheme === 'unknown') {
					currentTheme = getCurrent() || 'auto';
				}
				document
					.querySelectorAll('docs-theme-select')
					.forEach((picker) => {
						const select = picker.querySelector('select');
						if (select) select.value = currentTheme;
						/** @type {HTMLTemplateElement | null} */
						const tmpl = document.querySelector(`#theme-icons`);
						const newIcon =
							tmpl &&
							tmpl.content.querySelector('.' + currentTheme);
						if (newIcon) {
							const oldIcon =
								picker.querySelector('svg.label-icon');
							if (oldIcon) {
								oldIcon.replaceChildren(
									...newIcon.cloneNode(true).childNodes,
								);
							}
						}
					});
			},
		};
	})();
	/* eslint-enable @typescript-eslint/typedef */
</script><template id="theme-icons"><svg width="16" height="16" viewBox="0 0 28 28" class="light" data-icon="theme/sun-28">  <symbol id="ai:local:theme/sun-28"><g fill="currentColor"><path d="M14 3h1.5v5H14zm0 18h1.5v5H14zm12-5.5V14h-5v1.5zM8 14v1.5H3V14zm15.3-7-1-1-3.6 3.6 1.1 1 3.5-3.5ZM9.5 18.7l1.1 1.1-3.5 3.5-1-1zM22 23.3l1-1-3.6-3.6-1 1.1 3.5 3.5ZM10.3 9.6l-1.1 1-3.5-3.5 1-1z"></path><path fill-rule="evenodd" d="M19 14.5a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0m-1.5 0a3 3 0 1 1-6 0 3 3 0 0 1 6 0" clip-rule="evenodd"></path></g></symbol><use xlink:href="#ai:local:theme/sun-28"></use>  </svg><svg width="16" height="16" viewBox="0 0 28 28" class="dark" data-icon="theme/moon-28">  <symbol id="ai:local:theme/moon-28"><path fill="currentColor" fill-rule="evenodd" d="M21 7.02A9.23 9.23 0 0 0 15.2 5 9.1 9.1 0 0 0 6 14c0 4.97 4.12 9 9.2 9a9.33 9.33 0 0 0 5.8-2.02A7 7 0 0 1 14.36 14 7 7 0 0 1 21 7.02m-3.95-.3a8 8 0 0 0-1.85-.22A7.6 7.6 0 0 0 7.5 14a7.6 7.6 0 0 0 7.7 7.5 8 8 0 0 0 1.85-.22A8.46 8.46 0 0 1 12.86 14c0-3.1 1.69-5.8 4.19-7.28" clip-rule="evenodd"></path></symbol><use xlink:href="#ai:local:theme/moon-28"></use>  </svg><svg width="16" height="16" viewBox="0 0 28 28" class="auto" data-icon="theme/system-28">  <symbol id="ai:local:theme/system-28"><path fill="currentColor" d="M8 4h1v2H8zm0 9v2h1v-2zm6-3V9h-2v1zM3 9v1h2V9zm5.5 3a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5m4.2-6-.7-.7-1.4 1.4.7.7zM5 13.7l-.7-.7 1.4-1.4.7.7zm7.7-.7-.7.7-1.4-1.4.7-.7zM4.3 6l.7-.7 1.4 1.4-.7.7zm3 17 14-14 .8.7L8 23.7zm17.2-.1a3.5 3.5 0 0 1-3.4-5.9H21a4 4 0 1 0 3.5 5.9"></path></symbol><use xlink:href="#ai:local:theme/system-28"></use>  </svg></template> <div class="backdrop" data-mobile-menu-backdrop="" data-astro-cid-h2irkosh=""></div> <div class="menu-container" data-astro-cid-h2irkosh=""> <div class="header" data-astro-cid-h2irkosh=""> <div class="header-group" data-astro-cid-h2irkosh=""> <div id="version-select" data-astro-cid-kx7qoxgq=""> <label style="--sl-select-width: undefined; --sl-label-icon-size: 16px;" data-astro-cid-lmznfliq=""> <span class="sr-only" data-astro-cid-lmznfliq="">Version</span>  <select value="v6" data-has-border="" no-icon="true" data-astro-cid-lmznfliq=""> <option value="v6" selected="true" data-astro-cid-lmznfliq="">Version 6</option><option value="v5" data-astro-cid-lmznfliq="">Version 5</option><option value="v4" data-astro-cid-lmznfliq="">Version 4</option><option value="v3" data-astro-cid-lmznfliq="">Version 3</option> </select> <svg width="16" height="16" viewBox="0 0 24 24" class="icon caret" data-astro-cid-lmznfliq="" data-icon="theme/down-caret">  <symbol id="ai:local:theme/down-caret"><path fill="currentColor" d="M17 9.17a1 1 0 0 0-1.41 0L12 12.71 8.46 9.17a1 1 0 1 0-1.41 1.42l4.24 4.24a1 1 0 0 0 1.42 0L17 10.59a1 1 0 0 0 0-1.42"></path></symbol><use xlink:href="#ai:local:theme/down-caret"></use>  </svg> </label>  </div>   <docs-theme-select class="" data-astro-cid-3wpspbi7=""> <label style="--sl-select-width: 48px; --sl-label-icon-size: 28px;" data-astro-cid-lmznfliq=""> <span class="sr-only" data-astro-cid-lmznfliq="">Theme</span> <svg width="28" height="28" viewBox="0 0 28 28" class="icon label-icon" data-button="" data-round="" data-astro-cid-lmznfliq="" data-icon="theme/system-28">  <symbol id="ai:local:theme/system-28"><path fill="currentColor" d="M8 4h1v2H8zm0 9v2h1v-2zm6-3V9h-2v1zM3 9v1h2V9zm5.5 3a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5m4.2-6-.7-.7-1.4 1.4.7.7zM5 13.7l-.7-.7 1.4-1.4.7.7zm7.7-.7-.7.7-1.4-1.4.7-.7zM4.3 6l.7-.7 1.4 1.4-.7.7zm3 17 14-14 .8.7L8 23.7zm17.2-.1a3.5 3.5 0 0 1-3.4-5.9H21a4 4 0 1 0 3.5 5.9"></path></symbol><use xlink:href="#ai:local:theme/system-28"></use>  </svg> <select value="auto" data-button="" data-astro-cid-lmznfliq=""> <option value="dark" data-astro-cid-lmznfliq="">&nbsp;&nbsp;Dark&nbsp;&nbsp;</option><option value="light" data-astro-cid-lmznfliq="">&nbsp;&nbsp;Light&nbsp;&nbsp;</option><option value="auto" selected="true" data-astro-cid-lmznfliq="">&nbsp;&nbsp;Auto&nbsp;&nbsp;</option> </select>  </label>  </docs-theme-select>   <script data-astro-exec="">
	ThemeProvider.updatePickers('unknown');
</script>  </div> <div class="header-group" data-astro-cid-h2irkosh="">  <div class="not-content" style="stroke-width:2px" data-astro-cid-pkzv2hgs=""> <button id="mobile-menu-back-button" title="Close menu" data-astro-cid-pkzv2hgs="" class="not-content stvb-base stvb-pointer stvb-gray stvb-medium stvb-primary stvb-icon">  <svg width="28" height="28" viewBox="0 0 28 28" data-astro-cid-h2irkosh="" data-icon="theme/arrow-back">  <symbol id="ai:local:theme/arrow-back"><g fill="none"><g clip-path="url(#a)"><path stroke="var(--arrow-fill-color, #131722)" d="m17 20-6-6 6-6"></path></g><defs><clipPath id="a"><path fill="#fff" d="M28 28H0V0h28z"></path></clipPath></defs></g></symbol><use xlink:href="#ai:local:theme/arrow-back"></use>  </svg>  </button> </div>  </div> </div> <aside id="nav" class="keep-visible" style="--navbar-right-border-width: 0px" data-astro-cid-sa57sq6l=""> <div class="sidebar-viewport slick-scroll" data-astro-cid-sa57sq6l=""> <div class="sidebar" data-mobile="" data-astro-cid-sa57sq6l=""> <ul class="toc" aria-label="Docs sidebar" data-astro-cid-sa57sq6l=""> <li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/welcome" data-astro-cid-omxx3dey="">Welcome to Pine Script® v6</a></li><li class="item" data-astro-cid-omxx3dey=""><details data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey="">Pine Script® primer</div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/primer/first-steps" data-astro-cid-omxx3dey="">First steps</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/primer/first-indicator" data-astro-cid-omxx3dey="">First indicator</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/primer/next-steps" data-astro-cid-omxx3dey="">Next steps</a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><details data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey="">Language</div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/execution-model" data-astro-cid-omxx3dey="">Execution model</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/type-system" data-astro-cid-omxx3dey="">Type system</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/script-structure" data-astro-cid-omxx3dey="">Script structure</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/identifiers" data-astro-cid-omxx3dey="">Identifiers</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/variable-declarations" data-astro-cid-omxx3dey="">Variable declarations</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/operators" data-astro-cid-omxx3dey="">Operators</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/conditional-structures" data-astro-cid-omxx3dey="">Conditional structures</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/loops" data-astro-cid-omxx3dey="">Loops</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/built-ins" data-astro-cid-omxx3dey="">Built-ins</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/user-defined-functions" data-astro-cid-omxx3dey="">User-defined functions</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/objects" data-astro-cid-omxx3dey="">Objects</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/enums" data-astro-cid-omxx3dey="">Enums</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/methods" data-astro-cid-omxx3dey="">Methods</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/arrays" data-astro-cid-omxx3dey="">Arrays</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/matrices" data-astro-cid-omxx3dey="">Matrices</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/maps" data-astro-cid-omxx3dey="">Maps</a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><details data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey="">Visuals</div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/overview" data-astro-cid-omxx3dey="">Overview</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/backgrounds" data-astro-cid-omxx3dey="">Backgrounds</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/bar-coloring" data-astro-cid-omxx3dey="">Bar coloring</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/bar-plotting" data-astro-cid-omxx3dey="">Bar plotting</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/colors" data-astro-cid-omxx3dey="">Colors</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/fills" data-astro-cid-omxx3dey="">Fills</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/levels" data-astro-cid-omxx3dey="">Levels</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/lines-and-boxes" data-astro-cid-omxx3dey="">Lines and boxes</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/plots" data-astro-cid-omxx3dey="">Plots</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/tables" data-astro-cid-omxx3dey="">Tables</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/text-and-shapes" data-astro-cid-omxx3dey="">Text and shapes</a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><details data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey="">Concepts</div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/alerts" data-astro-cid-omxx3dey="">Alerts</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/bar-states" data-astro-cid-omxx3dey="">Bar states</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/chart-information" data-astro-cid-omxx3dey="">Chart information</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/inputs" data-astro-cid-omxx3dey="">Inputs</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/libraries" data-astro-cid-omxx3dey="">Libraries</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/non-standard-charts-data" data-astro-cid-omxx3dey="">Non-standard charts data</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/other-timeframes-and-data" data-astro-cid-omxx3dey="">Other timeframes and data</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/repainting" data-astro-cid-omxx3dey="">Repainting</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/sessions" data-astro-cid-omxx3dey="">Sessions</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/strategies" data-astro-cid-omxx3dey="">Strategies</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/strings" data-astro-cid-omxx3dey="">Strings</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/time" data-astro-cid-omxx3dey="">Time</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/timeframes" data-astro-cid-omxx3dey="">Timeframes</a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><details open="" data-is-parent="" data-is-on-path="" data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey="">Writing scripts</div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/writing/style-guide" data-astro-cid-omxx3dey="">Style guide</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/writing/debugging" data-astro-cid-omxx3dey="">Debugging</a></li><li class="item" data-current="" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/writing/profiling-and-optimization" data-astro-cid-omxx3dey="">Profiling and optimization</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/writing/publishing" data-astro-cid-omxx3dey="">Publishing scripts</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/writing/limitations" data-astro-cid-omxx3dey="">Limitations</a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><details data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey="">FAQ</div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/general" data-astro-cid-omxx3dey="">General</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/alerts" data-astro-cid-omxx3dey="">Alerts</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/data-structures" data-astro-cid-omxx3dey="">Data structures</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/functions" data-astro-cid-omxx3dey="">Functions</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/indicators" data-astro-cid-omxx3dey="">Indicators</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/other-data-and-timeframes" data-astro-cid-omxx3dey="">Other data and timeframes</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/programming" data-astro-cid-omxx3dey="">Programming</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/strategies" data-astro-cid-omxx3dey="">Strategies</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/strings-and-formatting" data-astro-cid-omxx3dey="">Strings and formatting</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/techniques" data-astro-cid-omxx3dey="">Techniques</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/times-dates-and-sessions" data-astro-cid-omxx3dey="">Times, dates, and sessions</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/variables-and-operators" data-astro-cid-omxx3dey="">Variables and operators</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/visuals" data-astro-cid-omxx3dey="">Visuals</a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/error-messages" data-astro-cid-omxx3dey="">Error messages</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/release-notes" data-astro-cid-omxx3dey="">Release notes</a></li><li class="item" data-astro-cid-omxx3dey=""><details data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey="">Migration guides</div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/migration-guides/overview" data-astro-cid-omxx3dey="">Overview</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/migration-guides/to-pine-version-6" data-astro-cid-omxx3dey="">To Pine Script® version 6</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/migration-guides/to-pine-version-5" data-astro-cid-omxx3dey="">To Pine Script® version 5</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/migration-guides/to-pine-version-4" data-astro-cid-omxx3dey="">To Pine Script® version 4</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/migration-guides/to-pine-version-3" data-astro-cid-omxx3dey="">To Pine Script® version 3</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/migration-guides/to-pine-version-2" data-astro-cid-omxx3dey="">To Pine Script® version 2</a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/where-can-i-get-more-information" data-astro-cid-omxx3dey="">Where can I get more information?</a></li> </ul> <div class="toc-bottom" data-astro-cid-sa57sq6l=""></div> </div> </div> </aside>  </div>   <header class="header" data-astro-cid-d74r2unp=""> <nav role="navigation" aria-label="Main Navigation" data-astro-cid-d74r2unp=""> <mobile-menu-button id="mobile-menu-button-wc" data-astro-cid-oojooh3d=""> <!-- Annoyingly I need to wrap this. TODO: improve this --> <div id="mobile-menu-button-header" data-astro-cid-oojooh3d=""> <div class="not-content" style="" data-astro-cid-pkzv2hgs=""> <button title="Open navigation menu" data-astro-cid-pkzv2hgs="" class="not-content stvb-base stvb-pointer stvb-gray stvb-medium stvb-secondary stvb-icon stvb-icon-force-color stvb-force-no-border">  <svg width="28" height="28" viewBox="0 0 24 24" data-astro-cid-oojooh3d="" data-icon="theme/bars">  <symbol id="ai:local:theme/bars"><path fill="currentColor" d="M3 8h18a1 1 0 1 0 0-2H3a1 1 0 0 0 0 2m18 8H3a1 1 0 0 0 0 2h18a1 1 0 0 0 0-2m0-5H3a1 1 0 0 0 0 2h18a1 1 0 0 0 0-2"></path></symbol><use xlink:href="#ai:local:theme/bars"></use>  </svg>  </button> </div>  </div> </mobile-menu-button>   <div data-hide-when-search="" data-astro-cid-d74r2unp=""> <div class="header-logo" data-astro-cid-tycb33lk=""> <a href="/pine-script-docs/" aria-label="Home button" data-astro-cid-tycb33lk=""> <div class="documentation-logo logo" data-astro-cid-tycb33lk=""><!-- Old Christmas icon -->
<!-- 
<svg width="184" height="44" viewBox="0 0 184 44" fill="none" xmlns="http://www.w3.org/2000/svg">
	<path fill-rule="evenodd" clip-rule="evenodd" d="M33.8209 5.1219C33.885 4.95937 34.115 4.95937 34.1791 5.1219L35.2253 7.77465L37.8781 8.82088C38.0406 8.88499 38.0406 9.11501 37.8781 9.17912L35.2253 10.2253L34.1791 12.8781C34.115 13.0406 33.885 13.0406 33.8209 12.8781L32.7747 10.2253L30.1219 9.17912C29.9594 9.11501 29.9594 8.88499 30.1219 8.82088L32.7747 7.77465L33.8209 5.1219Z" fill="#F9A825"/>
    <path d="M5.30092 15.1478C5.37479 14.9605 5.63986 14.9605 5.71373 15.1478L6.60557 17.4091L8.86685 18.3009C9.05415 18.3748 9.05415 18.6399 8.86685 18.7137L6.60557 19.6056L5.71373 21.8669C5.63986 22.0541 5.37479 22.0541 5.30092 21.8669L4.40908 19.6056L2.1478 18.7137C1.9605 18.6399 1.9605 18.3748 2.1478 18.3009L4.40908 17.4091L5.30092 15.1478Z" fill="#F9A825"/>
    <path d="M11.8231 3.12041C11.8864 2.95986 12.1136 2.95986 12.1769 3.12041L12.9414 5.05865L14.8796 5.82308C15.0401 5.8864 15.0401 6.1136 14.8796 6.17692L12.9414 6.94135L12.1769 8.87959C12.1136 9.04014 11.8864 9.04014 11.8231 8.87959L11.0586 6.94135L9.12041 6.17692C8.95986 6.1136 8.95986 5.8864 9.12041 5.82308L11.0586 5.05865L11.8231 3.12041Z" fill="#F9A825"/>
    <path fill-rule="evenodd" clip-rule="evenodd" d="M22.6478 7.35459L34.7627 21.6923C35.1531 22.1543 35.0472 22.8544 34.5376 23.1802L26.9989 28.0001L18.4281 20.7531L11.3382 23.2611C10.402 23.5923 9.60771 22.5041 10.2085 21.7134L21.0877 7.39502C21.4749 6.88536 22.2346 6.86567 22.6478 7.35459ZM33.432 28.0842L38.3592 34.7471C38.7427 35.2657 38.3724 36 37.7274 36H6.27248C5.62746 36 5.25722 35.2657 5.64074 34.7471L10.8523 27.6996C10.9484 27.5697 11.0822 27.4725 11.2356 27.4214L17.6878 25.2707C17.9285 25.1904 18.1932 25.2314 18.3984 25.3806L26.2854 31.1166C26.5445 31.3051 26.8922 31.3173 27.1639 31.1475L32.3838 27.885C32.7316 27.6677 33.1881 27.7544 33.432 28.0842Z" fill="#089981"/>
    <path fill-rule="evenodd" clip-rule="evenodd" d="M17.6363 11.9375C20.7386 12.451 23.1213 11.505 24.9187 10.0422L25.8869 11.1881C23.6236 13.0379 20.553 14.1584 16.6261 13.267L17.6363 11.9375ZM34.0572 20.8573C30.0669 21.363 26.2864 20.8179 23.1264 19.7076C20.7393 18.8689 18.6873 17.7013 17.155 16.3997C16.5283 15.8674 15.9767 15.3021 15.5241 14.7174L16.4708 13.4713C16.8706 14.0544 17.4225 14.6588 18.1262 15.2565C19.5001 16.4237 21.3856 17.5061 23.6236 18.2924C26.3235 19.241 29.5087 19.7493 32.8863 19.4716L34.0572 20.8573ZM9.06812 30.1123C15.4775 33.3909 23.0493 33.8897 29.0345 32.0941C31.0827 31.4796 32.9275 30.6019 34.4713 29.4897L35.3633 30.6959C33.6586 31.9268 31.6497 32.8756 29.4655 33.5309C23.053 35.4546 14.9758 34.8964 8.16479 31.3339L9.06812 30.1123Z" fill="#45E5CB"/>
    <path d="M55.56 13.96C59.016 13.96 61.536 16.456 61.536 19.696C61.536 22.936 59.016 25.432 55.56 25.432H53.376V31H49.896V13.96H55.56ZM55.512 22.168C57.096 22.168 58.152 21.088 58.152 19.696C58.152 18.304 57.096 17.224 55.512 17.224H53.376V22.168H55.512ZM66.8636 14.944C66.8636 16.096 65.9276 17.032 64.7516 17.032C63.6236 17.032 62.6636 16.096 62.6636 14.944C62.6636 13.792 63.6236 12.856 64.7516 12.856C65.9276 12.856 66.8636 13.792 66.8636 14.944ZM63.1196 31V19H66.4076V31H63.1196ZM69.0849 31V19H72.3729V20.368C72.9969 19.408 74.2449 18.736 75.8049 18.736C78.7089 18.736 80.4369 20.848 80.4369 23.968V31H77.1489V24.52C77.1489 22.792 76.4049 21.736 75.0369 21.736C73.5249 21.736 72.3729 22.84 72.3729 25.144V31H69.0849ZM82.2041 25C82.2041 21.448 84.8681 18.736 88.5161 18.736C91.6601 18.736 94.4201 20.752 94.4201 24.64C94.4201 24.928 94.4201 25.264 94.3721 25.768H85.3961C85.5881 27.376 87.0041 28.264 88.5881 28.264C90.0761 28.264 91.1561 27.568 91.6841 26.752L94.1321 28.576C93.0281 30.184 91.0841 31.264 88.5641 31.264C84.9881 31.264 82.2041 28.792 82.2041 25ZM88.4201 21.448C87.1961 21.448 85.8281 22.072 85.5161 23.536H91.1321C90.8441 22.12 89.6441 21.448 88.4201 21.448ZM100.412 28.24L103.076 26.008C103.916 27.28 105.38 28.024 106.772 28.024C108.14 28.024 109.052 27.352 109.052 26.368C109.052 25.408 108.356 24.736 106.676 24.16L105.236 23.656C102.5 22.696 101.036 21.112 101.036 18.784C101.036 15.568 103.484 13.672 106.796 13.672C108.884 13.672 110.708 14.392 112.172 16.024L109.868 18.4C109.052 17.416 107.996 16.936 106.82 16.936C105.644 16.936 104.54 17.44 104.54 18.448C104.54 19.48 105.38 19.936 107.18 20.584L108.548 21.088C111.044 22 112.604 23.584 112.604 26.152C112.58 29.2 110.156 31.288 106.628 31.288C103.916 31.288 101.636 30.112 100.412 28.24ZM125.859 27.808C124.827 29.872 122.667 31.264 120.171 31.264C116.619 31.264 113.811 28.624 113.811 25C113.811 21.376 116.619 18.736 120.171 18.736C122.667 18.736 124.827 20.128 125.859 22.192L123.003 23.728C122.523 22.624 121.491 21.808 120.171 21.808C118.443 21.808 117.123 23.152 117.123 25C117.123 26.848 118.443 28.192 120.171 28.192C121.491 28.192 122.523 27.376 123.003 26.272L125.859 27.808ZM127.482 31V19H130.77V20.92C131.178 19.744 132.402 18.856 133.746 18.856C134.082 18.856 134.442 18.88 134.85 19V22.336C134.346 22.168 133.89 22.072 133.362 22.072C131.802 22.072 130.77 23.296 130.77 25.264V31H127.482ZM140.215 14.944C140.215 16.096 139.279 17.032 138.103 17.032C136.975 17.032 136.015 16.096 136.015 14.944C136.015 13.792 136.975 12.856 138.103 12.856C139.279 12.856 140.215 13.792 140.215 14.944ZM136.471 31V19H139.759V31H136.471ZM142.436 36.016V19H145.724V20.344C146.276 19.576 147.548 18.736 149.204 18.736C152.396 18.736 154.844 21.592 154.844 25C154.844 28.408 152.396 31.264 149.204 31.264C147.548 31.264 146.276 30.424 145.724 29.656V36.016H142.436ZM151.508 25C151.508 23.128 150.284 21.736 148.484 21.736C146.684 21.736 145.46 23.128 145.46 25C145.46 26.872 146.684 28.264 148.484 28.264C150.284 28.264 151.508 26.872 151.508 25ZM164.407 30.88C163.879 31.048 163.231 31.144 162.319 31.144C159.775 31.144 157.735 29.728 157.735 26.8V21.88H155.311V19H157.735V15.664H161.023V19H164.407V21.88H161.023V26.152C161.023 27.616 161.647 28.192 163.063 28.192C163.591 28.192 164.023 28.12 164.407 27.976V30.88ZM173.626 22.648V13.96H175.978L177.874 16.888L179.746 13.96H182.122V22.648H179.698V18.184L177.874 20.968L176.026 18.136V22.648H173.626ZM167.386 22.648V16.456H165.058V13.96H172.258V16.456H169.93V22.648H167.386Z" fill="currentColor"/>
</svg> -->



<!-- Regular icon -->

<svg width="177" height="44" viewBox="0 0 177 44" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M17.6876 25.2705C17.9283 25.1902 18.1933 25.2316 18.3985 25.3808L26.2852 31.1162C26.5444 31.3047 26.8924 31.3173 27.1641 31.1474L32.3839 27.8847C32.7316 27.6675 33.1878 27.7545 33.4317 28.084L38.3594 34.7471C38.7428 35.2656 38.3725 35.9999 37.7276 36H6.27253C5.62754 36 5.25723 35.2657 5.64069 34.7471L10.8526 27.6992C10.9486 27.5695 11.0824 27.4729 11.2354 27.4219L17.6876 25.2705ZM21.088 7.39451C21.4752 6.88532 22.2345 6.8659 22.6475 7.35448L34.7628 21.6924C35.1531 22.1544 35.0468 22.8548 34.5372 23.1806L26.9991 28L18.4278 20.7529L11.338 23.2607C10.4021 23.5917 9.60809 22.5044 10.2081 21.7139L21.088 7.39451ZM13.8243 20.2597L17.7608 18.8672C18.4309 18.6301 19.1771 18.7667 19.7198 19.2256L27.1641 25.5205L32.4981 22.1103L21.9259 9.59862L13.8243 20.2597Z" fill="currentColor"></path>
<path d="M147.308 16.959C150.499 16.959 152.948 19.8149 152.948 23.2227C152.948 26.6307 150.5 29.4873 147.308 29.4873C145.652 29.4872 144.38 28.6469 143.828 27.8789V34.2393H140.54V17.2227H143.828V18.5674C144.38 17.7994 145.652 16.9591 147.308 16.959ZM104.9 11.8955C106.988 11.8956 108.812 12.6152 110.276 14.2471L107.972 16.623C107.156 15.6392 106.1 15.1592 104.924 15.1592C103.748 15.1592 102.645 15.6631 102.645 16.6709C102.645 17.7029 103.484 18.1596 105.284 18.8076L106.652 19.3115C109.148 20.2235 110.708 21.8072 110.708 24.375C110.684 27.4229 108.26 29.5106 104.732 29.5107C102.02 29.5107 99.7396 28.3349 98.5156 26.4629L101.18 24.2314C102.02 25.5034 103.484 26.247 104.876 26.2471C106.244 26.2471 107.156 25.5748 107.156 24.5908C107.156 23.631 106.46 22.9587 104.78 22.3828L103.34 21.8789C100.604 20.9189 99.1396 19.3348 99.1396 17.0068C99.1398 13.791 101.588 11.8955 104.9 11.8955ZM86.6201 16.959C89.7641 16.959 92.5244 18.9753 92.5244 22.8633C92.5244 23.1513 92.5246 23.4873 92.4766 23.9912H83.5C83.692 25.5992 85.1084 26.4873 86.6924 26.4873C88.18 26.4872 89.26 25.7914 89.7881 24.9756L92.2363 26.7988C91.1323 28.4068 89.188 29.4873 86.668 29.4873C83.092 29.4872 80.3086 27.0146 80.3086 23.2227C80.3088 19.6709 82.9723 16.959 86.6201 16.959ZM118.275 16.959C120.771 16.9591 122.931 18.3512 123.963 20.415L121.107 21.9512C120.627 20.8473 119.595 20.0314 118.275 20.0312C116.548 20.0312 115.227 21.3749 115.227 23.2227C115.227 25.0707 116.547 26.415 118.275 26.415C119.595 26.4149 120.627 25.599 121.107 24.4951L123.963 26.0312C122.931 28.0951 120.771 29.4872 118.275 29.4873C114.723 29.4873 111.915 26.8467 111.915 23.2227C111.915 19.5989 114.724 16.959 118.275 16.959ZM159.127 17.2227H162.511V20.1035H159.127V24.375C159.127 25.839 159.751 26.415 161.167 26.415C161.695 26.415 162.127 26.3432 162.511 26.1992V29.1035C161.983 29.2715 161.335 29.3672 160.423 29.3672C157.879 29.3672 155.839 27.9512 155.839 25.0234V20.1035H153.415V17.2227H155.839V13.8867H159.127V17.2227ZM53.6641 12.1836C57.12 12.1836 59.6395 14.6791 59.6396 17.9189C59.6396 21.1589 57.12 23.6552 53.6641 23.6553H51.4805V29.2227H48V12.1836H53.6641ZM64.5117 29.2227H61.2236V17.2227H64.5117V29.2227ZM73.9092 16.959C76.813 16.9591 78.541 19.0715 78.541 22.1914V29.2227H75.2529V22.7432C75.2529 21.0152 74.5086 19.959 73.1406 19.959C71.6288 19.9591 70.4766 21.0633 70.4766 23.3672V29.2227H67.1885V17.2227H70.4766V18.5908C71.1006 17.6308 72.3492 16.959 73.9092 16.959ZM131.85 17.0791C132.186 17.0791 132.546 17.1027 132.954 17.2227V20.5596C132.45 20.3916 131.994 20.2949 131.466 20.2949C129.906 20.2949 128.874 21.5193 128.874 23.4873V29.2227H125.586V17.2227H128.874V19.1436C129.282 17.9676 130.506 17.0792 131.85 17.0791ZM137.862 29.2227H134.574V17.2227H137.862V29.2227ZM146.588 19.959C144.788 19.959 143.564 21.3509 143.563 23.2227C143.563 25.0947 144.788 26.4873 146.588 26.4873C148.388 26.4873 149.612 25.0947 149.612 23.2227C149.612 21.3509 148.388 19.959 146.588 19.959ZM169.993 9.76074C170.876 9.76079 171.697 9.9237 172.455 10.25C173.213 10.5764 173.881 11.0326 174.457 11.6182C175.043 12.1942 175.499 12.8617 175.825 13.6201C176.151 14.3783 176.314 15.1991 176.314 16.082C176.314 16.9556 176.152 17.7769 175.825 18.5449C175.499 19.3032 175.043 19.975 174.457 20.5605C173.881 21.1365 173.208 21.5877 172.44 21.9141C171.682 22.2404 170.867 22.4042 169.993 22.4043C169.12 22.4043 168.298 22.2405 167.53 21.9141C166.772 21.5877 166.1 21.1365 165.515 20.5605C164.939 19.975 164.488 19.3032 164.161 18.5449C163.835 17.7769 163.671 16.9556 163.671 16.082C163.671 15.2086 163.835 14.393 164.161 13.6348C164.488 12.8668 164.939 12.1942 165.515 11.6182C166.1 11.0327 166.772 10.5764 167.53 10.25C168.298 9.92362 169.12 9.76074 169.993 9.76074ZM86.5244 19.6709C85.3005 19.6709 83.9323 20.295 83.6201 21.7588H89.2363C88.9482 20.3431 87.7482 19.671 86.5244 19.6709ZM169.993 11.1865C169.312 11.1865 168.672 11.3109 168.077 11.5605C167.492 11.8101 166.974 12.1612 166.522 12.6123C166.071 13.0635 165.72 13.5865 165.471 14.1816C165.221 14.7671 165.097 15.4006 165.097 16.082C165.097 16.7634 165.221 17.402 165.471 17.9971C165.72 18.5827 166.071 19.1015 166.522 19.5527C166.974 20.0038 167.492 20.3539 168.077 20.6035C168.672 20.8531 169.312 20.9785 169.993 20.9785C170.675 20.9785 171.308 20.8531 171.894 20.6035C172.489 20.3539 173.012 20.0038 173.463 19.5527C173.914 19.1015 174.265 18.5827 174.515 17.9971C174.764 17.402 174.889 16.7634 174.889 16.082C174.889 15.4006 174.764 14.7671 174.515 14.1816C174.265 13.5865 173.914 13.0635 173.463 12.6123C173.012 12.1611 172.489 11.8101 171.894 11.5605C171.308 11.311 170.675 11.1866 169.993 11.1865ZM51.4805 20.3916H53.6162C55.2001 20.3915 56.2559 19.3109 56.2559 17.9189C56.2558 16.5271 55.2 15.4474 53.6162 15.4473H51.4805V20.3916ZM169.878 13.2314C170.406 13.2315 170.838 13.2932 171.174 13.418C171.519 13.5332 171.773 13.7163 171.937 13.9658C172.1 14.2154 172.182 14.5271 172.182 14.9014C172.182 15.2469 172.09 15.5494 171.908 15.8086C171.726 16.0581 171.481 16.2646 171.174 16.4277L172.815 18.9336H171.217L169.964 16.8027H169.445V18.9336H168.034V13.2314H169.878ZM169.445 15.751H169.849C170.127 15.751 170.348 15.6932 170.511 15.5781C170.674 15.4533 170.756 15.247 170.756 14.959C170.756 14.7383 170.684 14.5703 170.54 14.4551C170.396 14.3399 170.165 14.2822 169.849 14.2822H169.445V15.751ZM62.8555 11.0791C64.0314 11.0791 64.9677 12.0151 64.9678 13.167C64.9678 14.319 64.0315 15.2549 62.8555 15.2549C61.7275 15.2548 60.7676 14.3189 60.7676 13.167C60.7677 12.0151 61.7276 11.0792 62.8555 11.0791ZM136.207 11.0791C137.383 11.0793 138.318 12.0152 138.318 13.167C138.318 14.3188 137.383 15.2546 136.207 15.2549C135.079 15.2549 134.118 14.319 134.118 13.167C134.118 12.0151 135.079 11.0791 136.207 11.0791Z" fill="currentColor"></path>
</svg>
</div> </a> </div>  </div> <div class="flex" data-astro-cid-d74r2unp=""></div> <div class="flex" data-astro-cid-d74r2unp=""> <div class="search-container" data-astro-cid-fg37foga=""> <div class="search-wrapper" data-astro-cid-fg37foga=""> <input class="search-input" type="text" placeholder="Search docs" name="s" value="" data-astro-cid-fg37foga="" data-has-input-listener="true"> <svg width="28" height="28" viewBox="0 0 28 28" class="search-button" data-astro-cid-fg37foga="" data-icon="theme/search">  <symbol id="ai:local:theme/search"><path fill="currentColor" fill-rule="evenodd" d="M18.5 12.5a6 6 0 1 1-12 0 6 6 0 0 1 12 0m-1.25 5.8a7.5 7.5 0 1 1 1.06-1.06l4.22 4.23.53.53L22 23.06l-.53-.53-4.22-4.22Z" clip-rule="evenodd"></path></symbol><use xlink:href="#ai:local:theme/search"></use>  </svg> <button class="search-clear" type="button" title="Reset" data-search-clear="" data-astro-cid-fg37foga="">Clear</button> <span class="divider" data-astro-cid-fg37foga=""></span> <button class="search-close" type="button" title="Close" data-search-close="" data-astro-cid-fg37foga=""> <svg width="18" height="18" viewBox="0 0 18 18" data-astro-cid-fg37foga="" data-icon="theme/cross-18">  <use xlink:href="#ai:local:theme/cross-18"></use>  </svg> </button> </div> <div id="search-results-wrapper" data-astro-cid-fg37foga=""> <aside id="search-results" hidden="" data-astro-cid-fg37foga="" data-has-button-listener="true"> <!-- Don't use h1 because when built it will be used as the first heading on the page --> <div class="heading" data-astro-cid-fg37foga="">Search results</div> <div id="search-results-contents" data-astro-cid-fg37foga=""></div> </aside> </div> </div>   </div> <ul class="links" data-astro-cid-d74r2unp="">  </ul> <div class="flex" data-astro-cid-d74r2unp=""></div> <div data-hide-when-search="" data-astro-cid-d74r2unp=""> <div id="version-select" data-hideable="true" data-astro-cid-kx7qoxgq=""> <label style="--sl-select-width: undefined; --sl-label-icon-size: 16px;" data-astro-cid-lmznfliq=""> <span class="sr-only" data-astro-cid-lmznfliq="">Version</span>  <select value="v6" data-has-border="" no-icon="true" data-astro-cid-lmznfliq=""> <option value="v6" selected="true" data-astro-cid-lmznfliq="">Version 6</option><option value="v5" data-astro-cid-lmznfliq="">Version 5</option><option value="v4" data-astro-cid-lmznfliq="">Version 4</option><option value="v3" data-astro-cid-lmznfliq="">Version 3</option> </select> <svg width="16" height="16" viewBox="0 0 24 24" class="icon caret" data-astro-cid-lmznfliq="" data-icon="theme/down-caret">  <use xlink:href="#ai:local:theme/down-caret"></use>  </svg> </label>  </div>   </div> <button id="search-button" data-astro-cid-6zeqadij="" data-has-listener="true"> <svg width="28" height="28" viewBox="0 0 28 28" data-astro-cid-6zeqadij="" data-icon="theme/search">  <use xlink:href="#ai:local:theme/search"></use>  </svg> </button>  <script data-base-url="/pine-script-docs" data-astro-exec="">
	async function loadPageFind() {
		const base = document.currentScript.getAttribute('data-base-url');
		const pageFindBundleUrl = `${base}/pagefind/`;
		const pagefind = await import(`${pageFindBundleUrl}pagefind.js`);
		await pagefind.options({
			bundlePath: pageFindBundleUrl,
		});
		window.pagefind = pagefind;
	}
	loadPageFind().catch();
</script>  <docs-theme-select class="hide-with-breakpoint-568" data-astro-cid-3wpspbi7=""> <label style="--sl-select-width: 48px; --sl-label-icon-size: 28px;" data-astro-cid-lmznfliq=""> <span class="sr-only" data-astro-cid-lmznfliq="">Theme</span> <svg width="28" height="28" viewBox="0 0 28 28" class="icon label-icon" data-button="" data-round="" data-astro-cid-lmznfliq="" data-icon="theme/system-28">  <symbol id="ai:local:theme/system-28"><path fill="currentColor" d="M8 4h1v2H8zm0 9v2h1v-2zm6-3V9h-2v1zM3 9v1h2V9zm5.5 3a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5m4.2-6-.7-.7-1.4 1.4.7.7zM5 13.7l-.7-.7 1.4-1.4.7.7zm7.7-.7-.7.7-1.4-1.4.7-.7zM4.3 6l.7-.7 1.4 1.4-.7.7zm3 17 14-14 .8.7L8 23.7zm17.2-.1a3.5 3.5 0 0 1-3.4-5.9H21a4 4 0 1 0 3.5 5.9"></path></symbol><use xlink:href="#ai:local:theme/system-28"></use>  </svg> <select value="auto" data-button="" data-astro-cid-lmznfliq=""> <option value="dark" data-astro-cid-lmznfliq="">&nbsp;&nbsp;Dark&nbsp;&nbsp;</option><option value="light" data-astro-cid-lmznfliq="">&nbsp;&nbsp;Light&nbsp;&nbsp;</option><option value="auto" selected="true" data-astro-cid-lmznfliq="">&nbsp;&nbsp;Auto&nbsp;&nbsp;</option> </select>  </label>  </docs-theme-select>   <script data-astro-exec="">
	ThemeProvider.updatePickers('unknown');
</script>  </nav> </header>        <div id="image-lightbox" class="not-content" hidden="" data-astro-cid-kws7taxh=""> <div class="button-wrapper" data-astro-cid-kws7taxh=""> <div class="not-content" style="" data-astro-cid-pkzv2hgs=""> <button id="lightbox-close-button" title="Close image preview" data-astro-cid-pkzv2hgs="" class="not-content stvb-base stvb-pointer stvb-black stvb-medium stvb-secondary stvb-icon stvb-force-no-border">  <svg width="24" height="24" viewBox="0 0 18 18" data-astro-cid-kws7taxh="" data-icon="theme/cross-18">  <symbol id="ai:local:theme/cross-18"><g fill="none"><g clip-path="url(#a)"><path fill="currentColor" fill-rule="evenodd" d="M5.53 4.47 4.47 5.53 7.94 9l-3.47 3.47 1.06 1.06L9 10.06l3.47 3.47 1.06-1.06L10.06 9l3.47-3.47-1.06-1.06L9 7.94z" clip-rule="evenodd"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h18v18H0z"></path></clipPath></defs></g></symbol><use xlink:href="#ai:local:theme/cross-18"></use>  </svg>  </button> </div>  </div> <img id="lightbox-image" src="" data-astro-cid-kws7taxh=""> </div>   <div id="page-container" data-astro-cid-xgirumru=""> <aside id="nav" class="" style="" data-astro-cid-sa57sq6l=""> <div class="sidebar-viewport slick-scroll" data-astro-cid-sa57sq6l=""> <div class="sidebar" data-astro-cid-sa57sq6l=""> <ul class="toc" aria-label="Docs sidebar" data-astro-cid-sa57sq6l=""> <li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/welcome" data-astro-cid-omxx3dey="">Welcome to Pine Script® v6</a></li><li class="item" data-astro-cid-omxx3dey=""><details data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey="">Pine Script® primer</div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <symbol id="ai:local:theme/right-caret"><path fill="currentColor" d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1 1 0 0 0 0-1.42"></path></symbol><use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/primer/first-steps" data-astro-cid-omxx3dey="">First steps</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/primer/first-indicator" data-astro-cid-omxx3dey="">First indicator</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/primer/next-steps" data-astro-cid-omxx3dey="">Next steps</a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><details data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey="">Language</div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/execution-model" data-astro-cid-omxx3dey="">Execution model</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/type-system" data-astro-cid-omxx3dey="">Type system</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/script-structure" data-astro-cid-omxx3dey="">Script structure</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/identifiers" data-astro-cid-omxx3dey="">Identifiers</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/variable-declarations" data-astro-cid-omxx3dey="">Variable declarations</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/operators" data-astro-cid-omxx3dey="">Operators</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/conditional-structures" data-astro-cid-omxx3dey="">Conditional structures</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/loops" data-astro-cid-omxx3dey="">Loops</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/built-ins" data-astro-cid-omxx3dey="">Built-ins</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/user-defined-functions" data-astro-cid-omxx3dey="">User-defined functions</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/objects" data-astro-cid-omxx3dey="">Objects</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/enums" data-astro-cid-omxx3dey="">Enums</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/methods" data-astro-cid-omxx3dey="">Methods</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/arrays" data-astro-cid-omxx3dey="">Arrays</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/matrices" data-astro-cid-omxx3dey="">Matrices</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/maps" data-astro-cid-omxx3dey="">Maps</a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><details data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey="">Visuals</div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/overview" data-astro-cid-omxx3dey="">Overview</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/backgrounds" data-astro-cid-omxx3dey="">Backgrounds</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/bar-coloring" data-astro-cid-omxx3dey="">Bar coloring</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/bar-plotting" data-astro-cid-omxx3dey="">Bar plotting</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/colors" data-astro-cid-omxx3dey="">Colors</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/fills" data-astro-cid-omxx3dey="">Fills</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/levels" data-astro-cid-omxx3dey="">Levels</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/lines-and-boxes" data-astro-cid-omxx3dey="">Lines and boxes</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/plots" data-astro-cid-omxx3dey="">Plots</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/tables" data-astro-cid-omxx3dey="">Tables</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/visuals/text-and-shapes" data-astro-cid-omxx3dey="">Text and shapes</a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><details data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey="">Concepts</div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/alerts" data-astro-cid-omxx3dey="">Alerts</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/bar-states" data-astro-cid-omxx3dey="">Bar states</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/chart-information" data-astro-cid-omxx3dey="">Chart information</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/inputs" data-astro-cid-omxx3dey="">Inputs</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/libraries" data-astro-cid-omxx3dey="">Libraries</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/non-standard-charts-data" data-astro-cid-omxx3dey="">Non-standard charts data</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/other-timeframes-and-data" data-astro-cid-omxx3dey="">Other timeframes and data</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/repainting" data-astro-cid-omxx3dey="">Repainting</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/sessions" data-astro-cid-omxx3dey="">Sessions</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/strategies" data-astro-cid-omxx3dey="">Strategies</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/strings" data-astro-cid-omxx3dey="">Strings</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/time" data-astro-cid-omxx3dey="">Time</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/timeframes" data-astro-cid-omxx3dey="">Timeframes</a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><details open="" data-is-parent="" data-is-on-path="" data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey="">Writing scripts</div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/writing/style-guide" data-astro-cid-omxx3dey="">Style guide</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/writing/debugging" data-astro-cid-omxx3dey="">Debugging</a></li><li class="item" data-current="" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/writing/profiling-and-optimization" data-astro-cid-omxx3dey="">Profiling and optimization</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/writing/publishing" data-astro-cid-omxx3dey="">Publishing scripts</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/writing/limitations" data-astro-cid-omxx3dey="">Limitations</a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><details data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey="">FAQ</div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/general" data-astro-cid-omxx3dey="">General</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/alerts" data-astro-cid-omxx3dey="">Alerts</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/data-structures" data-astro-cid-omxx3dey="">Data structures</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/functions" data-astro-cid-omxx3dey="">Functions</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/indicators" data-astro-cid-omxx3dey="">Indicators</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/other-data-and-timeframes" data-astro-cid-omxx3dey="">Other data and timeframes</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/programming" data-astro-cid-omxx3dey="">Programming</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/strategies" data-astro-cid-omxx3dey="">Strategies</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/strings-and-formatting" data-astro-cid-omxx3dey="">Strings and formatting</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/techniques" data-astro-cid-omxx3dey="">Techniques</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/times-dates-and-sessions" data-astro-cid-omxx3dey="">Times, dates, and sessions</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/variables-and-operators" data-astro-cid-omxx3dey="">Variables and operators</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq/visuals" data-astro-cid-omxx3dey="">Visuals</a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/error-messages" data-astro-cid-omxx3dey="">Error messages</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/release-notes" data-astro-cid-omxx3dey="">Release notes</a></li><li class="item" data-astro-cid-omxx3dey=""><details data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey="">Migration guides</div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/migration-guides/overview" data-astro-cid-omxx3dey="">Overview</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/migration-guides/to-pine-version-6" data-astro-cid-omxx3dey="">To Pine Script® version 6</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/migration-guides/to-pine-version-5" data-astro-cid-omxx3dey="">To Pine Script® version 5</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/migration-guides/to-pine-version-4" data-astro-cid-omxx3dey="">To Pine Script® version 4</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/migration-guides/to-pine-version-3" data-astro-cid-omxx3dey="">To Pine Script® version 3</a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/migration-guides/to-pine-version-2" data-astro-cid-omxx3dey="">To Pine Script® version 2</a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/where-can-i-get-more-information" data-astro-cid-omxx3dey="">Where can I get more information?</a></li> </ul> <div class="toc-bottom" data-astro-cid-sa57sq6l=""></div> </div> </div> </aside>  <main class="main-pane" data-page-type="md" data-astro-cid-xgirumru=""> <a id="top" data-astro-cid-xgirumru=""></a> <main class="content" data-toc-shown="" data-astro-cid-ju3wuhkz="">  <div class="content-width" data-astro-cid-xgirumru=""> <div class="breadcrumbs" data-pagefind-ignore="" data-astro-cid-wlavna2o=""> <a href="/pine-script-docs" aria-label="Return back to the documentation home page." data-astro-cid-wlavna2o=""> <span data-astro-cid-wlavna2o="">User Manual</span>  </a>  <span class="divider" data-astro-cid-wlavna2o="">/</span> <a href="/pine-script-docs/writing/style-guide" data-astro-cid-wlavna2o="">Writing scripts</a> <span class="divider" data-astro-cid-wlavna2o="">/</span> <span class="current-item" data-astro-cid-wlavna2o="">Profiling and optimization</span> </div>     </div> <div id="slot-container" data-astro-cid-xgirumru=""> <h1 id="profiling-and-optimization" class="md-heading"><a href="#profiling-and-optimization">Profiling and <span class="fancy-wrap">optimization<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h1>
<h2 id="introduction" class="md-heading"><a href="#introduction"> <span class="fancy-wrap">Introduction<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h2>
<p>Pine Script® is a cloud-based compiled language geared toward efficient
repeated script execution. When a user adds a Pine script to a chart, it
executes <em>numerous</em> times, once for each available bar or tick in the
data feeds it accesses, as explained in this manual’s
<a href="/pine-script-docs/language/execution-model/">Execution model</a>
page.</p>
<p>The Pine Script compiler automatically performs several internal
optimizations to accommodate scripts of various sizes and help them run
smoothly. However, such optimizations <em>do not</em> prevent performance
bottlenecks in script executions. As such, it’s up to programmers to
<a href="/pine-script-docs/writing/profiling-and-optimization/#pine-profiler">profile</a> a script’s runtime performance and identify ways to modify
critical code blocks and lines when they need to improve execution
times.</p>
<p>This page covers how to profile and monitor a script’s runtime and
executions with the
<a href="/pine-script-docs/writing/profiling-and-optimization/#pine-profiler">Pine Profiler</a> and explains some ways programmers can modify their code to
<a href="/pine-script-docs/writing/profiling-and-optimization/#optimization">optimize</a> runtime performance.</p>
<p>For a quick introduction, see the following video, where we profile an example script and optimize it step-by-step, examining several common script inefficiencies and explaining how to avoid them along the way:</p>
<lite-youtube videoid="dQ7sbzWL0Dk" style="background-image: url('https://i.ytimg.com/vi/dQ7sbzWL0Dk/hqdefault.jpg');" data-title=""> <a class="lty-playbtn" tabindex="0" role="button"> <span class="lyt-visually-hidden"></span> </a> <noscript><iframe width="560" height="315" title="Play" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="" src="https://www.youtube-nocookie.com/embed/dQ7sbzWL0Dk?autoplay=1&amp;playsinline=1"></iframe></noscript></lite-youtube>  
<h2 id="pine-profiler" class="md-heading"><a href="#pine-profiler">Pine <span class="fancy-wrap">Profiler<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h2>
<p>Before diving into
<a href="/pine-script-docs/writing/profiling-and-optimization/#optimization">optimization</a>, it’s prudent to evaluate a script’s runtime and pinpoint
<em>bottlenecks</em>, i.e., areas in the code that substantially impact overall
performance. With these insights, programmers can ensure they focus on
optimizing where it truly matters instead of spending time and effort on
low-impact code.</p>
<p>Enter the <em>Pine Profiler</em>, a powerful utility that analyzes the
executions of all significant code lines and blocks in a script and
displays helpful performance information next to the lines inside the
Pine Editor. By inspecting the Profiler’s results, programmers can gain
a clearer perspective on a script’s overall runtime, the distribution
of runtime across its significant code regions, and the critical
portions that may need extra attention and optimization.</p>
<h3 id="profiling-a-script" class="md-heading"><a href="#profiling-a-script">Profiling a <span class="fancy-wrap">script<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p>The Pine Profiler can analyze the runtime performance of any <em>editable</em> script coded in Pine Script v6. To profile a script, add it to the chart, open the source code in the Pine Editor, and turn on the “Profiler mode” switch in the dropdown accessible via the “More” option in the top-right corner:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Profiling-a-script-1.BMT4r11Q_18aofc.webp" alt="image" width="730" height="816" loading="lazy" decoding="async"></p>
<p>We will use the script below for our initial profiling example, which
calculates a custom <code dir="auto">oscillator</code> based on average distances from the
<a href="https://www.tradingview.com/pine-script-reference/v6/#var_close">close</a>
price to upper and lower percentiles
over <code dir="auto">lengthInput</code> bars. It includes a few different types of
<em>significant</em> code regions, which come with some differences in
<a href="/pine-script-docs/writing/profiling-and-optimization/#interpreting-profiled-results">interpretation</a> while profiling:</p>
<div class="pine-colorizer not-content colorized" data-id="g3"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Pine&nbsp;Profiler&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;of&nbsp;bars&nbsp;in&nbsp;the&nbsp;calculations.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">100</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Length"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">2</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;percentage&nbsp;for&nbsp;upper&nbsp;percentile&nbsp;calculation.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperPercentInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.float</span><span class="mtk13">(</span><span class="mtk12">75.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Upper&nbsp;percentile"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">50.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">100.0</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;percentage&nbsp;for&nbsp;lower&nbsp;percentile&nbsp;calculation.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerPercentInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.float</span><span class="mtk13">(</span><span class="mtk12">25.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Lower&nbsp;percentile"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">50.0</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Calculate&nbsp;percentiles&nbsp;using&nbsp;the&nbsp;linear&nbsp;interpol</span><span class="mtk9">ation&nbsp;method.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperPercentile</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentile_linear_interpolation</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperPercentInput</span><span class="mtk13">)</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerPercentile</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentile_linear_interpolation</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerPercentInput</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Declare&nbsp;arrays&nbsp;for&nbsp;upper&nbsp;and&nbsp;lower&nbsp;deviations&nbsp;f</span><span class="mtk9">rom&nbsp;the&nbsp;percentiles&nbsp;on&nbsp;the&nbsp;same&nbsp;line.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperDistances</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk33">lengthInput</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerDistances</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk33">lengthInput</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Queue&nbsp;distance&nbsp;values&nbsp;through&nbsp;the&nbsp;`upperDistanc</span><span class="mtk9">es`&nbsp;and&nbsp;`lowerDistances`&nbsp;arrays&nbsp;based&nbsp;on&nbsp;excessive</span><span class="mtk9">&nbsp;price&nbsp;deviations.</span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.abs</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">upperPercentile</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerPercentile</span><span class="mtk13">))</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">upperPercentile</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerPercentile</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">upperDistances</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperPercentile</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.shift</span><span class="mtk13">(</span><span class="mtk33">upperDistances</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">lowerDistances</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk33">lowerPercentile</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.shift</span><span class="mtk13">(</span><span class="mtk33">lowerDistances</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;average&nbsp;distance&nbsp;from&nbsp;the&nbsp;`upperDistances`&nbsp;ar</span><span class="mtk9">ray.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperAvg</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperDistances</span><span class="mtk1">.</span><span class="mtk15">avg</span><span class="mtk13">()</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;average&nbsp;distance&nbsp;from&nbsp;the&nbsp;`lowerDistances`&nbsp;ar</span><span class="mtk9">ray.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerAvg</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerDistances</span><span class="mtk1">.</span><span class="mtk15">avg</span><span class="mtk13">()</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;ratio&nbsp;of&nbsp;the&nbsp;difference&nbsp;between&nbsp;the&nbsp;`upperAvg</span><span class="mtk9">`&nbsp;and&nbsp;`lowerAvg`&nbsp;to&nbsp;their&nbsp;sum.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">oscillator</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">upperAvg</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerAvg</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">upperAvg</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerAvg</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;color&nbsp;of&nbsp;the&nbsp;plot.&nbsp;A&nbsp;green-based&nbsp;gradient&nbsp;if&nbsp;</span><span class="mtk9">`oscillator`&nbsp;is&nbsp;positive,&nbsp;a&nbsp;red-based&nbsp;gradient&nbsp;oth</span><span class="mtk9">erwise.</span></span><br><span><span class="mtk18 mtkb">color</span><span class="mtk1">&nbsp;</span><span class="mtk33">oscColor</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">oscillator</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">?</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">color.from_gradient</span><span class="mtk13">(</span><span class="mtk33">oscillator</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.gray</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.green</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">:</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">color.from_gradient</span><span class="mtk13">(</span><span class="mtk33">oscillator</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">-1.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.red</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.gray</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;`oscillator`&nbsp;with&nbsp;the&nbsp;`oscColor`.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">oscillator</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Oscillator"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">oscColor</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">style</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">plot.style_area</span><span class="mtk13">)</span></span><br></code></div>
<p>Once enabled, the Profiler collects information from all executions of
the script’s significant code lines and blocks, then displays bars and
approximate runtime percentages to the left of the code lines inside the
Pine Editor:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Profiling-a-script-2.Ud_wxirg_1toi2O.webp" alt="image" width="1342" height="670" loading="lazy" decoding="async"></p>
<p>Note that:</p>
<ul>
<li>The Profiler tracks every execution of a significant code
region, including the executions on <em>realtime ticks</em>. Its
information updates over time as new executions occur.</li>
<li>Profiler results <strong>do not</strong> appear for script declaration
statements, type declarations, other <em>insignificant</em> code lines
such as variable declarations with no tangible impact, <em>unused
code</em> that the script’s outputs do not depend on, or
<em>repetitive code</em> that the compiler optimizes during
translation. See
<a href="/pine-script-docs/writing/profiling-and-optimization/#insignificant-unused-and-redundant-code">this section</a> for more information.</li>
</ul>
<p>When a script contains at least <em>four</em> significant lines of code, the
Profiler will include “flame” icons next to the <em>top three</em> code
regions with the highest performance impact. If one or more of the
highest-impact code regions are <em>outside</em> the lines visible inside the
Pine Editor, a “flame” icon and a number indicating how many critical
lines are outside the view will appear at the top or bottom of the left
margin. Clicking the icon will vertically scroll the Editor’s window to
show the nearest critical line:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Profiling-a-script-3.CRdP8jVv_Z2lC0Am.webp" alt="image" width="1342" height="346" loading="lazy" decoding="async"></p>
<p>Hovering the mouse pointer over the space next to a line highlights the
analyzed code and exposes a tooltip with additional information,
including the time spent and the number of executions. The information
shown next to each line and in the corresponding tooltip depends on the
profiled code region. The
<a href="/pine-script-docs/writing/profiling-and-optimization/#interpreting-profiled-results">section below</a> explains different types of code the Profiler analyzes and
how to interpret their performance results.</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Profiling-a-script-4.B8hBGa6N_2sbc0.webp" alt="image" width="1342" height="588" loading="lazy" decoding="async"></p>
<aside aria-label="Note" class="tv-informer not-content" style="--informer-header-color:#6A6D78;--informer-back-color-light:#F0F3FA;--informer-back-color-dark:#2A2E39"><div class="tv-informer-icon"><svg viewBox="0 0 18 18" width="18" height="18"><path d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16ZM8 6a1 1 0 1 1 2 0 1 1 0 0 1-2 0Zm1 2c.49 0 1 .59 1 1v3.01c0 .42-.51.99-1 .99s-1-.57-1-.99V9c0-.41.51-1 1-1Z" fill="currentColor"></path></svg></div><div class="tv-informer-content"><p><span class="tv-informer-header">Note</span></p><p>Similar to profiling tools for other languages, the Pine Profiler <em>wraps</em> a script and its significant code with <a href="/pine-script-docs/writing/profiling-and-optimization/#a-look-into-the-profilers-inner-workings">extra calculations</a> to collect performance data. Therefore, a script’s resource usage <strong>increases</strong> while profiling, and the results are thus <strong>estimates</strong> rather than precise performance measurements.</p><br><p>Furthermore, the Profiler cannot collect and display individual performance data for the <em>internal calculations</em> that also affect runtime, including the calculations required to track performance, meaning the time values shown for all a script’s code regions <strong>do not</strong> add up to exactly 100% of its overall runtime.</p><p></p></div></aside>
<h3 id="interpreting-profiled-results" class="md-heading"><a href="#interpreting-profiled-results">Interpreting profiled <span class="fancy-wrap">results<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<h4 id="single-line-results" class="md-heading"><a href="#single-line-results">Single-line <span class="fancy-wrap">results<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h4>
<p>For a code line containing single-line expressions, the Profiler bar and
displayed percentage represent the relative portion of the script’s
total runtime spent on that line. The corresponding tooltip displays
three fields:</p>
<ul>
<li>The “Line number” field indicates the analyzed code line.</li>
<li>The “Time” field shows the runtime percentage for the line of
code, the runtime spent on that line, and the script’s total
runtime.</li>
<li>The “Executions” field shows the number of times that specific
line executed while running the script.</li>
</ul>
<p>Here, we hovered the pointer over the space next to line 12 of our
profiled code to view its tooltip:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Single-line-results-1.DxmafMJF_Z1xuVkr.webp" alt="image" width="1072" height="304" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="um"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperPercentile</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentile_linear_interpolation</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperPercentInput</span><span class="mtk13">)</span></span><br></code></div>
<p>Note that:</p>
<ul>
<li>The time information for the line represents the time spent
completing <em>all</em> executions, <strong>not</strong> the time spent on a single
execution.</li>
<li>To estimate the <em>average</em> time spent per execution, divide the
line’s time by the number of executions. In this case, the
tooltip shows that line 12 took about 14.1 milliseconds to
execute 20,685 times, meaning the average time per execution was
approximately 14.1 ms / 20685 = 0.0006816534 milliseconds
(0.6816534 microseconds).</li>
</ul>
<p>When a line of code consists of more than one expression separated by
commas, the number of executions shown in the tooltip represents the
<em>sum</em> of each expression’s total executions, and the time value
displayed represents the total time spent evaluating all the line’s
expressions.</p>
<p>For instance, this global line from our initial example includes two
<a href="/pine-script-docs/language/variable-declarations/">variable declarations</a> separated by commas. Each uses the
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_var">var</a>
keyword, meaning the script only executes them once on the first
available bar. As we see in the Profiler tooltip for the line, it
counted <em>two</em> executions (one for each expression), and the time value
shown is the <em>combined</em> result from both expressions on the line:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Single-line-results-2.CGsjIphG_1lBWSK.webp" alt="image" width="1072" height="304" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="1zs"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperDistances</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk33">lengthInput</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerDistances</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk33">lengthInput</span><span class="mtk13">)</span></span><br></code></div>
<p>Note that:</p>
<ul>
<li>When analyzing scripts with more than one expression on the same
line, we recommend moving each expression to a <em>separate line</em>
for more detailed insights while profiling, namely if they may
contain <em>higher-impact</em> calculations.</li>
</ul>
<p>When using
<a href="/pine-script-docs/writing/style-guide/#line-wrapping">line wrapping</a> for readability or stylistic purposes, the Profiler
considers all portions of a wrapped line as part of the <em>first line</em>
where it starts in the Pine Editor.</p>
<p>For example, although this code from our initial script occupies more
than one line in the Pine Editor, it’s still treated as a <em>single</em> line
of code, and the Profiler tooltip displays single-line results, with the
“Line number” field showing the <em>first</em> line in the Editor that the
wrapped line occupies:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Single-line-results-3.8u0gLHs0_yR0hQ.webp" alt="image" width="1072" height="304" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="67t"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18 mtkb">color</span><span class="mtk1">&nbsp;</span><span class="mtk33">oscColor</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">oscillator</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">?</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">color.from_gradient</span><span class="mtk13">(</span><span class="mtk33">oscillator</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.gray</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.green</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">:</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">color.from_gradient</span><span class="mtk13">(</span><span class="mtk33">oscillator</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">-1.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.red</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.gray</span><span class="mtk13">)</span></span><br></code></div>
<h4 id="code-block-results" class="md-heading"><a href="#code-block-results">Code block <span class="fancy-wrap">results<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h4>
<p>For a line at the start of a <a href="/pine-script-docs/language/loops/">loop</a> or
<a href="/pine-script-docs/language/conditional-structures/">conditional structure</a>, the Profiler bar and percentage represent the relative
portion of the script’s runtime spent on the <strong>entire code block</strong>, not
just the single line. The corresponding tooltip displays four fields:</p>
<ul>
<li>The “Code block range” field indicates the range of lines included
in the structure.</li>
<li>The “Time” field shows the code block’s runtime percentage, the
time spent on all block executions, and the script’s total runtime.</li>
<li>The “Line time” field shows the runtime percentage for the
block’s initial line, the time spent on that line, and the
script’s total runtime. The interpretation differs for
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_switch">switch</a>
blocks or
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_if">if</a>
blocks <em>with</em> <code dir="auto">else if</code>
statements, as the values represent the total time spent on <strong>all</strong>
the structure’s conditional statements. See below for more
information.</li>
<li>The “Executions” field shows the number of times the code block
executed while running the script.</li>
</ul>
<p>Here, we hovered over the space next to line 19 in our initial script,
the beginning of a simple
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_if">if</a>
structure <em>without</em> <code dir="auto">else if</code>
statements. As we see below, the tooltip shows performance information
for the entire code block and the current line:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Code-block-results-1.Cp7Cs5Lf_Z1aX7Bw.webp" alt="image" width="1072" height="304" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="3tv"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.abs</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">upperPercentile</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerPercentile</span><span class="mtk13">))</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">upperPercentile</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerPercentile</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">upperDistances</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperPercentile</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.shift</span><span class="mtk13">(</span><span class="mtk33">upperDistances</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">lowerDistances</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk33">lowerPercentile</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.shift</span><span class="mtk13">(</span><span class="mtk33">lowerDistances</span><span class="mtk13">)</span></span><br></code></div>
<p>Note that:</p>
<ul>
<li>The “Time” field shows that the total time spent evaluating
the structure 20,685 times was 7.2 milliseconds.</li>
<li>The “Line time” field indicates that the runtime spent on the
<em>first line</em> of this
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_if">if</a>
structure was about three milliseconds.</li>
</ul>
<p>Users can also inspect the results from lines and nested blocks within a
code block’s range to gain more granular performance insights. Here, we
hovered over the space next to line 20 within the code block to view its
<a href="/pine-script-docs/writing/profiling-and-optimization/#single-line-results">single-line result</a>:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Code-block-results-2.Cy1_m4AY_ZsCh1h.webp" alt="image" width="1072" height="304" loading="lazy" decoding="async"></p>
<p>Note that:</p>
<ul>
<li>The number of executions shown is <em>less than</em> the result for the
entire code block, as the condition that controls the execution
of this line does not return <code dir="auto">true</code> all the time. The opposite
applies to the code inside <a href="/pine-script-docs/language/loops/">loops</a> since each execution of a loop statement can trigger
<strong>several</strong> executions of the loop’s local block.</li>
</ul>
<p>When profiling a
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_switch">switch</a>
structure or an
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_if">if</a>
structure that includes <code dir="auto">else if</code>
statements, the “Line time” field will show the time spent executing
<strong>all</strong> the structure’s conditional expressions, <strong>not</strong> just the
block’s first line. The results for the lines inside the code block
range will show runtime and executions for each <strong>local block</strong>. This
format is necessary for these structures due to the Profiler’s
calculation and display constraints. See
<a href="/pine-script-docs/writing/profiling-and-optimization/#a-look-into-the-profilers-inner-workings">this section</a> for more information.</p>
<p>For example, the “Line time” for the
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_switch">switch</a>
structure in this script represents the time spent evaluating <em>all four</em>
conditional statements within its body, as the Profiler <em>cannot</em> track
them separately. The results for each line in the code block’s range
represent the performance information for each <em>local block</em>:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Code-block-results-3.D12wyQyn_ZXHSFp.webp" alt="image" width="1072" height="304" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="7if"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"`switch`&nbsp;and&nbsp;`if...else&nbsp;if`&nbsp;results&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;upper&nbsp;band&nbsp;for&nbsp;oscillator&nbsp;calculation.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;lower&nbsp;band&nbsp;for&nbsp;oscillator&nbsp;calculation.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Update&nbsp;the&nbsp;`upperBand`&nbsp;and&nbsp;`lowerBand`&nbsp;based&nbsp;on</span><span class="mtk9">&nbsp;the&nbsp;proximity&nbsp;of&nbsp;the&nbsp;`close`&nbsp;to&nbsp;the&nbsp;current&nbsp;band&nbsp;</span><span class="mtk9">values.</span></span><br><span><span class="mtk9">//&nbsp;The&nbsp;"Line&nbsp;time"&nbsp;field&nbsp;on&nbsp;line&nbsp;11&nbsp;represents&nbsp;the</span><span class="mtk9">&nbsp;time&nbsp;spent&nbsp;on&nbsp;all&nbsp;4&nbsp;conditional&nbsp;expressions&nbsp;in&nbsp;th</span><span class="mtk9">e&nbsp;structure.</span></span><br><span><span class="mtk18">switch</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.9</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.1</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.9</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.1</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;ratio&nbsp;of&nbsp;the&nbsp;difference&nbsp;between&nbsp;`close`&nbsp;and&nbsp;`</span><span class="mtk9">lowerBand`&nbsp;to&nbsp;the&nbsp;band&nbsp;range.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">oscillator</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">100.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;`oscillator`&nbsp;as&nbsp;columns&nbsp;with&nbsp;a&nbsp;dynamic</span><span class="mtk9">&nbsp;color.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">oscillator</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Oscillator"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">oscillator</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">50.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">?</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.teal</span><span class="mtk1">&nbsp;</span><span class="mtk18">:</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.maroon</span><span class="mtk18">,</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">style</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">plot.style_columns</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">histbase</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">50.0</span></span><br><span><span class="mtk1">&nbsp;</span><span class="mtk13">)</span></span><br></code></div>
<p>When the conditional logic in such structures involves significant
calculations, programmers may require more granular performance
information for each calculated condition. An effective way to achieve
this analysis is to use <em>nested</em>
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_if">if</a> blocks
instead of the more compact
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_switch">switch</a>
or <code dir="auto">if...else if</code>
structures. For example, instead of:</p>
<div class="pine-colorizer not-content colorized" data-id="5ae"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18">switch</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">expression1</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">localBlock1</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">expression2</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">localBlock2</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">localBlock3</span><span class="mtk18">&gt;</span></span><br></code></div>
<p>or:</p>
<div class="pine-colorizer not-content colorized" data-id="4p7"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">expression1</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">localBlock1</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk18">else</span><span class="mtk1">&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">expression2</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">localBlock2</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk18">else</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">localBlock3</span><span class="mtk18">&gt;</span></span><br></code></div>
<p>one can use nested
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_if">if</a> blocks
for more in-depth profiling while maintaining the same logical flow:</p>
<div class="pine-colorizer not-content colorized" data-id="5hn"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">expression1</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">localBlock1</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk18">else</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">expression2</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">localBlock2</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">else</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">localBlock3</span><span class="mtk18">&gt;</span></span><br></code></div>
<p>Below, we changed the previous
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_switch">switch</a>
example to an equivalent nested
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_if">if</a>
structure. Now, we can view the runtime and executions for each
significant part of the conditional pattern individually:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Code-block-results-4.OxkZ6XRw_Zs1azS.webp" alt="image" width="1072" height="338" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="31c"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"`switch`&nbsp;and&nbsp;`if...else&nbsp;if`&nbsp;results&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;upper&nbsp;band&nbsp;for&nbsp;oscillator&nbsp;calculation.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;lower&nbsp;band&nbsp;for&nbsp;oscillator&nbsp;calculation.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Update&nbsp;the&nbsp;`upperBand`&nbsp;and&nbsp;`lowerBand`&nbsp;based&nbsp;on</span><span class="mtk9">&nbsp;the&nbsp;proximity&nbsp;of&nbsp;the&nbsp;`close`&nbsp;to&nbsp;the&nbsp;current&nbsp;band&nbsp;</span><span class="mtk9">values.</span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span class="mtk18">else</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">else</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.9</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.1</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">else</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.9</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.1</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;ratio&nbsp;of&nbsp;the&nbsp;difference&nbsp;between&nbsp;`close`&nbsp;and&nbsp;`</span><span class="mtk9">lowerBand`&nbsp;to&nbsp;the&nbsp;band&nbsp;range.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">oscillator</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">100.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;`oscillator`&nbsp;as&nbsp;columns&nbsp;with&nbsp;a&nbsp;dynamic</span><span class="mtk9">&nbsp;color.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">oscillator</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Oscillator"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">oscillator</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">50.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">?</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.teal</span><span class="mtk1">&nbsp;</span><span class="mtk18">:</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.maroon</span><span class="mtk18">,</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">style</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">plot.style_columns</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">histbase</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">50.0</span></span><br><span><span class="mtk1">&nbsp;</span><span class="mtk13">)</span></span><br></code></div>
<p>Note that:</p>
<ul>
<li>This same process can also apply to <a href="/pine-script-docs/language/operators/#-ternary-operator">ternary operations</a>.
When a complex ternary expression’s operands contain
significant calculations, reorganizing the logic into a nested
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_if">if</a>
structure allows more detailed Profiler results, making it
easier to spot critical parts.</li>
</ul>
<h4 id="user-defined-function-calls" class="md-heading"><a href="#user-defined-function-calls">User-defined function <span class="fancy-wrap">calls<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h4>
<p><a href="/pine-script-docs/language/user-defined-functions/">User-defined functions</a> and
<a href="/pine-script-docs/language/methods/#user-defined-methods">methods</a>
are functions written by users. They encapsulate code sequences that a
script may execute several times. Users often write functions and
methods for improved code modularity, reusability, and maintainability.</p>
<p>The indented lines of code within a function represent its <em>local
scope</em>, i.e., the sequence that executes <em>each time</em> the script calls
it. Unlike code in a script’s global scope, which a script evaluates
once on each execution, the code inside a function may activate zero,
one, or <em>multiple times</em> on each script execution, depending on the
conditions that trigger the calls, the number of calls that occur, and
the function’s logic.</p>
<p>This distinction is crucial to consider while interpreting Profiler
results. When a profiled code contains
<a href="/pine-script-docs/language/user-defined-functions/">user-defined function</a> or
<a href="/pine-script-docs/language/methods/#user-defined-methods">method</a>
calls:</p>
<ul>
<li>The results for each <em>function call</em> reflect the runtime allocated
toward it and the total number of times the script activated that
specific call.</li>
<li>The time and execution information for all local code <em>inside</em> a
function’s scope reflects the combined results from <strong>all</strong> calls
to the function.</li>
</ul>
<p>This example contains a user-defined <code dir="auto">similarity()</code> function that
estimates the similarity of two series, which the script calls only
<em>once</em> from the global scope on each execution. In this case, the
Profiler’s results for the code inside the function’s body correspond
to that specific call:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-User-defined-function-calls-1.DUf4uWCa_1zRHzX.webp" alt="image" width="1072" height="328" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="6k7"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"User-defined&nbsp;function&nbsp;calls&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Estimates&nbsp;the&nbsp;similarity&nbsp;between&nbsp;two&nbsp;standardized</span><span class="mtk9">&nbsp;series&nbsp;over&nbsp;`length`&nbsp;bars.</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Each&nbsp;individual&nbsp;call&nbsp;to&nbsp;this&nbsp;function&nbsp;</span><span class="mtk9">activates&nbsp;its&nbsp;local&nbsp;scope.</span></span><br><span><span class="mtk15">similarity</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">sourceA</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">sourceB</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Standardize&nbsp;`sourceA`&nbsp;and&nbsp;`sourceB`&nbsp;for&nbsp;compari</span><span class="mtk9">son.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">normA</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">sourceA</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk33">sourceA</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">))</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.stdev</span><span class="mtk13">(</span><span class="mtk33">sourceA</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">normB</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">sourceB</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk33">sourceB</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">))</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.stdev</span><span class="mtk13">(</span><span class="mtk33">sourceB</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Calculate&nbsp;and&nbsp;return&nbsp;the&nbsp;estimated&nbsp;similarity&nbsp;o</span><span class="mtk9">f&nbsp;`normA`&nbsp;and&nbsp;`normB`.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">abSum</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sum</span><span class="mtk13">(</span><span class="mtk33">normA</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">normB</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">a2Sum</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sum</span><span class="mtk13">(</span><span class="mtk33">normA</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">normA</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">b2Sum</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sum</span><span class="mtk13">(</span><span class="mtk33">normB</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">normB</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">abSum</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sqrt</span><span class="mtk13">(</span><span class="mtk33">a2Sum</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">b2Sum</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;similarity&nbsp;between&nbsp;the&nbsp;`close`&nbsp;and&nbsp;an&nbsp;</span><span class="mtk9">offset&nbsp;`close`&nbsp;series.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">similarity</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk12">1</span><span class="mtk13">]</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Similarity&nbsp;1"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.red</span><span class="mtk13">)</span></span><br></code></div>
<p>Let’s increase the number of times the script calls the function each
time it executes. Here, we changed the script to call our
<a href="/pine-script-docs/language/user-defined-functions/">user-defined function</a> <em>five times</em>:</p>
<div class="pine-colorizer not-content colorized" data-id="yl"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"User-defined&nbsp;function&nbsp;calls&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Estimates&nbsp;the&nbsp;similarity&nbsp;between&nbsp;two&nbsp;standardized</span><span class="mtk9">&nbsp;series&nbsp;over&nbsp;`length`&nbsp;bars.</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Each&nbsp;individual&nbsp;call&nbsp;to&nbsp;this&nbsp;function&nbsp;</span><span class="mtk9">activates&nbsp;its&nbsp;local&nbsp;scope.</span></span><br><span><span class="mtk15">similarity</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">sourceA</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">sourceB</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Standardize&nbsp;`sourceA`&nbsp;and&nbsp;`sourceB`&nbsp;for&nbsp;compari</span><span class="mtk9">son.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">normA</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">sourceA</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk33">sourceA</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">))</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.stdev</span><span class="mtk13">(</span><span class="mtk33">sourceA</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">normB</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">sourceB</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk33">sourceB</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">))</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.stdev</span><span class="mtk13">(</span><span class="mtk33">sourceB</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Calculate&nbsp;and&nbsp;return&nbsp;the&nbsp;estimated&nbsp;similarity&nbsp;o</span><span class="mtk9">f&nbsp;`normA`&nbsp;and&nbsp;`normB`.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">abSum</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sum</span><span class="mtk13">(</span><span class="mtk33">normA</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">normB</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">a2Sum</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sum</span><span class="mtk13">(</span><span class="mtk33">normA</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">normA</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">b2Sum</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sum</span><span class="mtk13">(</span><span class="mtk33">normB</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">normB</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">abSum</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sqrt</span><span class="mtk13">(</span><span class="mtk33">a2Sum</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">b2Sum</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;similarity&nbsp;between&nbsp;the&nbsp;`close`&nbsp;and&nbsp;sev</span><span class="mtk9">eral&nbsp;offset&nbsp;`close`&nbsp;series.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">similarity</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk12">1</span><span class="mtk13">]</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Similarity&nbsp;1"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.red</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">similarity</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk12">2</span><span class="mtk13">]</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Similarity&nbsp;2"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.orange</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">similarity</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk12">4</span><span class="mtk13">]</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Similarity&nbsp;3"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.green</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">similarity</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk12">8</span><span class="mtk13">]</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Similarity&nbsp;4"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.blue</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">similarity</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk12">16</span><span class="mtk13">]</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Similarity&nbsp;5"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.purple</span><span class="mtk13">)</span></span><br></code></div>
<p>In this case, the local code results no longer correspond to a <em>single</em>
evaluation per script execution. Instead, they represent the <em>combined</em>
runtime and executions of the local code from <strong>all five</strong> calls. As we
see below, the results after running this version of the script across
the same data show 137,905 executions of the local code, <em>five times</em>
the number from when the script only contained one <code dir="auto">similarity()</code>
function call:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-User-defined-function-calls-2.BJPTeot1_Z1mNfz1.webp" alt="image" width="1072" height="386" loading="lazy" decoding="async"></p>
<aside aria-label="Note" class="tv-informer not-content" style="--informer-header-color:#6A6D78;--informer-back-color-light:#F0F3FA;--informer-back-color-dark:#2A2E39"><div class="tv-informer-icon"><svg viewBox="0 0 18 18" width="18" height="18"><path d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16ZM8 6a1 1 0 1 1 2 0 1 1 0 0 1-2 0Zm1 2c.49 0 1 .59 1 1v3.01c0 .42-.51.99-1 .99s-1-.57-1-.99V9c0-.41.51-1 1-1Z" fill="currentColor"></path></svg></div><div class="tv-informer-content"><p><span class="tv-informer-header">Note</span>If the local scopes of a script’s <a href="/pine-script-docs/language/user-defined-functions/">user-defined functions</a> or <a href="/pine-script-docs/language/methods/#user-defined-methods">methods</a> contain calls to <code dir="auto">request.*()</code> functions, the <em>translated form</em> of the script extracts such calls <strong>outside</strong> the functions’ scopes to evaluate them <strong>separately</strong>. Consequently, the Profiler’s results for lines with calls to those user-defined functions <strong>do not</strong> include the time spent on the <code dir="auto">request.*()</code> calls. See the <a href="/pine-script-docs/writing/profiling-and-optimization/#when-requesting-other-contexts">section below</a> to learn more.</p></div></aside>
<h4 id="when-requesting-other-contexts" class="md-heading"><a href="#when-requesting-other-contexts">When requesting other <span class="fancy-wrap">contexts<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h4>
<p>Pine scripts can request data from other <em>contexts</em>, i.e., different
symbols, timeframes, or data modifications than what the chart’s data
uses by calling the <code dir="auto">request.*()</code> family of functions or specifying an
alternate <code dir="auto">timeframe</code> in the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_indicator">indicator()</a>
declaration statement.</p>
<p>When a script requests data from another context, it evaluates all
required scopes and calculations within that context, as explained in
the
<a href="/pine-script-docs/concepts/other-timeframes-and-data/">Other timeframes and data</a> page. This behavior can affect the runtime of a script’s
code regions and the number of times they execute.</p>
<p>The Profiler information for any code
<a href="/pine-script-docs/writing/profiling-and-optimization/#single-line-results">line</a> or
<a href="/pine-script-docs/writing/profiling-and-optimization/#code-block-results">block</a> represents the results from executing the code in <em>all
necessary contexts</em>, which may or may not include the chart’s data.
Pine Script determines which contexts to execute code within based on
the calculations required by a script’s data requests and outputs.</p>
<p>Let’s look at a simple example. This initial script only uses the
chart’s data for its calculations. It declares a <code dir="auto">pricesArray</code> variable
with the
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_varip">varip</a>
keyword, meaning the
<a href="https://www.tradingview.com/pine-script-reference/v6/#type_array">array</a>
assigned to it persists across the data’s history and all available
realtime ticks. On each execution, the script calls
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_array.push">array.push()</a>
to push a new
<a href="https://www.tradingview.com/pine-script-reference/v6/#var_close">close</a>
value into the
<a href="https://www.tradingview.com/pine-script-reference/v6/#type_array">array</a>,
and it <a href="/pine-script-docs/visuals/plots/">plots</a> the array’s size.</p>
<p>After profiling the script across all the bars on an intraday chart, we
see that the number of elements in the <code dir="auto">pricesArray</code> corresponds to the
number of executions the Profiler shows for the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_array.push">array.push()</a>
call on line 8:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-When-requesting-other-contexts-1.4ixtln-7_gTemj.webp" alt="image" width="1250" height="384" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="2q9"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"When&nbsp;requesting&nbsp;other&nbsp;contexts&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;containing&nbsp;the&nbsp;`close`&nbsp;value&nbsp;from&nbsp;every&nbsp;</span><span class="mtk9">available&nbsp;price&nbsp;update.</span></span><br><span><span class="mtk18">varip</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">pricesArray</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;()</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Push&nbsp;a&nbsp;new&nbsp;`close`&nbsp;value&nbsp;into&nbsp;the&nbsp;`pricesArray`</span><span class="mtk9">&nbsp;on&nbsp;each&nbsp;update.</span></span><br><span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">pricesArray</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;`pricesArray`.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">array.size</span><span class="mtk13">(</span><span class="mtk33">pricesArray</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Total&nbsp;number&nbsp;of&nbsp;chart&nbsp;price&nbsp;updates"</span><span class="mtk13">)</span></span><br></code></div>
<p>Now, let’s try evaluating the size of the <code dir="auto">pricesArray</code> from <em>another
context</em> instead of using the chart’s data. Below, we’ve added a
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_request.security">request.security()</a>
call with
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_array.size">array.size(pricesArray)</a>
as its <code dir="auto">expression</code> argument to retrieve the value calculated on the
“1D” timeframe and plotted that result instead.</p>
<p>In this case, the number of executions the Profiler shows on line 8
still corresponds to the number of elements in the <code dir="auto">pricesArray</code>.
However, it did not execute the same number of times since the script
did not require the <em>chart’s data</em> in the calculations. It only needed
to initialize the
<a href="https://www.tradingview.com/pine-script-reference/v6/#type_array">array</a>
and evaluate
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_array.push">array.push()</a>
across all the requested <em>daily data</em>, which has a different number of
price updates than our current intraday chart:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-When-requesting-other-contexts-2.COS2z1lh_s4Tg3.webp" alt="image" width="1250" height="384" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="7iq"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"When&nbsp;requesting&nbsp;other&nbsp;contexts&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;containing&nbsp;the&nbsp;`close`&nbsp;value&nbsp;from&nbsp;every&nbsp;</span><span class="mtk9">available&nbsp;price&nbsp;update.</span></span><br><span><span class="mtk18">varip</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">pricesArray</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;()</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Push&nbsp;a&nbsp;new&nbsp;`close`&nbsp;value&nbsp;into&nbsp;the&nbsp;`pricesArray`</span><span class="mtk9">&nbsp;on&nbsp;each&nbsp;update.</span></span><br><span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">pricesArray</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;`pricesArray`&nbsp;requested&nbsp;fr</span><span class="mtk9">om&nbsp;the&nbsp;daily&nbsp;timeframe.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk11">syminfo.tickerid</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"1D"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.size</span><span class="mtk13">(</span><span class="mtk33">pricesArray</span><span class="mtk13">))</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Total&nbsp;number&nbsp;of&nbsp;daily&nbsp;price&nbsp;updates"</span><span class="mtk13">)</span></span><br></code></div>
<p>Note that:</p>
<ul>
<li>The requested EOD data in this example had fewer data points
than our intraday chart, so the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_array.push">array.push()</a>
call required fewer executions in this case. However, EOD feeds
<em>do not</em> have history limitations, meaning it’s also possible
for requested HTF data to span <strong>more</strong> bars than a user’s
chart, depending on the timeframe, the data provider, and the
user’s <a href="https://www.tradingview.com/pricing/">plan</a>.</li>
</ul>
<p>If this script were to plot the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_array.size">array.size()</a>
value directly in addition to the requested daily value, it would then
require the creation of <em>two</em> <a href="/pine-script-docs/language/arrays/">arrays</a> (one for each context) and the execution of
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_array.push">array.push()</a>
across both the chart’s data <em>and</em> the data from the daily timeframe.
As such, the declaration on line 5 will execute <em>twice</em>, and the results
on line 8 will reflect the time and executions accumulated from
evaluating the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_array.push">array.push()</a>
call across <strong>both separate datasets</strong>:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-When-requesting-other-contexts-3.CPXHEchh_1SVGGO.webp" alt="image" width="1250" height="384" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="3d1"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"When&nbsp;requesting&nbsp;other&nbsp;contexts&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;containing&nbsp;the&nbsp;`close`&nbsp;value&nbsp;from&nbsp;every&nbsp;</span><span class="mtk9">available&nbsp;price&nbsp;update.</span></span><br><span><span class="mtk18">varip</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">pricesArray</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;()</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Push&nbsp;a&nbsp;new&nbsp;`close`&nbsp;value&nbsp;into&nbsp;the&nbsp;`pricesArray`</span><span class="mtk9">&nbsp;on&nbsp;each&nbsp;update.</span></span><br><span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">pricesArray</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;`pricesArray`&nbsp;from&nbsp;the&nbsp;dai</span><span class="mtk9">ly&nbsp;timeframe&nbsp;and&nbsp;the&nbsp;chart's&nbsp;context.</span></span><br><span><span class="mtk9">//&nbsp;Including&nbsp;both&nbsp;in&nbsp;the&nbsp;outputs&nbsp;requires&nbsp;executin</span><span class="mtk9">g&nbsp;line&nbsp;5&nbsp;and&nbsp;line&nbsp;8&nbsp;across&nbsp;BOTH&nbsp;datasets.&nbsp;&nbsp;</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk11">syminfo.tickerid</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"1D"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.size</span><span class="mtk13">(</span><span class="mtk33">pricesArray</span><span class="mtk13">))</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Total&nbsp;number&nbsp;of&nbsp;daily&nbsp;price&nbsp;updates"</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">array.size</span><span class="mtk13">(</span><span class="mtk33">pricesArray</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Total&nbsp;number&nbsp;of&nbsp;chart&nbsp;price&nbsp;updates"</span><span class="mtk13">)</span></span><br></code></div>
<p>It’s important to note that when a script calls a
<a href="/pine-script-docs/language/user-defined-functions/">user-defined function</a> or
<a href="/pine-script-docs/language/methods/#user-defined-methods">method</a>
that contains <code dir="auto">request.*()</code> calls in its local scope, the script’s
<em>translated form</em> extracts the <code dir="auto">request.*()</code> calls <strong>outside</strong> the scope
and encapsulates the expressions they depend on within <strong>separate
functions</strong>. When the script executes, it evaluates the required
<code dir="auto">request.*()</code> calls first, then <em>passes</em> the requested data to a
<em>modified form</em> of the
<a href="/pine-script-docs/language/user-defined-functions/">user-defined function</a>.</p>
<p>Since the translated script executes a
<a href="/pine-script-docs/language/user-defined-functions/">user-defined function’s</a> data requests separately <strong>before</strong> evaluating non-requested
calculations in its local scope, the Profiler’s results for lines
containing calls to the function <strong>will not</strong> include the time spent on
its <code dir="auto">request.*()</code> calls or their required expressions.</p>
<p>As an example, the following script contains a user-defined
<code dir="auto">getCompositeAvg()</code> function with a
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_request.security">request.security()</a>
call that requests the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_math.avg">math.avg()</a>
of 10
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_ta.wma">ta.wma()</a>
calls with different <code dir="auto">length</code> arguments from a specified <code dir="auto">symbol</code>. The
script uses the function to request the average result using a <a href="/pine-script-docs/concepts/non-standard-charts-data/#tickerheikinashi">Heikin Ashi</a>
ticker ID:</p>
<div class="pine-colorizer not-content colorized" data-id="53l"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"User-defined&nbsp;functions&nbsp;with&nbsp;`request.*()`&nbsp;calls&nbsp;d</span><span class="mtk29">emo"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">overlay</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">multInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">10</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Length&nbsp;multiplier"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">string</span><span class="mtk1">&nbsp;</span><span class="mtk33">tickerID</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ticker.heikinashi</span><span class="mtk13">(</span><span class="mtk11">syminfo.tickerid</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk15">getCompositeAvg</span><span class="mtk13">(</span><span class="mtk18 mtkb">string</span><span class="mtk1">&nbsp;</span><span class="mtk33">symbol</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">symbol</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.avg</span><span class="mtk13">(</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">2</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">3</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">4</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">5</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">6</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">7</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">8</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">9</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">10</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">getCompositeAvg</span><span class="mtk13">(</span><span class="mtk33">tickerID</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">multInput</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Composite&nbsp;average"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">linewidth</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">3</span><span class="mtk13">)</span></span><br></code></div>
<p>After profiling the script, users might be surprised to see that the
runtime results shown inside the function’s body heavily <strong>exceed</strong> the
results shown for the <em>single</em> <code dir="auto">getCompositeAvg()</code> call:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-When-requesting-other-contexts-4.CkN5cmYP_xCyjm.webp" alt="image" width="1072" height="342" loading="lazy" decoding="async"></p>
<p>The results appear this way since the translated script includes
internal modifications that <em>moved</em> the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_request.security">request.security()</a>
call and its expression <strong>outside</strong> the function’s scope, and the
Profiler has no way to represent the results from those calculations
other than displaying them next to the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_request.security">request.security()</a>
line in this scenario. The code below roughly illustrates how the
translated script looks:</p>
<div class="pine-colorizer not-content colorized" data-id="637"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"User-defined&nbsp;functions&nbsp;with&nbsp;`request.*()`&nbsp;calls&nbsp;d</span><span class="mtk29">emo"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">overlay</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">multInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">10</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Length&nbsp;multiplier"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">string</span><span class="mtk1">&nbsp;</span><span class="mtk33">tickerID</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ticker.heikinashi</span><span class="mtk13">(</span><span class="mtk11">syminfo.tickerid</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk15">secExpr</span><span class="mtk13">(</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">math.avg</span><span class="mtk13">(</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">2</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">3</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">4</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">5</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">6</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">7</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">8</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">9</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">10</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">sec</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk33">tickerID</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">secExpr</span><span class="mtk13">(</span><span class="mtk33">multInput</span><span class="mtk13">))</span></span><br><span><span></span></span><br><span><span class="mtk15">getCompositeAvg</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">s</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">s</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">getCompositeAvg</span><span class="mtk13">(</span><span class="mtk33">sec</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Composite&nbsp;average"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">linewidth</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">3</span><span class="mtk13">)</span></span><br></code></div>
<p>Note that:</p>
<ul>
<li>The <code dir="auto">secExpr()</code> code represents the <em>separate function</em> used by
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_request.security">request.security()</a>
to calculate the required expression in the requested context.</li>
<li>The
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_request.security">request.security()</a>
call takes place in the <strong>outer scope</strong>, outside the
<code dir="auto">getCompositeAvg()</code> function.</li>
<li>The translation substantially reduced the local code of
<code dir="auto">getCompositeAvg()</code>. It now solely returns a value passed into
it, as all the function’s required calculations take place
<strong>outside</strong> its scope. Due to this reduction, the function
call’s performance results <strong>will not</strong> reflect any of the time
spent on the data request’s required calculations.</li>
</ul>
<h4 id="insignificant-unused-and-redundant-code" class="md-heading"><a href="#insignificant-unused-and-redundant-code">Insignificant, unused, and redundant <span class="fancy-wrap">code<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h4>
<p>When inspecting a profiled script’s results, it’s crucial to
understand that <em>not all</em> code in a script necessarily impacts runtime
performance. Some code has no direct performance impact, such as a
script’s declaration statement and
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_type">type</a>
declarations. Other code regions with insignificant expressions, such as
most <code dir="auto">input.*()</code> calls, variable references, or
<a href="/pine-script-docs/language/variable-declarations/">variable declarations</a> without significant calculations, have little to <em>no effect</em>
on a script’s runtime. Therefore, the Profiler will <strong>not</strong> display
performance results for these types of code.</p>
<p>Additionally, Pine scripts do not execute code regions that their
<em>outputs</em> (<a href="/pine-script-docs/visuals/plots/">plots</a>,
<a href="/pine-script-docs/language/type-system/#drawing-types">drawings</a>,
<a href="/pine-script-docs/writing/debugging/#pine-logs">logs</a>, etc.) do
not depend on, as the compiler automatically <strong>removes</strong> them during
translation. Since unused code regions have <em>zero</em> impact on a script’s
performance, the Profiler will <strong>not</strong> display any results for them.</p>
<p>The following example contains a <code dir="auto">barsInRange</code> variable and a
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_for">for</a> loop
that adds 1 to the variable’s value for each historical
<a href="https://www.tradingview.com/pine-script-reference/v6/#var_close">close</a>
price between the current
<a href="https://www.tradingview.com/pine-script-reference/v6/#var_high">high</a>
and <a href="https://www.tradingview.com/pine-script-reference/v6/#var_low">low</a>
over <code dir="auto">lengthInput</code> bars. However, the script <strong>does not use</strong> these
calculations in its outputs, as it only
<a href="/pine-script-docs/visuals/plots/">plots</a> the
<a href="https://www.tradingview.com/pine-script-reference/v6/#var_close">close</a>
price. Consequently, the script’s compiled form <strong>discards</strong> that
unused code and only considers the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_plot">plot(close)</a>
call.</p>
<p>The Profiler does not display <strong>any</strong> results for this script since it
does not execute any <strong>significant</strong> calculations:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Insignificant-unused-and-redundant-code-1.CVzX40Kz_HGwJR.webp" alt="image" width="1072" height="350" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="9c"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Unused&nbsp;code&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;of&nbsp;historical&nbsp;bars&nbsp;in&nbsp;the&nbsp;calculation.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">100</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Length"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;of&nbsp;closes&nbsp;over&nbsp;`lengthInput`&nbsp;bars&nbsp;betw</span><span class="mtk9">een&nbsp;the&nbsp;current&nbsp;bar's&nbsp;`high`&nbsp;and&nbsp;`low`.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">barsInRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span></span><br><span><span></span></span><br><span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;`close`&nbsp;price&nbsp;from&nbsp;`i`&nbsp;bars&nbsp;ago.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">pastClose</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">]</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Add&nbsp;1&nbsp;to&nbsp;`barsInRange`&nbsp;if&nbsp;the&nbsp;`pastClose`&nbsp;is&nbsp;be</span><span class="mtk9">tween&nbsp;the&nbsp;current&nbsp;bar's&nbsp;`high`&nbsp;and&nbsp;`low`.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">pastClose</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk11">low</span><span class="mtk1">&nbsp;</span><span class="mtk18">and</span><span class="mtk1">&nbsp;</span><span class="mtk33">pastClose</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk11">high</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">barsInRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;`close`&nbsp;price.&nbsp;This&nbsp;is&nbsp;the&nbsp;only&nbsp;output</span><span class="mtk9">.&nbsp;</span></span><br><span><span class="mtk9">//&nbsp;Since&nbsp;the&nbsp;outputs&nbsp;do&nbsp;not&nbsp;require&nbsp;any&nbsp;of&nbsp;the&nbsp;abo</span><span class="mtk9">ve&nbsp;calculations,&nbsp;the&nbsp;compiled&nbsp;script&nbsp;will&nbsp;not&nbsp;exec</span><span class="mtk9">ute&nbsp;them.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br></code></div>
<p>Note that:</p>
<ul>
<li>Although this script does not use the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_input.int">input.int()</a>
from line 5 and discards all its associated calculations, the
“Length” input <em>will</em> still appear in the script’s settings,
as the compiler <strong>does not</strong> completely remove unused
<a href="/pine-script-docs/concepts/inputs/">inputs</a>.</li>
</ul>
<p>If we change the script to plot the <code dir="auto">barsInRange</code> value instead, the
declared variables and the
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_for">for</a> loop
are no longer unused since the output depends on them, and the Profiler
will now display performance information for that code:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Insignificant-unused-and-redundant-code-2.TBOBJdXS_Z1yftUf.webp" alt="image" width="1072" height="334" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="10p"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Unused&nbsp;code&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;of&nbsp;historical&nbsp;bars&nbsp;in&nbsp;the&nbsp;calculation.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">100</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Length"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;of&nbsp;closes&nbsp;over&nbsp;`lengthInput`&nbsp;bars&nbsp;betw</span><span class="mtk9">een&nbsp;the&nbsp;current&nbsp;bar's&nbsp;`high`&nbsp;and&nbsp;`low`.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">barsInRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span></span><br><span><span></span></span><br><span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;`close`&nbsp;price&nbsp;from&nbsp;`i`&nbsp;bars&nbsp;ago.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">pastClose</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">]</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Add&nbsp;1&nbsp;to&nbsp;`barsInRange`&nbsp;if&nbsp;the&nbsp;`pastClose`&nbsp;is&nbsp;be</span><span class="mtk9">tween&nbsp;the&nbsp;current&nbsp;bar's&nbsp;`high`&nbsp;and&nbsp;`low`.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">pastClose</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk11">low</span><span class="mtk1">&nbsp;</span><span class="mtk18">and</span><span class="mtk1">&nbsp;</span><span class="mtk33">pastClose</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk11">high</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">barsInRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;`barsInRange`&nbsp;value.&nbsp;The&nbsp;above&nbsp;calcula</span><span class="mtk9">tions&nbsp;will&nbsp;execute&nbsp;since&nbsp;the&nbsp;output&nbsp;requires&nbsp;them.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">barsInRange</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Bars&nbsp;in&nbsp;range"</span><span class="mtk13">)</span></span><br></code></div>
<p>Note that:</p>
<ul>
<li>The Profiler does not show performance information for the
<code dir="auto">lengthInput</code> declaration on line 5 or the <code dir="auto">barsInRange</code>
declaration on line 8 since the expressions on these lines do
not impact the script’s performance.</li>
</ul>
<p>When possible, the compiler also simplifies certain instances of
<em>redundant code</em> in a script, such as some forms of identical
expressions with the same
<a href="/pine-script-docs/language/type-system/#types">fundamental type</a>
values. This optimization allows the compiled script to only execute
such calculations <em>once</em>, on the first occurrence, and <em>reuse</em> the
calculated result for each repeated instance that the outputs depend on.</p>
<p>If a script contains repetitive code and the compiler simplifies it, the
Profiler will only show results for the <strong>first occurrence</strong> of the code
since that’s the only time the script requires the calculation.</p>
<p>For example, this script contains a code line that plots the value of
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_ta.sma">ta.sma(close,
100)</a>
and 12 code lines that plot the value of <a href="https://www.tradingview.com/pine-script-reference/v6/#fun_ta.sma">ta.sma(close,
500)</a>:</p>
<div class="pine-colorizer not-content colorized" data-id="2vm"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Redundant&nbsp;calculations&nbsp;demo"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">overlay</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;100-bar&nbsp;SMA&nbsp;of&nbsp;`close`&nbsp;values&nbsp;one&nbsp;time</span><span class="mtk9">.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"100-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.teal</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">3</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;500-bar&nbsp;SMA&nbsp;of&nbsp;`close`&nbsp;values&nbsp;12&nbsp;times</span><span class="mtk9">.&nbsp;After&nbsp;compiler&nbsp;optimizations,&nbsp;only&nbsp;the&nbsp;first&nbsp;`ta</span><span class="mtk9">.sma(close,&nbsp;500)`</span></span><br><span><span class="mtk9">//&nbsp;call&nbsp;on&nbsp;line&nbsp;9&nbsp;requires&nbsp;calculation&nbsp;in&nbsp;this&nbsp;cas</span><span class="mtk9">e.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#001aff</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">12</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#4d0bff</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">11</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#7306f7</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">10</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#920be9</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">9</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#ae11d5</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">8</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#c618be</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">7</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#db20a4</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">6</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#eb2c8a</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">5</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#f73d6f</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">4</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#fe5053</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">3</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#ff6534</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">2</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#ff7a00</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br></code></div>
<p>Since the last 12 lines all contain identical
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_ta.sma">ta.sma()</a>
calls, the compiler can automatically simplify the script so that it
only needs to evaluate <a href="https://www.tradingview.com/pine-script-reference/v6/#fun_ta.sma">ta.sma(close,
500)</a>
<em>once</em> per execution rather than repeating the calculation 11 more
times.</p>
<p>As we see below, the Profiler only shows results for lines 5 and 9.
These are the only parts of the code requiring significant calculations
since the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_ta.sma">ta.sma()</a>
calls on lines 10-20 are redundant in this case:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Insignificant-unused-and-redundant-code-3.B3yrx82E_2jeci8.webp" alt="image" width="1072" height="368" loading="lazy" decoding="async"></p>
<p>Another type of repetitive code optimization occurs when a script
contains two or more
<a href="/pine-script-docs/language/user-defined-functions/">user-defined functions</a> or
<a href="/pine-script-docs/language/methods/#user-defined-methods">methods</a>
with identical compiled forms. In such a case, the compiler simplifies
the script by <strong>removing</strong> the redundant functions, and the script will
treat all calls to the redundant functions as calls to the <strong>first</strong>
defined version. Therefore, the Profiler will only show local code
performance results for the <em>first</em> function since the discarded
“clones” will never execute.</p>
<p>For instance, the script below contains two
<a href="/pine-script-docs/language/user-defined-functions/">user-defined functions</a>, <code dir="auto">metallicRatio()</code> and <code dir="auto">calcMetallic()</code>, that calculate a
<a href="https://en.wikipedia.org/wiki/Metallic_mean" rel="nofollow">metallic ratio</a> of a given
order raised to a specified exponent:</p>
<div class="pine-colorizer not-content colorized" data-id="2km"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Redundant&nbsp;functions&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;Controls&nbsp;the&nbsp;base&nbsp;ratio&nbsp;for&nbsp;the&nbsp;`calcMetallic()`&nbsp;</span><span class="mtk9">call.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">order1Input</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Order&nbsp;1"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;Controls&nbsp;the&nbsp;base&nbsp;ratio&nbsp;for&nbsp;the&nbsp;`metallicRatio()`</span><span class="mtk9">&nbsp;call.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">order2Input</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">2</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Order&nbsp;2"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Calculates&nbsp;the&nbsp;value&nbsp;of&nbsp;a&nbsp;metallic&nbsp;ratio&nbsp;wi</span><span class="mtk9">th&nbsp;a&nbsp;given&nbsp;`order`,&nbsp;raised&nbsp;to&nbsp;a&nbsp;specified&nbsp;`exponen</span><span class="mtk9">t`.</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@param</span><span class="mtk9">&nbsp;order&nbsp;&nbsp;&nbsp;&nbsp;Determines&nbsp;the&nbsp;base&nbsp;ratio&nbsp;used.&nbsp;1&nbsp;=&nbsp;Gold</span><span class="mtk9">en&nbsp;Ratio,&nbsp;2&nbsp;=&nbsp;Silver&nbsp;Ratio,&nbsp;3&nbsp;=&nbsp;Bronze&nbsp;Ratio,&nbsp;and&nbsp;</span><span class="mtk9">so&nbsp;on.</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@param</span><span class="mtk9">&nbsp;exponent&nbsp;The&nbsp;exponent&nbsp;applied&nbsp;to&nbsp;the&nbsp;ratio.</span></span><br><span><span class="mtk15">metallicRatio</span><span class="mtk13">(</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">order</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">exponent</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">math.pow</span><span class="mtk13">((</span><span class="mtk33">order</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sqrt</span><span class="mtk13">(</span><span class="mtk12">4.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">order</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">order</span><span class="mtk13">))</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">exponent</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;function&nbsp;with&nbsp;the&nbsp;same&nbsp;signature&nbsp;and&nbsp;body</span><span class="mtk9">&nbsp;as&nbsp;`metallicRatio()`.</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;script&nbsp;discards&nbsp;this&nbsp;functio</span><span class="mtk9">n&nbsp;and&nbsp;treats&nbsp;`calcMetallic()`&nbsp;as&nbsp;an&nbsp;alias&nbsp;for&nbsp;`met</span><span class="mtk9">allicRatio()`.</span></span><br><span><span class="mtk15">calcMetallic</span><span class="mtk13">(</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">ord</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">exp</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">math.pow</span><span class="mtk13">((</span><span class="mtk33">ord</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sqrt</span><span class="mtk13">(</span><span class="mtk12">4.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">ord</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">ord</span><span class="mtk13">))</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">exp</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;results&nbsp;from&nbsp;a&nbsp;`calcMetallic()`&nbsp;and&nbsp;`m</span><span class="mtk9">etallicRatio()`&nbsp;call.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">calcMetallic</span><span class="mtk13">(</span><span class="mtk33">order1Input</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">%</span><span class="mtk1">&nbsp;</span><span class="mtk12">5</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Ratio&nbsp;1"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.orange</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">3</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">metallicRatio</span><span class="mtk13">(</span><span class="mtk33">order2Input</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">%</span><span class="mtk1">&nbsp;</span><span class="mtk12">5</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Ratio&nbsp;2"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.maroon</span><span class="mtk13">)</span></span><br></code></div>
<p>Despite the differences in the function and parameter names, the two
functions are otherwise identical, which the compiler detects while
translating the script. In this case, it <strong>discards</strong> the redundant
<code dir="auto">calcMetallic()</code> function, and the compiled script treats the
<code dir="auto">calcMetallic()</code> call as a <code dir="auto">metallicRatio()</code> call.</p>
<p>As we see here, the Profiler shows performance information for the
<code dir="auto">calcMetallic()</code> and <code dir="auto">metallicRatio()</code> calls on lines 21 and 22, but it
does <strong>not</strong> show any results for the local code of the <code dir="auto">calcMetallic()</code>
function on line 18. Instead, the Profiler’s information on line 13
within the <code dir="auto">metallicRatio()</code> function reflects the local code results
from <strong>both</strong>
<a href="/pine-script-docs/writing/profiling-and-optimization/#user-defined-function-calls">function calls</a>:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Insignificant-unused-and-redundant-code-4.DrYo57fh_Z1tHCEy.webp" alt="image" width="1072" height="416" loading="lazy" decoding="async"></p>
<h3 id="a-look-into-the-profilers-inner-workings" class="md-heading"><a href="#a-look-into-the-profilers-inner-workings">A look into the Profiler’s inner <span class="fancy-wrap">workings<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p>The Pine Profiler wraps all necessary code regions with specialized
<em>internal functions</em> to track and collect required information across
script executions. It then passes the information to additional
calculations that organize and display the performance results inside
the Pine Editor. This section gives users a peek into how the Profiler
applies internal functions to wrap Pine code and collect performance
data.</p>
<p>There are two main internal <strong>(non-Pine)</strong> functions the Profiler wraps
significant code with to facilitate runtime analysis. The first function
retrieves the current system time at specific points in the script’s
execution, and the second maps cumulative elapsed time and execution
data to specific code regions. We represent these functions in this
explanation as <code dir="auto">System.timeNow()</code> and <code dir="auto">registerPerf()</code> respectively.</p>
<p>When the Profiler detects code that requires analysis, it adds
<code dir="auto">System.timeNow()</code> above the code to get the initial time before
execution. Then, it adds <code dir="auto">registerPerf()</code> below the code to map and
accumulate the elapsed time and number of executions. The elapsed time
added on each <code dir="auto">registerPerf()</code> call is the <code dir="auto">System.timeNow()</code> value
<em>after</em> the execution minus the value <em>before</em> the execution.</p>
<p>The following <em>pseudocode</em> outlines this process for a
<a href="/pine-script-docs/writing/profiling-and-optimization/#single-line-results">single line</a> of code, where <code dir="auto">_startX</code> represents the starting time for
the <code dir="auto">lineX</code> line:</p>
<div class="pine-colorizer not-content colorized" data-id="2mn"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_startX</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span></span><br><span><span class="mtk18">&lt;</span><span class="mtk33">code_line_to_analyze</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk15">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_startX</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lineX</span><span class="mtk13">)</span></span><br></code></div>
<p>The process is similar for
<a href="/pine-script-docs/writing/profiling-and-optimization/#code-block-results">code blocks</a>. The difference is that the <code dir="auto">registerPerf()</code> call maps the
data to a <em>range of lines</em> rather than a single line. Here, <code dir="auto">lineX</code>
represents the <em>first</em> line in the code block, and <code dir="auto">lineY</code> represents
the block’s <em>last</em> line:</p>
<div class="pine-colorizer not-content colorized" data-id="2hw"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_startX</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span></span><br><span><span class="mtk18">&lt;</span><span class="mtk33">code_block_to_analyze</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk15">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_startX</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lineX</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lineY</span><span class="mtk13">)</span></span><br></code></div>
<p>Note that:</p>
<ul>
<li>In the above snippets, <code dir="auto">long</code>, <code dir="auto">System.timeNow()</code>, and
<code dir="auto">registerPerf()</code> represent <em>internal code</em>, <strong>not</strong> Pine Script
code.</li>
</ul>
<p>Let’s now look at how the Profiler wraps a full script and all its
significant code. We will start with this script, which calculates three
pseudorandom series and displays their average
result. The script utilizes an <a href="/pine-script-docs/language/objects/">object</a> of a
<a href="/pine-script-docs/language/type-system/#user-defined-types">user-defined type</a> to store a pseudorandom state, a
<a href="/pine-script-docs/language/methods/#user-defined-methods">method</a>
to calculate new values and update the state, and an <a href="/pine-script-docs/language/conditional-structures/#if-structure">if…else
if</a>
structure to update each series based on generated values:</p>
<div class="pine-colorizer not-content colorized" data-id="7ce"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Profiler's&nbsp;inner&nbsp;workings&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">seedInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">12345</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Seed"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18">type</span><span class="mtk1">&nbsp;</span><span class="mtk33">LCG</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">state</span></span><br><span><span></span></span><br><span><span class="mtk18">method</span><span class="mtk1">&nbsp;</span><span class="mtk33">generate</span><span class="mtk13">(</span><span class="mtk18 mtkb">LCG</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">generations</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">generations</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">this</span><span class="mtk1">.</span><span class="mtk33">state</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk12">16807</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk1">.</span><span class="mtk33">state</span><span class="mtk1">&nbsp;</span><span class="mtk18">%</span><span class="mtk1">&nbsp;</span><span class="mtk12">2147483647</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk1">.</span><span class="mtk33">state</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk12">2147483647</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">generations</span></span><br><span><span></span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">LCG</span><span class="mtk1">.</span><span class="mtk15">new</span><span class="mtk13">(</span><span class="mtk33">seedInput</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">val0</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">val1</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">val2</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span></span><br><span><span></span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">10</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">val0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk12">2.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">50</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.1</span></span><br><span><span class="mtk18">else</span><span class="mtk1">&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">10</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">val1</span><span class="mtk1">&nbsp;</span><span class="mtk18">*=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk12">2.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">50</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.1</span></span><br><span><span class="mtk18">else</span><span class="mtk1">&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">10</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">val2</span><span class="mtk1">&nbsp;</span><span class="mtk18">*=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk12">2.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">50</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.1</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">math.avg</span><span class="mtk13">(</span><span class="mtk33">val0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">val1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">val2</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Average&nbsp;pseudorandom&nbsp;result"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.purple</span><span class="mtk13">)</span></span><br></code></div>
<p>The Profiler will wrap the entire script and all necessary code regions,
excluding any
<a href="/pine-script-docs/writing/profiling-and-optimization/#insignificant-unused-and-redundant-code">insignificant, unused, or redundant code</a>, with the aforementioned <strong>internal</strong> functions to collect
performance data. The <em>pseudocode</em> below demonstrates how this process
applies to the above script:</p>
<div class="pine-colorizer not-content colorized" data-id="54f"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_startMain</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;the&nbsp;script's&nbsp;overall&nbsp;execution.</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;&lt;Additional&nbsp;internal&nbsp;code&nbsp;executes&nbsp;here&gt;</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Profiler's&nbsp;inner&nbsp;workings&nbsp;demo"</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Declaration&nbsp;statements&nbsp;do&nbsp;not&nbsp;require&nbsp;profiling</span><span class="mtk9">.</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">seedInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">12345</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Seed"</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Variable&nbsp;declaration&nbsp;without&nbsp;significant&nbsp;calcul</span><span class="mtk9">ation.</span></span><br><span><span></span></span><br><span><span class="mtk18">type</span><span class="mtk1">&nbsp;</span><span class="mtk33">LCG</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Type&nbsp;declarations&nbsp;do&nbsp;not&nbsp;require&nbsp;profiling.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">state</span></span><br><span><span></span></span><br><span><span class="mtk18">method</span><span class="mtk1">&nbsp;</span><span class="mtk33">generate</span><span class="mtk13">(</span><span class="mtk18 mtkb">LCG</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">generations</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Function&nbsp;signature&nbsp;does&nbsp;not&nbsp;affect&nbsp;runtime.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Variable&nbsp;declaration&nbsp;without&nbsp;significant&nbsp;calcul</span><span class="mtk9">ation.</span></span><br><span><span></span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start11</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;the&nbsp;loop&nbsp;block&nbsp;that&nbsp;begins&nbsp;on&nbsp;li</span><span class="mtk9">ne&nbsp;11.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">generations</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Loop&nbsp;header&nbsp;calculations&nbsp;are&nbsp;not&nbsp;independently&nbsp;</span><span class="mtk9">wrapped.</span></span><br><span><span></span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start12</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;line&nbsp;12.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">this</span><span class="mtk1">.</span><span class="mtk33">state</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk12">16807</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk1">.</span><span class="mtk33">state</span><span class="mtk1">&nbsp;</span><span class="mtk18">%</span><span class="mtk1">&nbsp;</span><span class="mtk12">2147483647</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start12</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line12</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;performance&nbsp;info&nbsp;for&nbsp;line&nbsp;12.</span></span><br><span><span></span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start13</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;line&nbsp;13.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk1">.</span><span class="mtk33">state</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk12">2147483647</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start13</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line13</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;performance&nbsp;info&nbsp;for&nbsp;line&nbsp;13.</span></span><br><span><span></span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start11</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line11</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line13</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;performance&nbsp;info&nbsp;for&nbsp;the&nbsp;block&nbsp;(line&nbsp;1</span><span class="mtk9">1&nbsp;-&nbsp;13).&nbsp;&nbsp;&nbsp;&nbsp;</span></span><br><span><span></span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start14</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;line&nbsp;14.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">generations</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start14</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line14</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;performance&nbsp;info&nbsp;for&nbsp;line&nbsp;14.</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start16</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;line&nbsp;16.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">LCG</span><span class="mtk1">.</span><span class="mtk15">new</span><span class="mtk13">(</span><span class="mtk33">seedInput</span><span class="mtk13">)</span></span><br><span><span class="mtk15">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start16</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line16</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;performance&nbsp;info&nbsp;for&nbsp;line&nbsp;16.</span></span><br><span><span></span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">val0</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Variable&nbsp;declarations&nbsp;without&nbsp;significant&nbsp;calcu</span><span class="mtk9">lations.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">val1</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">val2</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start22</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;the&nbsp;`if`&nbsp;block&nbsp;that&nbsp;begins&nbsp;on&nbsp;li</span><span class="mtk9">ne&nbsp;22.</span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">10</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;`if`&nbsp;statement&nbsp;is&nbsp;not&nbsp;independently&nbsp;wrapped.</span></span><br><span><span></span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start23</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;line&nbsp;23.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">val0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk12">2.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">50</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start23</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line23</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;performance&nbsp;info&nbsp;for&nbsp;line&nbsp;23.</span></span><br><span><span></span></span><br><span><span class="mtk18">else</span><span class="mtk1">&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">10</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;`else&nbsp;if`&nbsp;statement&nbsp;is&nbsp;not&nbsp;independently&nbsp;wrappe</span><span class="mtk9">d.</span></span><br><span><span></span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start25</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;line&nbsp;25.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">val1</span><span class="mtk1">&nbsp;</span><span class="mtk18">*=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk12">2.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">50</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start25</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line25</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;performance&nbsp;info&nbsp;for&nbsp;line&nbsp;25.</span></span><br><span><span></span></span><br><span><span class="mtk18">else</span><span class="mtk1">&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">10</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;`else&nbsp;if`&nbsp;statement&nbsp;is&nbsp;not&nbsp;independently&nbsp;wrappe</span><span class="mtk9">d.</span></span><br><span><span></span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start27</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;line&nbsp;27.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">val2</span><span class="mtk1">&nbsp;</span><span class="mtk18">*=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk12">2.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">50</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start27</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line27</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;performance&nbsp;info&nbsp;for&nbsp;line&nbsp;27.</span></span><br><span><span></span></span><br><span><span class="mtk15">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start22</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line22</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line28</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;performance&nbsp;info&nbsp;for&nbsp;the&nbsp;block&nbsp;(line&nbsp;2</span><span class="mtk9">2&nbsp;-&nbsp;28).</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start29</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;line&nbsp;29.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">math.avg</span><span class="mtk13">(</span><span class="mtk33">val0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">val1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">val2</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Average&nbsp;pseudorandom&nbsp;result"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.purple</span><span class="mtk13">)</span></span><br><span><span class="mtk15">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start29</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line29</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;performance&nbsp;info&nbsp;for&nbsp;line&nbsp;29.</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;&lt;Additional&nbsp;internal&nbsp;code&nbsp;executes&nbsp;here&gt;</span></span><br><span><span></span></span><br><span><span class="mtk15">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_startMain</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">total</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;the&nbsp;script's&nbsp;overall&nbsp;performance&nbsp;info.</span></span><br></code></div>
<p>Note that:</p>
<ul>
<li>This example is <strong>pseudocode</strong> that provides a basic outline of
the <strong>internal calculations</strong> the Profiler applies to collect
performance data. Saving this example in the Pine Editor will
result in a compilation error since <code dir="auto">long</code>, <code dir="auto">System.timeNow()</code>,
and <code dir="auto">registerPerf()</code> <strong>do not</strong> represent Pine Script code.</li>
<li>These internal calculations that the Profiler wraps a script
with require <strong>additional</strong> computational resources, which is
why a script’s runtime <strong>increases</strong> while profiling.
Programmers should always interpret the results as <strong>estimates</strong>
since they reflect a script’s performance with the extra
calculations included.</li>
</ul>
<p>After running the wrapped script to collect performance data,
<em>additional</em> internal calculations organize the results and display
relevant information inside the Pine Editor:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-A-look-into-the-profilers-inner-workings-1.wt5GoYky_Z1cXiWC.webp" alt="image" width="1072" height="526" loading="lazy" decoding="async"></p>
<p>The <em>“Line time”</em> calculation for
<a href="/pine-script-docs/writing/profiling-and-optimization/#code-block-results">code blocks</a> also occurs at this stage, as the Profiler cannot
individually wrap <a href="/pine-script-docs/language/loops/">loop</a>
headers or the conditional statements in
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_if">if</a> or
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_switch">switch</a>
structures. This field’s value represents the <em>difference</em> between a
block’s total time and the sum of its local code times, which is why
the “Line time” value for a
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_switch">switch</a>
block or an
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_if">if</a> block
with <code dir="auto">else if</code>
expressions represents the time spent on <strong>all</strong> the structure’s
conditional statements, not just the block’s <em>initial line</em> of code. If
a programmer requires more granular information for each conditional
expression in such a block, they can reorganize the logic into a
<em>nested</em>
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_if">if</a>
structure, as explained
<a href="/pine-script-docs/writing/profiling-and-optimization/#code-block-results">here</a>.</p>
<aside aria-label="Note" class="tv-informer not-content" style="--informer-header-color:#6A6D78;--informer-back-color-light:#F0F3FA;--informer-back-color-dark:#2A2E39"><div class="tv-informer-icon"><svg viewBox="0 0 18 18" width="18" height="18"><path d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16ZM8 6a1 1 0 1 1 2 0 1 1 0 0 1-2 0Zm1 2c.49 0 1 .59 1 1v3.01c0 .42-.51.99-1 .99s-1-.57-1-.99V9c0-.41.51-1 1-1Z" fill="currentColor"></path></svg></div><div class="tv-informer-content"><p><span class="tv-informer-header">Note</span>The Profiler <strong>cannot</strong> collect individual performance data for any required <em>internal</em> calculations and display their results inside the Pine Editor. Consequently, the time values the Profiler displays for all code regions in a script <strong>do not</strong> add up to 100% of its total runtime.</p></div></aside>
<h3 id="profiling-across-configurations" class="md-heading"><a href="#profiling-across-configurations">Profiling across <span class="fancy-wrap">configurations<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p>When a code’s <a href="https://en.wikipedia.org/wiki/Time_complexity" rel="nofollow">time
complexity</a> is not
constant or its execution pattern varies with its inputs, function
arguments, or available data, it’s often wise to profile the code
across <em>different configurations</em> and data feeds for a more well-rounded
perspective on its general performance.</p>
<p>For example, this simple script uses a
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_for">for</a> loop
to calculate the sum of squared distances between the current
<a href="https://www.tradingview.com/pine-script-reference/v6/#var_close">close</a>
price and <code dir="auto">lengthInput</code> previous prices, then plots the square root of that sum on each bar. In this case, the <code dir="auto">lengthInput</code> directly
impacts the calculation’s runtime since it determines the number of
times the loop executes its local code:</p>
<div class="pine-colorizer not-content colorized" data-id="1m"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Profiling&nbsp;across&nbsp;configurations&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;of&nbsp;previous&nbsp;bars&nbsp;in&nbsp;the&nbsp;calculation.&nbsp;D</span><span class="mtk9">irectly&nbsp;affects&nbsp;the&nbsp;number&nbsp;of&nbsp;loop&nbsp;iterations.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">25</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Length"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;sum&nbsp;of&nbsp;squared&nbsp;distances&nbsp;from&nbsp;the&nbsp;current&nbsp;`cl</span><span class="mtk9">ose`&nbsp;to&nbsp;`lengthInput`&nbsp;past&nbsp;`close`&nbsp;values.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">total</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Look&nbsp;back&nbsp;across&nbsp;`lengthInput`&nbsp;bars&nbsp;and&nbsp;accumul</span><span class="mtk9">ate&nbsp;squared&nbsp;distances.</span></span><br><span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">distance</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">]</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">total</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk33">distance</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">distance</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;square&nbsp;root&nbsp;of&nbsp;the&nbsp;`total`.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">math.sqrt</span><span class="mtk13">(</span><span class="mtk33">total</span><span class="mtk13">))</span></span><br></code></div>
<p>Let’s try profiling this script with different <code dir="auto">lengthInput</code> values.
First, we’ll use the default value of 25. The Profiler’s results for
this specific run show that the script completed 20,685 executions in
about 96.7 milliseconds:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Profiling-across-configurations-1.DH6uvleV_15wBst.webp" alt="image" width="1072" height="304" loading="lazy" decoding="async"></p>
<p>Here, we’ve increased the input’s value to 50 in the script’s
settings. The results for this run show that the script’s total runtime
was 194.3 milliseconds, close to <em>twice</em> the time from the previous run:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Profiling-across-configurations-2.ggfGlT9L_ZW6q7G.webp" alt="image" width="1072" height="304" loading="lazy" decoding="async"></p>
<p>In the next run, we changed the input’s value to 200. This time, the
Profiler’s results show that the script finished all executions in
approximately 0.8 seconds, around <em>four times</em> the previous run’s time:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Profiling-across-configurations-3.CZLkQfeW_Z1lXDjU.webp" alt="image" width="1072" height="304" loading="lazy" decoding="async"></p>
<p>We can see from these observations that the script’s runtime appears to
scale <em>linearly</em> with the <code dir="auto">lengthInput</code> value, excluding other factors
that may affect performance, as one might expect since the bulk of the
script’s calculations occur within the loop and the input’s value
controls how many times the loop must execute.</p>
<aside aria-label="Tip" class="tv-informer not-content" style="--informer-header-color:#089981;--informer-back-color-light:#DAF2EE;--informer-back-color-dark:#082621"><div class="tv-informer-icon"><svg viewBox="0 0 18 18" width="18" height="18"><path d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16Zm3.87-12.15c.36.2.49.66.28 1.02l-4 7a.75.75 0 0 1-1.18.16l-3-3a.75.75 0 1 1 1.06-1.06l2.3 2.3 3.52-6.14a.75.75 0 0 1 1.02-.28Z" fill="currentColor"></path></svg></div><div class="tv-informer-content"><p><span class="tv-informer-header">Tip</span>Profiling each configuration <em>more than once</em> helps reduce the impact of outliers while assessing how a script’s performance varies with its inputs or data. See the <a href="/pine-script-docs/writing/profiling-and-optimization/#repetitive-profiling">Repetitive profiling</a> section below for more information.</p></div></aside>
<h3 id="repetitive-profiling" class="md-heading"><a href="#repetitive-profiling">Repetitive <span class="fancy-wrap">profiling<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p>The runtime resources available to a script <em>vary</em> over time.
Consequently, the time it takes to evaluate a code region, even one with
constant <a href="https://en.wikipedia.org/wiki/Time_complexity" rel="nofollow">complexity</a>,
<em>fluctuates</em> across executions, and the cumulative performance results
shown by the Profiler <strong>will vary</strong> with each independent script run.</p>
<p>Users can enhance their analysis by <em>restarting</em> a script several times
and profiling each independent run. Averaging the results from each
profiled run and evaluating the dispersion of runtime results can help
users establish more robust performance benchmarks and reduce the impact
of <em>outliers</em> (abnormally long or short runtimes) in their conclusions.</p>
<p>Incorporating a <em>dummy input</em> (i.e., an input that does nothing) into a
script’s code is a simple technique that enables users to <em>restart</em> it
while profiling. The input will not directly affect any calculations or
outputs. However, as the user changes its value in the script’s
settings, the script restarts and the Profiler re-analyzes the executed
code.</p>
<p>For example, this script
<a href="/pine-script-docs/language/arrays/#using-an-array-as-a-queue">queues</a> pseudorandom values with a constant seed through an
<a href="https://www.tradingview.com/pine-script-reference/v6/#type_array">array</a>
with a fixed size, and it calculates and plots the <a href="https://www.tradingview.com/pine-script-reference/v6/#fun_array.avg">array.avg()</a>
value on each bar. For profiling purposes, the script includes a
<code dir="auto">dummyInput</code> variable with an
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_input.int">input.int()</a>
value assigned to it. The input does nothing in the code aside from
allowing us to <em>restart</em> the script each time we change its value:</p>
<div class="pine-colorizer not-content colorized" data-id="4e9"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Repetitive&nbsp;profiling&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;input&nbsp;not&nbsp;connected&nbsp;to&nbsp;script&nbsp;calculations.&nbsp;Ch</span><span class="mtk9">anging&nbsp;its&nbsp;value&nbsp;in&nbsp;the&nbsp;"Inputs"&nbsp;tab&nbsp;restarts&nbsp;the&nbsp;</span><span class="mtk9">script.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">dummyInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Dummy&nbsp;input"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;of&nbsp;pseudorandom&nbsp;values.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">randValues</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk12">2500</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Push&nbsp;a&nbsp;new&nbsp;`math.random()`&nbsp;value&nbsp;with&nbsp;a&nbsp;fixed&nbsp;`</span><span class="mtk9">seed`&nbsp;into&nbsp;the&nbsp;`randValues`&nbsp;array&nbsp;and&nbsp;remove&nbsp;the&nbsp;o</span><span class="mtk9">ldest&nbsp;value.</span></span><br><span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">randValues</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.random</span><span class="mtk13">(</span><span class="mtk33">seed</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">12345</span><span class="mtk13">))</span></span><br><span><span class="mtk16">array.shift</span><span class="mtk13">(</span><span class="mtk33">randValues</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;average&nbsp;of&nbsp;all&nbsp;elements&nbsp;in&nbsp;the&nbsp;`randVa</span><span class="mtk9">lues`&nbsp;array.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">array.avg</span><span class="mtk13">(</span><span class="mtk33">randValues</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Pseudorandom&nbsp;average"</span><span class="mtk13">)</span></span><br></code></div>
<p>After the first script run, the Profiler shows that it took 308.6
milliseconds to execute across all of the chart’s data:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Repetitive-profiling-1.CfionGK2_pmOYe.webp" alt="image" width="1072" height="304" loading="lazy" decoding="async"></p>
<p>Now, let’s change the dummy input’s value in the script’s settings to
restart it without changing the calculations. This time, it completed
the same code executions in 424.6 milliseconds, 116 milliseconds longer
than the previous run:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Repetitive-profiling-2.LouNiZpq_o9WWS.webp" alt="image" width="1072" height="304" loading="lazy" decoding="async"></p>
<p>Restarting the script again yields another new result. On the third run,
the script finished all code executions in 227.4 milliseconds, the
shortest time so far:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Repetitive-profiling-3.UGJOj4nF_Z1p4czi.webp" alt="image" width="1072" height="304" loading="lazy" decoding="async"></p>
<p>After repeating this process several times and documenting the results
from each run, one can manually calculate their <em>average</em> to estimate
the script’s expected total runtime:</p>
<p><code dir="auto">AverageTime = (time1 + time2 + ... + timeN) / N</code></p>
<aside aria-label="Notice" class="tv-informer not-content" style="--informer-header-color:#FF9800;--informer-back-color-light:#FFF3E0;--informer-back-color-dark:#33261A"><div class="tv-informer-icon"><svg viewBox="0 0 18 18" width="18" height="18"><path fill-rule="evenodd" d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16ZM9 4c-.79 0-1.38.7-1.25 1.48l.67 4.03a.59.59 0 0 0 1.16 0l.67-4.03A1.27 1.27 0 0 0 9 4Zm0 8a1 1 0 1 0 0 2 1 1 0 0 0 0-2Z" fill="currentColor"></path></svg></div><div class="tv-informer-content"><p><span class="tv-informer-header">Notice</span>Whether profiling a single script run or multiple, it’s crucial to understand that <strong>results will vary</strong>. Averaging results across several profiled script runs can help programmers derive more stable performance estimates. However, those estimates do not necessarily indicate how the script will perform in the future.</p></div></aside>
<h2 id="optimization" class="md-heading"><a href="#optimization"> <span class="fancy-wrap">Optimization<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h2>
<p><em>Code optimization</em>, not to be confused with indicator or strategy
optimization, involves modifying a script’s source code for improved
execution time, resource efficiency, and scalability. Programmers may
use various approaches to optimize a script when they need enhanced
runtime performance, depending on what a script’s calculations entail.</p>
<p>Fundamentally, most techniques one will use to optimize Pine code
involve <em>reducing</em> the number of times critical calculations occur or
<em>replacing</em> significant calculations with simplified formulas or
built-ins. Both of these paradigms often overlap.</p>
<p>The following sections explain several straightforward concepts
programmers can apply to optimize their Pine Script code.</p>
<aside aria-label="Tip" class="tv-informer not-content" style="--informer-header-color:#089981;--informer-back-color-light:#DAF2EE;--informer-back-color-dark:#082621"><div class="tv-informer-icon"><svg viewBox="0 0 18 18" width="18" height="18"><path d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16Zm3.87-12.15c.36.2.49.66.28 1.02l-4 7a.75.75 0 0 1-1.18.16l-3-3a.75.75 0 1 1 1.06-1.06l2.3 2.3 3.52-6.14a.75.75 0 0 1 1.02-.28Z" fill="currentColor"></path></svg></div><div class="tv-informer-content"><p><span class="tv-informer-header">Tip</span>Before looking for ways to optimize a script, <a href="/pine-script-docs/writing/profiling-and-optimization/#profiling-a-script">profile it</a> to gauge its performance and identify the <strong>critical code regions</strong> that can benefit the most from optimization.</p></div></aside>
<h3 id="using-built-ins" class="md-heading"><a href="#using-built-ins">Using <span class="fancy-wrap">built-ins<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p>Pine Script features a variety of <em>built-in</em> functions and variables
that help streamline script creation. Many of Pine’s built-ins feature
internal optimizations to help maximize efficiency and minimize
execution time. As such, one of the simplest ways to optimize Pine code
is to utilize these efficient built-ins in a script’s calculations when
possible.</p>
<p>Let’s look at an example where one can replace user-defined
calculations with a concise built-in call to substantially improve
performance. Suppose a programmer wants to calculate the highest value
of a series over a specified number of bars. Someone not familiar with
all of Pine’s built-ins might approach the task using a code like the
following, which uses a <a href="/pine-script-docs/language/loops/">loop</a>
on each bar to compare <code dir="auto">length</code> historical values of a <code dir="auto">source</code> series:</p>
<div class="pine-colorizer not-content colorized" data-id="5lm"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;A&nbsp;user-defined&nbsp;function&nbsp;to&nbsp;calculate&nbsp;the&nbsp;highest&nbsp;</span><span class="mtk9">`source`&nbsp;value&nbsp;over&nbsp;`length`&nbsp;bars.</span></span><br><span><span class="mtk15">pineHighest</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;=</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk33">result</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">])</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span></span><br></code></div>
<p>Alternatively, one might devise a more optimized Pine function by
reducing the number of times the loop executes, as iterating over the
history of the <code dir="auto">source</code> to achieve the result is only necessary when
specific conditions occur:</p>
<div class="pine-colorizer not-content colorized" data-id="6qj"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;A&nbsp;faster&nbsp;user-defined&nbsp;function&nbsp;to&nbsp;calculate&nbsp;the&nbsp;h</span><span class="mtk9">ighest&nbsp;`source`&nbsp;value&nbsp;over&nbsp;`length`&nbsp;bars.</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;version&nbsp;only&nbsp;requires&nbsp;a&nbsp;loop&nbsp;when</span><span class="mtk9">&nbsp;the&nbsp;highest&nbsp;value&nbsp;is&nbsp;removed&nbsp;from&nbsp;the&nbsp;window,&nbsp;the</span><span class="mtk9">&nbsp;`length`&nbsp;</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;changes,&nbsp;or&nbsp;when&nbsp;the&nbsp;number&nbsp;of&nbsp;bars&nbsp;fi</span><span class="mtk9">rst&nbsp;becomes&nbsp;sufficient&nbsp;to&nbsp;calculate&nbsp;the&nbsp;result.&nbsp;</span></span><br><span><span class="mtk15">fasterPineHighest</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">length</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">==</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">or</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">!=</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">[</span><span class="mtk12">1</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">or</span><span class="mtk1">&nbsp;</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">==</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk33">result</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">])</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">else</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk33">result</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span></span><br></code></div>
<p>The built-in
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_ta.highest">ta.highest()</a>
function will outperform <strong>both</strong> of these implementations, as its
internal calculations are highly optimized for efficient execution.
Below, we created a script that plots the results of calling
<code dir="auto">pineHighest()</code>, <code dir="auto">fasterPineHighest()</code>, and
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_ta.highest">ta.highest()</a>
to compare their performance using the
<a href="/pine-script-docs/writing/profiling-and-optimization/#pine-profiler">Profiler</a>:</p>
<div class="pine-colorizer not-content colorized" data-id="4yd"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6&nbsp;</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Using&nbsp;built-ins&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;A&nbsp;user-defined&nbsp;function&nbsp;to&nbsp;calculate&nbsp;the&nbsp;highest&nbsp;</span><span class="mtk9">`source`&nbsp;value&nbsp;over&nbsp;`length`&nbsp;bars.</span></span><br><span><span class="mtk15">pineHighest</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;=</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk33">result</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">])</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;A&nbsp;faster&nbsp;user-defined&nbsp;function&nbsp;to&nbsp;calculate&nbsp;the&nbsp;h</span><span class="mtk9">ighest&nbsp;`source`&nbsp;value&nbsp;over&nbsp;`length`&nbsp;bars.</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;version&nbsp;only&nbsp;requires&nbsp;a&nbsp;loop&nbsp;when</span><span class="mtk9">&nbsp;the&nbsp;highest&nbsp;value&nbsp;is&nbsp;removed&nbsp;from&nbsp;the&nbsp;window,&nbsp;the</span><span class="mtk9">&nbsp;`length`&nbsp;</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;changes,&nbsp;or&nbsp;when&nbsp;the&nbsp;number&nbsp;of&nbsp;bars&nbsp;fi</span><span class="mtk9">rst&nbsp;becomes&nbsp;sufficient&nbsp;to&nbsp;calculate&nbsp;the&nbsp;result.&nbsp;</span></span><br><span><span class="mtk15">fasterPineHighest</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">length</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">==</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">or</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">!=</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">[</span><span class="mtk12">1</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">or</span><span class="mtk1">&nbsp;</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">==</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk33">result</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">])</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">else</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk33">result</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">pineHighest</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span><span class="mtk13">))</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">fasterPineHighest</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span><span class="mtk13">))</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.highest</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span><span class="mtk13">))</span></span><br></code></div>
<p>The
<a href="/pine-script-docs/writing/profiling-and-optimization/#interpreting-profiled-results">profiled results</a> over 20,735 script executions show the call to
<code dir="auto">pineHighest()</code> took the most time to execute, with a runtime of 57.9
milliseconds, about 69.3% of the script’s total runtime. The
<code dir="auto">fasterPineHighest()</code> call performed much more efficiently, as it only
took about 16.9 milliseconds, approximately 20.2% of the total runtime,
to calculate the same values.</p>
<p>The most efficient <em>by far</em>, however, was the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_ta.highest">ta.highest()</a>
call, which only required 3.2 milliseconds (~3.8% of the total runtime)
to execute across all the chart’s data and compute the same values in
this run:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Using-built-ins-1.CXnfIZo4_ZWjpAS.webp" alt="image" width="1072" height="564" loading="lazy" decoding="async"></p>
<p>While these results effectively demonstrate that the built-in function
outperforms our
<a href="/pine-script-docs/language/user-defined-functions/">user-defined functions</a> with a small <code dir="auto">length</code> argument of 20, it’s crucial to
consider that the calculations required by the functions <em>will vary</em>
with the argument’s value. Therefore, we can profile the code while
using
<a href="/pine-script-docs/writing/profiling-and-optimization/#profiling-across-configurations">different arguments</a> to gauge how its runtime scales.</p>
<p>Here, we changed the <code dir="auto">length</code> argument in each function call from 20 to
200 and
<a href="/pine-script-docs/writing/profiling-and-optimization/#profiling-a-script">profiled the script</a> again to observe the changes in performance. The time spent
on the <code dir="auto">pineHighest()</code> function in this run increased to about 0.6
seconds (~86% of the total runtime), and the time spent on the
<code dir="auto">fasterPineHighest()</code> function increased to about 75 milliseconds. The
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_ta.highest">ta.highest()</a>
function, on the other hand, <em>did not</em> experience a substantial runtime
change. It took about 5.8 milliseconds this time, only a couple of
milliseconds more than the previous run.</p>
<p>In other words, while our
<a href="/pine-script-docs/language/user-defined-functions/">user-defined functions</a> experienced significant runtime growth with a higher
<code dir="auto">length</code> argument in this run, the change in the built-in
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_ta.highest">ta.highest()</a>
function’s runtime was relatively marginal in this case, thus further
emphasizing its performance benefits:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Using-built-ins-2.wlIsvoLn_Z1yQ1xR.webp" alt="image" width="1072" height="564" loading="lazy" decoding="async"></p>
<p>Note that:</p>
<ul>
<li>In many scenarios, a script’s runtime can benefit from using
built-ins where applicable. However, the relative performance
edge achieved from using built-ins depends on a script’s
<em>high-impact code</em> and the specific built-ins used. In any case,
one should always
<a href="/pine-script-docs/writing/profiling-and-optimization/#profiling-a-script">profile their scripts</a>, preferably
<a href="/pine-script-docs/writing/profiling-and-optimization/#repetitive-profiling">several times</a>, when exploring optimized solutions.</li>
<li>The calculations performed by the functions in this example also
depend on the sequence of the chart’s data. Therefore,
programmers can gain further insight into their general
performance by profiling the script across
<a href="/pine-script-docs/writing/profiling-and-optimization/#profiling-across-configurations">different datasets</a> as well.</li>
</ul>
<h3 id="reducing-repetition" class="md-heading"><a href="#reducing-repetition">Reducing <span class="fancy-wrap">repetition<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p>The Pine Script compiler can automatically simplify some types of
<a href="/pine-script-docs/writing/profiling-and-optimization/#insignificant-unused-and-redundant-code">repetitive code</a> without a programmer’s intervention. However, this
automatic process has its limitations. If a script contains repetitive
calculations that the compiler <em>cannot</em> reduce, programmers can reduce
the repetition <em>manually</em> to improve their script’s performance.</p>
<p>For example, this script contains a <code dir="auto">valuesAbove()</code>
<a href="/pine-script-docs/language/methods/#user-defined-methods">method</a>
that counts the number of elements in an
<a href="https://www.tradingview.com/pine-script-reference/v6/#type_array">array</a>
above the element at a specified index. The script plots the number of
values above the element at the last index of a <code dir="auto">data</code> array with a
calculated <code dir="auto">plotColor</code>. It calculates the <code dir="auto">plotColor</code> within a
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_switch">switch</a>
structure that calls <code dir="auto">valuesAbove()</code> in all 10 of its conditional
expressions:</p>
<div class="pine-colorizer not-content colorized" data-id="4ad"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Reducing&nbsp;repetition&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Counts&nbsp;the&nbsp;number&nbsp;of&nbsp;elements&nbsp;in&nbsp;`this`&nbsp;array&nbsp;abo</span><span class="mtk9">ve&nbsp;the&nbsp;element&nbsp;at&nbsp;a&nbsp;specified&nbsp;`index`.</span></span><br><span><span class="mtk18">method</span><span class="mtk1">&nbsp;</span><span class="mtk33">valuesAbove</span><span class="mtk13">(</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">index</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reference</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk1">.</span><span class="mtk15">get</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">value</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">in</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">==</span><span class="mtk1">&nbsp;</span><span class="mtk33">index</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">continue</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">value</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">reference</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;containing&nbsp;the&nbsp;most&nbsp;recent&nbsp;100&nbsp;`close`&nbsp;p</span><span class="mtk9">rices.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">data</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk12">100</span><span class="mtk13">)</span></span><br><span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">shift</span><span class="mtk13">()</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;Returns&nbsp;`color.purple`&nbsp;with&nbsp;a&nbsp;varying&nbsp;transparenc</span><span class="mtk9">y&nbsp;based&nbsp;on&nbsp;the&nbsp;`valuesAbove()`.</span></span><br><span><span class="mtk18 mtkb">color</span><span class="mtk1">&nbsp;</span><span class="mtk33">plotColor</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk18">switch</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">10</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">90</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">80</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">30</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">70</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">40</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">60</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">50</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">50</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">60</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">40</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">70</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">30</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">80</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">90</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">10</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;number&nbsp;values&nbsp;in&nbsp;the&nbsp;`data`&nbsp;array&nbsp;abov</span><span class="mtk9">e&nbsp;the&nbsp;value&nbsp;at&nbsp;its&nbsp;last&nbsp;index.&nbsp;</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">color</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">plotColor</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">style</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">plot.style_area</span><span class="mtk13">)</span></span><br></code></div>
<p>The
<a href="/pine-script-docs/writing/profiling-and-optimization/#interpreting-profiled-results">profiled results</a> for this script show that it spent about 2.5 seconds
executing 21,201 times. The code regions with the highest impact on the
script’s runtime are the
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_for">for</a> loop
within the <code dir="auto">valuesAbove()</code> local scope starting on line 8 and the
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_switch">switch</a>
block that starts on line 21:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Reducing-repetition-1.DzXiqnj9_Z1IB5Dn.webp" alt="image" width="1072" height="616" loading="lazy" decoding="async"></p>
<p>Notice that the number of executions shown for the local code within
<code dir="auto">valuesAbove()</code> is substantially <em>greater</em> than the number shown for the
code in the script’s global scope, as the script calls the method up to
11 times per execution, and the results for a
<a href="/pine-script-docs/writing/profiling-and-optimization/#user-defined-function-calls">function’s local code</a> reflect the <em>combined</em> time and executions from each
separate call:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Reducing-repetition-2.QnMs1Dg3_ZE1OU8.webp" alt="image" width="1072" height="304" loading="lazy" decoding="async"></p>
<p>Although each <code dir="auto">valuesAbove()</code> call uses the <em>same</em> arguments and returns
the <em>same</em> result, the compiler cannot automatically reduce this code
for us during translation. We will need to do the job ourselves. We can
optimize this script by assigning the value of <code dir="auto">data.valuesAbove(99)</code> to
a <em>variable</em> and <em>reusing</em> the value in all other areas requiring the
result.</p>
<p>In the version below, we modified the script by adding a <code dir="auto">count</code>
variable to reference the <code dir="auto">data.valuesAbove(99)</code> value. The script uses
this variable in the <code dir="auto">plotColor</code> calculation and the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_plot">plot()</a>
call:</p>
<div class="pine-colorizer not-content colorized" data-id="64g"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Reducing&nbsp;repetition&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Counts&nbsp;the&nbsp;number&nbsp;of&nbsp;elements&nbsp;in&nbsp;`this`&nbsp;array&nbsp;abo</span><span class="mtk9">ve&nbsp;the&nbsp;element&nbsp;at&nbsp;a&nbsp;specified&nbsp;`index`.</span></span><br><span><span class="mtk18">method</span><span class="mtk1">&nbsp;</span><span class="mtk33">valuesAbove</span><span class="mtk13">(</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">index</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reference</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk1">.</span><span class="mtk15">get</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">value</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">in</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">==</span><span class="mtk1">&nbsp;</span><span class="mtk33">index</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">continue</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">value</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">reference</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;containing&nbsp;the&nbsp;most&nbsp;recent&nbsp;100&nbsp;`close`&nbsp;p</span><span class="mtk9">rices.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">data</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk12">100</span><span class="mtk13">)</span></span><br><span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">shift</span><span class="mtk13">()</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;values&nbsp;in&nbsp;the&nbsp;`data`&nbsp;array&nbsp;above&nbsp;the&nbsp;v</span><span class="mtk9">alue&nbsp;at&nbsp;its&nbsp;last&nbsp;index.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;Returns&nbsp;`color.purple`&nbsp;with&nbsp;a&nbsp;varying&nbsp;transparenc</span><span class="mtk9">y&nbsp;based&nbsp;on&nbsp;the&nbsp;`valuesAbove()`.</span></span><br><span><span class="mtk18 mtkb">color</span><span class="mtk1">&nbsp;</span><span class="mtk33">plotColor</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk18">switch</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">10</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">90</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">80</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">30</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">70</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">40</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">60</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">50</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">50</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">60</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">40</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">70</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">30</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">80</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">90</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">10</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;`count`.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">count</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">color</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">plotColor</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">style</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">plot.style_area</span><span class="mtk13">)</span></span><br></code></div>
<p>With this modification, the
<a href="/pine-script-docs/writing/profiling-and-optimization/#interpreting-profiled-results">profiled results</a> show a significant improvement in performance, as the script
now only needs to evaluate the <code dir="auto">valuesAbove()</code> call <strong>once</strong> per
execution rather than up to 11 separate times:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Reducing-repetition-3.Nge1aqtk_2w60SG.webp" alt="image" width="1072" height="672" loading="lazy" decoding="async"></p>
<p>Note that:</p>
<ul>
<li>Since this script only calls <code dir="auto">valuesAbove()</code> once, the
<a href="/pine-script-docs/language/methods/#user-defined-methods">method’s</a> local code will now reflect the results from that
specific call. See
<a href="/pine-script-docs/writing/profiling-and-optimization/#user-defined-function-calls">this section</a> to learn more about interpreting profiled function
and method call results.</li>
</ul>
<h3 id="minimizing-request-calls" class="md-heading"><a href="#minimizing-request-calls"><span>Minimizing ​<code dir="auto">request.*()</code>​ calls</span><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></a></h3>
<p>The built-in functions in the <code dir="auto">request.*()</code> namespace allow scripts to
retrieve data from
<a href="/pine-script-docs/concepts/other-timeframes-and-data/">other contexts</a>. While these functions provide utility in many applications,
it’s important to consider that each call to these functions can have a
significant impact on a script’s resource usage.</p>
<p>A single script can contain up to 40 unique calls to the <code dir="auto">request.*()</code> family of functions, or up to 64 if the user has the <a href="https://www.tradingview.com/pricing/">Ultimate plan</a>. However, we recommend programmers aim to keep their scripts’ <code dir="auto">request.*()</code> calls far <em>below</em> this limit to keep the performance impact of their data requests as low as possible.</p>
<p>When a script requests the values of several expressions from the <em>same</em>
context with multiple
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_request.security">request.security()</a>
or
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_request.security_lower_tf">request.security_lower_tf()</a>
calls, one effective way to optimize such requests is to <em>condense</em> them
into a single <code dir="auto">request.*()</code> call that uses a
<a href="/pine-script-docs/concepts/other-timeframes-and-data/#tuples">tuple</a> as its <code dir="auto">expression</code> argument. This optimization not only
helps improve the runtime of the requests; it also helps reduce the
script’s <em>memory usage</em> and compiled size.</p>
<p>As a simple example, the following script requests nine
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_ta.percentrank">ta.percentrank()</a>
values with different lengths from a specified symbol using nine
separate calls to
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_request.security">request.security()</a>.
It then <a href="/pine-script-docs/visuals/plots/">plots</a> all nine
requested values on the chart to utilize them in the outputs:</p>
<div class="pine-colorizer not-content colorized" data-id="3be"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Minimizing&nbsp;`request.*()`&nbsp;calls&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;symbol&nbsp;to&nbsp;request&nbsp;data&nbsp;from.</span></span><br><span><span class="mtk18 mtkb">string</span><span class="mtk1">&nbsp;</span><span class="mtk33">symbolInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.symbol</span><span class="mtk13">(</span><span class="mtk29">"BINANCE:BTCUSDT"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Symbol"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Request&nbsp;9&nbsp;`ta.percentrank()`&nbsp;values&nbsp;from&nbsp;the&nbsp;`s</span><span class="mtk9">ymbolInput`&nbsp;context&nbsp;using&nbsp;9&nbsp;`request.security()`&nbsp;c</span><span class="mtk9">alls.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank1</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk33">symbolInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">10</span><span class="mtk13">))</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank2</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk33">symbolInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span><span class="mtk13">))</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank3</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk33">symbolInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">30</span><span class="mtk13">))</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank4</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk33">symbolInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">40</span><span class="mtk13">))</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank5</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk33">symbolInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">50</span><span class="mtk13">))</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank6</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk33">symbolInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">60</span><span class="mtk13">))</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank7</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk33">symbolInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">70</span><span class="mtk13">))</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank8</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk33">symbolInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">80</span><span class="mtk13">))</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank9</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk33">symbolInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">90</span><span class="mtk13">))</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;`reqRank*`&nbsp;values.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank1</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank2</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank3</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank4</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank5</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank6</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank7</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank8</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank9</span><span class="mtk13">)</span></span><br></code></div>
<p>The results from
<a href="/pine-script-docs/writing/profiling-and-optimization/#profiling-a-script">profiling the script</a> show that it took the script 340.8 milliseconds to complete
its requests and plot the values in this run:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Minimizing-request-calls-1.Canv49So_1Cn30c.webp" alt="image" width="1072" height="502" loading="lazy" decoding="async"></p>
<p>Since all the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_request.security">request.security()</a>
calls request data from the <strong>same context</strong>, we can optimize the
code’s resource usage by merging all of them into a single
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_request.security">request.security()</a>
call that uses a
<a href="/pine-script-docs/concepts/other-timeframes-and-data/#tuples">tuple</a> as its <code dir="auto">expression</code> argument:</p>
<div class="pine-colorizer not-content colorized" data-id="5u0"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Minimizing&nbsp;`request.*()`&nbsp;calls&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;symbol&nbsp;to&nbsp;request&nbsp;data&nbsp;from.</span></span><br><span><span class="mtk18 mtkb">string</span><span class="mtk1">&nbsp;</span><span class="mtk33">symbolInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.symbol</span><span class="mtk13">(</span><span class="mtk29">"BINANCE:BTCUSDT"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Symbol"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Request&nbsp;9&nbsp;`ta.percentrank()`&nbsp;values&nbsp;from&nbsp;the&nbsp;`s</span><span class="mtk9">ymbolInput`&nbsp;context&nbsp;using&nbsp;a&nbsp;single&nbsp;`request.securi</span><span class="mtk9">ty()`&nbsp;call.</span></span><br><span><span class="mtk13">[</span><span class="mtk33">reqRank1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank2</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank3</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank4</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank5</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank6</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank7</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank8</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank9</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span></span><br><span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">symbolInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk13">[</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">10</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">30</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">40</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">50</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">60</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">70</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">80</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">90</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk13">]</span></span><br><span><span class="mtk1">&nbsp;</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;`reqRank*`&nbsp;values.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank1</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank2</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank3</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank4</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank5</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank6</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank7</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank8</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank9</span><span class="mtk13">)</span></span><br></code></div>
<p>As we see below, the
<a href="/pine-script-docs/writing/profiling-and-optimization/#interpreting-profiled-results">profiled results</a> from running this version of the script show that it took
228.3 milliseconds this time, a decent improvement over the previous
run:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Minimizing-request-calls-2.BZ75zb8R_Z21D1UV.webp" alt="image" width="1072" height="486" loading="lazy" decoding="async"></p>
<p>Note that:</p>
<ul>
<li>The computational resources available to a script <strong>fluctuate</strong>
over time. As such, it’s typically a good idea to profile a
script
<a href="/pine-script-docs/writing/profiling-and-optimization/#repetitive-profiling">multiple times</a> to help solidify performance conclusions.</li>
<li>Another way to request multiple values from the same context
with a single <code dir="auto">request.*()</code> call is to pass an
<a href="/pine-script-docs/language/objects/">object</a> of a
<a href="/pine-script-docs/language/type-system/#user-defined-types">user-defined type (UDT)</a> as the <code dir="auto">expression</code> argument. See
<a href="/pine-script-docs/concepts/other-timeframes-and-data/#user-defined-types">this section</a> of the
<a href="/pine-script-docs/concepts/other-timeframes-and-data/">Other timeframes and data</a> page to learn more about requesting
<a href="/pine-script-docs/language/type-system/#user-defined-types">UDTs</a>.</li>
<li>Programmers can also reduce the total runtime of a
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_request.security">request.security()</a>,
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_request.security_lower_tf">request.security_lower_tf()</a>,
or
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_request.seed">request.seed()</a>
call by passing an argument to the function’s <code dir="auto">calc_bars_count</code>
parameter, which <em>restricts</em> the number of <em>historical</em> data
points it can access from a context and execute required
calculations on. In general, if calls to these <code dir="auto">request.*()</code>
functions retrieve <em>more</em> historical data than what a script
<em>needs</em>, limiting the requests with <code dir="auto">calc_bars_count</code> can help
improve the script’s performance.</li>
</ul>
<h3 id="avoiding-redrawing" class="md-heading"><a href="#avoiding-redrawing">Avoiding <span class="fancy-wrap">redrawing<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p>Pine Script’s
<a href="/pine-script-docs/language/type-system/#drawing-types">drawing types</a> allow scripts to draw custom visuals on a chart that one
cannot achieve through other outputs such as
<a href="/pine-script-docs/visuals/plots/">plots</a>. While these types
provide greater visual flexibility, they also have a <em>higher</em> runtime
and memory cost, especially when a script unnecessarily <em>recreates</em>
drawings instead of directly updating their properties to change their
appearance.</p>
<p>Most
<a href="/pine-script-docs/language/type-system/#drawing-types">drawing types</a>, excluding
<a href="/pine-script-docs/visuals/lines-and-boxes/#polylines">polylines</a>,
feature built-in <em>setter functions</em> in their namespaces that allow
scripts to modify a drawing <em>without</em> deleting and recreating it.
Utilizing these setters is typically less computationally expensive than
creating a new drawing object when only <em>specific properties</em> require
modification.</p>
<p>For example, the script below compares deleting and redrawing
<a href="/pine-script-docs/visuals/lines-and-boxes/#boxes">boxes</a> to using
<code dir="auto">box.set*()</code> functions. On the first bar, it declares the <code dir="auto">redrawnBoxes</code>
and <code dir="auto">updatedBoxes</code> <a href="/pine-script-docs/language/arrays/">arrays</a>
and executes a <a href="/pine-script-docs/language/loops/">loop</a> to push
25 <a href="https://www.tradingview.com/pine-script-reference/v6/#type_box">box</a>
elements into them.</p>
<p>The script uses a separate
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_for">for</a> loop
to iterate across the <a href="/pine-script-docs/language/arrays/">arrays</a> and update the drawings on each execution. It <em>recreates</em>
the <a href="/pine-script-docs/visuals/lines-and-boxes/#boxes">boxes</a> in
the <code dir="auto">redrawnBoxes</code> array using
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_box.delete">box.delete()</a>
and
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_box.new">box.new()</a>,
whereas it <em>directly modifies</em> the properties of the
<a href="/pine-script-docs/visuals/lines-and-boxes/#boxes">boxes</a> in the
<code dir="auto">updatedBoxes</code> array using
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_box.set_lefttop">box.set_lefttop()</a>
and
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_box.set_rightbottom">box.set_rightbottom()</a>.
Both approaches achieve the same visual result. However, the latter is
more efficient:</p>
<div class="pine-colorizer not-content colorized" data-id="pz"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Avoiding&nbsp;redrawing&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;of&nbsp;`box`&nbsp;IDs&nbsp;deleted&nbsp;with&nbsp;`box.delete()`</span><span class="mtk9">&nbsp;and&nbsp;redrawn&nbsp;with&nbsp;`box.new()`&nbsp;on&nbsp;each&nbsp;execution.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">box</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">redrawnBoxes</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">box</span><span class="mtk13">&gt;()</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;of&nbsp;`box`&nbsp;IDs&nbsp;with&nbsp;properties&nbsp;that&nbsp;update</span><span class="mtk9">&nbsp;across&nbsp;executions&nbsp;update&nbsp;via&nbsp;`box.set*()`&nbsp;functio</span><span class="mtk9">ns.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">box</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">updatedBoxes</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">box</span><span class="mtk13">&gt;()</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Populate&nbsp;both&nbsp;arrays&nbsp;with&nbsp;25&nbsp;elements&nbsp;on&nbsp;the&nbsp;fi</span><span class="mtk9">rst&nbsp;bar.&nbsp;</span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">barstate.isfirst</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk12">25</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">redrawnBoxes</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">box</span><span class="mtk13">(</span><span class="mtk11">na</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">updatedBoxes</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">box.new</span><span class="mtk13">(</span><span class="mtk11">na</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span><span class="mtk13">))</span></span><br><span><span></span></span><br><span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk12">24</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Calculate&nbsp;coordinates.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">x</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">y</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Get&nbsp;the&nbsp;`box`&nbsp;ID&nbsp;from&nbsp;each&nbsp;array&nbsp;at&nbsp;the&nbsp;`i`&nbsp;ind</span><span class="mtk9">ex.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">box</span><span class="mtk1">&nbsp;</span><span class="mtk33">redrawnBox</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">redrawnBoxes</span><span class="mtk1">.</span><span class="mtk15">get</span><span class="mtk13">(</span><span class="mtk33">i</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">box</span><span class="mtk1">&nbsp;</span><span class="mtk33">updatedBox</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">updatedBoxes</span><span class="mtk1">.</span><span class="mtk15">get</span><span class="mtk13">(</span><span class="mtk33">i</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Delete&nbsp;the&nbsp;`redrawnBox`,&nbsp;create&nbsp;a&nbsp;new&nbsp;`box`&nbsp;ID,</span><span class="mtk9">&nbsp;and&nbsp;replace&nbsp;that&nbsp;element&nbsp;in&nbsp;the&nbsp;`redrawnboxes`&nbsp;ar</span><span class="mtk9">ray.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">box.delete</span><span class="mtk13">(</span><span class="mtk33">redrawnBox</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">redrawnBox</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk16">box.new</span><span class="mtk13">(</span><span class="mtk33">x</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">y</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">x</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.set</span><span class="mtk13">(</span><span class="mtk33">redrawnBoxes</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">redrawnBox</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Update&nbsp;the&nbsp;properties&nbsp;of&nbsp;the&nbsp;`updatedBox`&nbsp;rathe</span><span class="mtk9">r&nbsp;than&nbsp;redrawing&nbsp;it.&nbsp;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">box.set_lefttop</span><span class="mtk13">(</span><span class="mtk33">updatedBox</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">x</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">y</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">box.set_rightbottom</span><span class="mtk13">(</span><span class="mtk33">updatedBox</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">x</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk13">)</span></span><br></code></div>
<p>The results from
<a href="/pine-script-docs/writing/profiling-and-optimization/#profiling-a-script">profiling this script</a> show that line 24, which contains the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_box.new">box.new()</a>
call, is the <em>heaviest</em> line in the
<a href="/pine-script-docs/writing/profiling-and-optimization/#code-block-results">code block</a> that executes on each bar, with a runtime close to
<strong>double</strong> the combined time spent on the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_box.set_lefttop">box.set_lefttop()</a>
and
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_box.set_rightbottom">box.set_rightbottom()</a>
calls on lines 27 and 28:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Avoiding-redrawing-1.CVCJc2lm_ZJcTqr.webp" alt="image" width="1072" height="514" loading="lazy" decoding="async"></p>
<p>Note that:</p>
<ul>
<li>The number of executions shown for the loop’s <em>local code</em> is
25 times the number shown for the code in the script’s <em>global
scope</em>, as each execution of the loop statement triggers 25
executions of the local block.</li>
<li>This script updates its drawings over <em>all bars</em> in the chart’s
history for <strong>testing</strong> purposes. However, it does <strong>not</strong>
actually need to execute all these historical updates since
users will only see the <strong>final</strong> result from the <em>last
historical bar</em> and the changes across <em>realtime bars</em>. See the
<a href="/pine-script-docs/writing/profiling-and-optimization/#reducing-drawing-updates">next section</a> to learn more.</li>
</ul>
<h3 id="reducing-drawing-updates" class="md-heading"><a href="#reducing-drawing-updates">Reducing drawing <span class="fancy-wrap">updates<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p>When a script produces
<a href="/pine-script-docs/language/type-system/#drawing-types">drawing objects</a> that change across <em>historical bars</em>, users will only ever
see their <strong>final results</strong> on those bars since the script completes its
historical executions when it first loads on the chart. The only time
one will see such drawings <em>evolve</em> across executions is during
<em>realtime bars</em>, as new data flows in.</p>
<p>Since the evolving outputs from dynamic
<a href="/pine-script-docs/language/type-system/#drawing-types">drawings</a> on historical bars are <strong>never visible</strong> to a user, one can
often improve a script’s performance by <em>eliminating</em> the historical
updates that don’t impact the final results.</p>
<p>For example, this script creates a
<a href="https://www.tradingview.com/pine-script-reference/v6/#type_table">table</a>
with two columns and 21 rows to visualize the history of an
<a href="https://www.tradingview.com/support/solutions/43000502338-relative-strength-index-rsi/">RSI</a>
in a paginated, tabular format. The script initializes the cells of the
<code dir="auto">infoTable</code> on the <a href="/pine-script-docs/concepts/bar-states/#barstateisfirst">first bar</a>,
and it references the history of the calculated <code dir="auto">rsi</code> to update the
<code dir="auto">text</code> and <code dir="auto">bgcolor</code> of the cells in the second column within a
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_for">for</a> loop
on each bar:</p>
<div class="pine-colorizer not-content colorized" data-id="6nw"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Reducing&nbsp;drawing&nbsp;updates&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;first&nbsp;offset&nbsp;shown&nbsp;in&nbsp;the&nbsp;paginated&nbsp;table.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">offsetInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Page"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">249</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;A&nbsp;table&nbsp;that&nbsp;shows&nbsp;the&nbsp;history&nbsp;of&nbsp;RSI&nbsp;values.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">table</span><span class="mtk1">&nbsp;</span><span class="mtk33">infoTable</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">table.new</span><span class="mtk13">(</span><span class="mtk11">position.top_right</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">2</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">21</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">border_color</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">chart.fg_color</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">border_width</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//&nbsp;Initialize&nbsp;the&nbsp;table's&nbsp;cells&nbsp;on&nbsp;the&nbsp;first&nbsp;bar.</span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">barstate.isfirst</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell</span><span class="mtk13">(</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Offset"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">text_color</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">chart.fg_color</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell</span><span class="mtk13">(</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"RSI"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">text_color</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">chart.fg_color</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk12">19</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell</span><span class="mtk13">(</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">str.tostring</span><span class="mtk13">(</span><span class="mtk33">offsetInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell</span><span class="mtk13">(</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">rsi</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.rsi</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">14</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Update&nbsp;the&nbsp;history&nbsp;shown&nbsp;in&nbsp;the&nbsp;`infoTable`&nbsp;on&nbsp;</span><span class="mtk9">each&nbsp;bar.&nbsp;</span></span><br><span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk12">19</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">historicalRSI</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">rsi</span><span class="mtk13">[</span><span class="mtk33">offsetInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk13">]</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell_set_text</span><span class="mtk13">(</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">str.tostring</span><span class="mtk13">(</span><span class="mtk33">historicalRSI</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell_set_bgcolor</span><span class="mtk13">(</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.from_gradient</span><span class="mtk13">(</span><span class="mtk33">historicalRSI</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">30</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">70</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.red</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.green</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">rsi</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"RSI"</span><span class="mtk13">)</span></span><br></code></div>
<p>After
<a href="/pine-script-docs/writing/profiling-and-optimization/#profiling-a-script">profiling</a> the script, we see that the code with the highest impact on
performance is the
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_for">for</a> loop
that starts on line 20, i.e., the
<a href="/pine-script-docs/writing/profiling-and-optimization/#code-block-results">code block</a> that updates the table’s cells:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Reducing-drawing-updates-1.DGjGYc9o_Z2h4bJz.webp" alt="image" width="1072" height="494" loading="lazy" decoding="async"></p>
<p>This critical code region executes <strong>excessively</strong> across the chart’s
history, as users will only see the
<a href="/pine-script-docs/visuals/tables/">table’s</a> <strong>final</strong>
historical result. The only time that users will see the
<a href="https://www.tradingview.com/pine-script-reference/v6/#type_table">table</a>
update is on the <strong>last historical bar</strong> and across all subsequent
<strong>realtime bars</strong>. Therefore, we can optimize this script’s resource
usage by restricting the executions of this code to only the <a href="/pine-script-docs/concepts/bar-states/#barstateislast">last
available
bar</a>.</p>
<p>In this script version, we placed the
<a href="/pine-script-docs/language/loops/">loop</a> that updates the
<a href="https://www.tradingview.com/pine-script-reference/v6/#type_table">table</a>
cells within an
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_if">if</a>
structure that uses
<a href="https://www.tradingview.com/pine-script-reference/v6/#var_barstate.islast">barstate.islast</a>
as its condition, effectively restricting the code block’s executions
to only the last historical bar and all realtime bars. Now, the script
<em>loads</em> more efficiently since all the table’s calculations only
require <strong>one</strong> historical execution:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Reducing-drawing-updates-2.DVDSH-lG_Z1AqBk6.webp" alt="image" width="1072" height="520" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="5j1"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Reducing&nbsp;drawing&nbsp;updates&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;first&nbsp;offset&nbsp;shown&nbsp;in&nbsp;the&nbsp;paginated&nbsp;table.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">offsetInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Page"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">249</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;A&nbsp;table&nbsp;that&nbsp;shows&nbsp;the&nbsp;history&nbsp;of&nbsp;RSI&nbsp;values.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">table</span><span class="mtk1">&nbsp;</span><span class="mtk33">infoTable</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">table.new</span><span class="mtk13">(</span><span class="mtk11">position.top_right</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">2</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">21</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">border_color</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">chart.fg_color</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">border_width</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//&nbsp;Initialize&nbsp;the&nbsp;table's&nbsp;cells&nbsp;on&nbsp;the&nbsp;first&nbsp;bar.</span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">barstate.isfirst</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell</span><span class="mtk13">(</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Offset"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">text_color</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">chart.fg_color</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell</span><span class="mtk13">(</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"RSI"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">text_color</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">chart.fg_color</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk12">19</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell</span><span class="mtk13">(</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">str.tostring</span><span class="mtk13">(</span><span class="mtk33">offsetInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell</span><span class="mtk13">(</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">rsi</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.rsi</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">14</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Update&nbsp;the&nbsp;history&nbsp;shown&nbsp;in&nbsp;the&nbsp;`infoTable`&nbsp;on&nbsp;</span><span class="mtk9">the&nbsp;last&nbsp;available&nbsp;bar.</span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">barstate.islast</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk12">19</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">historicalRSI</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">rsi</span><span class="mtk13">[</span><span class="mtk33">offsetInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk13">]</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell_set_text</span><span class="mtk13">(</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">str.tostring</span><span class="mtk13">(</span><span class="mtk33">historicalRSI</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell_set_bgcolor</span><span class="mtk13">(</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.from_gradient</span><span class="mtk13">(</span><span class="mtk33">historicalRSI</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">30</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">70</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.red</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.green</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">rsi</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"RSI"</span><span class="mtk13">)</span></span><br></code></div>
<p>Note that:</p>
<ul>
<li>The script will still update the cells when new <strong>realtime</strong>
updates come in, as users can observe those changes on the
chart, unlike the changes that the script used to execute across
historical bars.</li>
</ul>
<h3 id="storing-calculated-values" class="md-heading"><a href="#storing-calculated-values">Storing calculated <span class="fancy-wrap">values<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p>When a script performs a critical calculation that changes
<em>infrequently</em> throughout all executions, one can reduce its runtime by
<strong>saving the result</strong> to a variable declared with the
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_var">var</a> or
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_varip">varip</a>
keywords and <strong>only</strong> updating the value if the calculation changes. If
the script calculates <em>multiple</em> values excessively, one can store them
within
<a href="/pine-script-docs/language/type-system/#collections">collections</a>,
<a href="/pine-script-docs/language/matrices/">matrices</a>, and
<a href="/pine-script-docs/language/maps/">maps</a> or
<a href="/pine-script-docs/language/objects/">objects</a> of
<a href="/pine-script-docs/language/type-system/#user-defined-types">user-defined types</a>.</p>
<p>Let’s look at an example. This script calculates a weighted moving
average with custom weights based on a generalized <a href="https://en.wikipedia.org/wiki/Window_function" rel="nofollow">window
function</a>. The
<code dir="auto">numerator</code> is the sum of weighted
<a href="https://www.tradingview.com/pine-script-reference/v6/#var_close">close</a>
values, and the <code dir="auto">denominator</code> is the sum of the calculated weights. The
script uses a
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_for">for</a> loop
that iterates <code dir="auto">lengthInput</code> times to calculate these sums, then it plots
their ratio, i.e., the resulting average:</p>
<div class="pine-colorizer not-content colorized" data-id="4zi"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Storing&nbsp;calculated&nbsp;values&nbsp;demo"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">overlay</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;of&nbsp;bars&nbsp;in&nbsp;the&nbsp;weighted&nbsp;average&nbsp;calcul</span><span class="mtk9">ation.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">50</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Length"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">5000</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;Window&nbsp;coefficient.&nbsp;</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">coefInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.float</span><span class="mtk13">(</span><span class="mtk12">0.5</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Window&nbsp;coefficient"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.01</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;sum&nbsp;of&nbsp;weighted&nbsp;`close`&nbsp;prices.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;sum&nbsp;of&nbsp;weights.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">denominator</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;angular&nbsp;step&nbsp;in&nbsp;the&nbsp;cosine&nbsp;calculation.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">step</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">2.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk11">math.pi</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span></span><br><span><span class="mtk9">//&nbsp;Accumulate&nbsp;weighted&nbsp;sums.</span></span><br><span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">weight</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">coefInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">coefInput</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.cos</span><span class="mtk13">(</span><span class="mtk33">step</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">weight</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">denominator</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk33">weight</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;weighted&nbsp;average&nbsp;result.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">denominator</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Weighted&nbsp;average"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">3</span><span class="mtk13">)</span></span><br></code></div>
<p>After
<a href="/pine-script-docs/writing/profiling-and-optimization/#profiling-a-script">profiling</a> the script’s performance over our chart’s data, we see
that it took about 241.3 milliseconds to calculate the default 50-bar
average across 20,155 chart updates, and the critical code with the
<em>highest impact</em> on the script’s performance is the loop
<a href="/pine-script-docs/writing/profiling-and-optimization/#code-block-results">block</a> that starts on line 17:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Storing-calculated-values-1.Db6QOvTY_1SK8Tz.webp" alt="image" width="1072" height="424" loading="lazy" decoding="async"></p>
<p>Since the number of loop iterations <em>depends</em> on the <code dir="auto">lengthInput</code>
value, let’s test how its runtime scales with
<a href="/pine-script-docs/writing/profiling-and-optimization/#profiling-across-configurations">another configuration</a> requiring heavier looping. Here, we set the value to 2500.
This time, the script took about 12 seconds to complete all of its
executions:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Storing-calculated-values-2.DsxEbDvA_DT4zd.webp" alt="image" width="1072" height="424" loading="lazy" decoding="async"></p>
<p>Now that we’ve pinpointed the script’s <em>high-impact</em> code and
established a benchmark to improve, we can inspect the critical code
block to identify optimization opportunities. After examining the
calculations, we can observe the following:</p>
<ul>
<li>The only value that causes the <code dir="auto">weight</code> calculation on line 18 to
vary across loop iterations is the <em>loop index</em>. All other values in
its calculation remain consistent. Consequently, the <code dir="auto">weight</code>
calculated on each loop iteration <strong>does not vary</strong> across chart
bars. Therefore, rather than calculating the weights on <strong>every
update</strong>, we can calculate them <strong>once</strong>, on the first bar, and
<strong>store them</strong> in a
<a href="/pine-script-docs/language/type-system/#collections">collection</a> for future access across subsequent script executions.</li>
<li>Since the weights never change, the resulting <code dir="auto">denominator</code> never
changes. Therefore, we can add the
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_var">var</a>
keyword to the
<a href="/pine-script-docs/language/variable-declarations/">variable declaration</a> and only calculate its value <strong>once</strong> to reduce the
number of executed addition assignment (<a href="https://www.tradingview.com/pine-script-reference/v6/#op_+=">+=</a>)
operations.</li>
<li>Unlike the <code dir="auto">denominator</code>, we <strong>cannot</strong> store the <code dir="auto">numerator</code> value
to simplify its calculation since it consistently <em>changes</em> over
time.</li>
</ul>
<p>In the modified script below, we’ve added a <code dir="auto">weights</code> variable to
reference an
<a href="https://www.tradingview.com/pine-script-reference/v6/#type_array">array</a>
that stores each calculated <code dir="auto">weight</code>. This variable and the
<code dir="auto">denominator</code> both include the
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_var">var</a>
keyword in their declarations, meaning the values assigned to them will
<em>persist</em> throughout all script executions until explicitly reassigned.
The script calculates their values using a
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_for">for</a> loop
that executes only on the <a href="/pine-script-docs/concepts/bar-states/#barstateisfirst">first chart bar</a>.
Across all other bars, it calculates the <code dir="auto">numerator</code> using a
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_for...in">for…in</a>
loop that references the <em>saved values</em> from the <code dir="auto">weights</code> array:</p>
<div class="pine-colorizer not-content colorized" data-id="282"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Storing&nbsp;calculated&nbsp;values&nbsp;demo"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">overlay</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;of&nbsp;bars&nbsp;in&nbsp;the&nbsp;weighted&nbsp;average&nbsp;calcul</span><span class="mtk9">ation.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">50</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Length"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">5000</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;Window&nbsp;coefficient.&nbsp;</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">coefInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.float</span><span class="mtk13">(</span><span class="mtk12">0.5</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Window&nbsp;coefficient"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.01</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;that&nbsp;stores&nbsp;the&nbsp;`weight`&nbsp;values&nbsp;calculat</span><span class="mtk9">ed&nbsp;on&nbsp;the&nbsp;first&nbsp;chart&nbsp;bar.&nbsp;</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">weights</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;()</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;sum&nbsp;of&nbsp;weighted&nbsp;`close`&nbsp;prices.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;sum&nbsp;of&nbsp;weights.&nbsp;The&nbsp;script&nbsp;now&nbsp;only&nbsp;calculate</span><span class="mtk9">s&nbsp;this&nbsp;value&nbsp;on&nbsp;the&nbsp;first&nbsp;bar.&nbsp;</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">denominator</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;angular&nbsp;step&nbsp;in&nbsp;the&nbsp;cosine&nbsp;calculation.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">step</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">2.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk11">math.pi</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Populate&nbsp;the&nbsp;`weights`&nbsp;array&nbsp;and&nbsp;calculate&nbsp;the&nbsp;</span><span class="mtk9">`denominator`&nbsp;only&nbsp;on&nbsp;the&nbsp;first&nbsp;bar.</span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">barstate.isfirst</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">weight</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">coefInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">coefInput</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.cos</span><span class="mtk13">(</span><span class="mtk33">step</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">weights</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">weight</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">denominator</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk33">weight</span></span><br><span><span class="mtk9">//&nbsp;Calculate&nbsp;the&nbsp;`numerator`&nbsp;on&nbsp;each&nbsp;bar&nbsp;using&nbsp;the</span><span class="mtk9">&nbsp;stored&nbsp;`weights`.&nbsp;</span></span><br><span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">w</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">in</span><span class="mtk1">&nbsp;</span><span class="mtk33">weights</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">w</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;weighted&nbsp;average&nbsp;result.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">denominator</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Weighted&nbsp;average"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">3</span><span class="mtk13">)</span></span><br></code></div>
<p>With this optimized structure, the
<a href="/pine-script-docs/writing/profiling-and-optimization/#interpreting-profiled-results">profiled results</a> show that our modified script with a high <code dir="auto">lengthInput</code>
value of 2500 took about 5.9 seconds to calculate across the same data,
about <em>half</em> the time of our previous version:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Storing-calculated-values-3.k6QQwb-Z_ZqmRWt.webp" alt="image" width="1072" height="566" loading="lazy" decoding="async"></p>
<p>Note that:</p>
<ul>
<li>Although we’ve significantly improved this script’s
performance by saving its <em>execution-invariant</em> values to
variables, it does still involve a higher computational cost
with <strong>large</strong> <code dir="auto">lengthInput</code> values due to the remaining loop
calculations that execute on each bar.</li>
<li>Another, more <em>advanced</em> way one can further enhance this
script’s performance is by storing the weights in a
<em>single-row</em>
<a href="https://www.tradingview.com/pine-script-reference/v6/#type_matrix">matrix</a>
on the first bar, using an
<a href="https://www.tradingview.com/pine-script-reference/v6/#type_array">array</a>
as a
<a href="/pine-script-docs/language/arrays/#using-an-array-as-a-queue">queue</a> to hold recent
<a href="https://www.tradingview.com/pine-script-reference/v6/#var_close">close</a>
values, then replacing the
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_for...in">for…in</a>
loop with a call to
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_matrix.mult">matrix.mult()</a>.
See the <a href="/pine-script-docs/language/matrices/">Matrices</a>
page to learn more about working with <code dir="auto">matrix.*()</code> functions.</li>
</ul>
<h3 id="eliminating-loops" class="md-heading"><a href="#eliminating-loops">Eliminating <span class="fancy-wrap">loops<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p><a href="/pine-script-docs/language/loops/">Loops</a> allow Pine scripts to
perform <em>iterative</em> calculations on each execution. Each time a loop
activates, its local code may execute <em>several times</em>, often leading to
a <em>substantial increase</em> in resource usage.</p>
<p>Pine loops are necessary for <em>some</em> calculations, such as manipulating
elements within
<a href="/pine-script-docs/language/type-system/#collections">collections</a> or looking backward through a dataset’s history to
calculate values <em>only</em> obtainable on the current bar. However, in many
other cases, programmers use loops when they <strong>don’t need to</strong>, leading
to suboptimal runtime performance. In such cases, one may eliminate
unnecessary loops in any of the following ways, depending on what their
calculations entail:</p>
<ul>
<li>Identifying simplified, <strong>loop-free expressions</strong> that achieve the
same result without iteration</li>
<li>Replacing a loop with optimized
<a href="/pine-script-docs/writing/profiling-and-optimization/#using-built-ins">built-ins</a> where possible</li>
<li>Distributing a loop’s iterations <em>across bars</em> when feasible rather
than evaluating them all at once</li>
</ul>
<p>This simple example contains an <code dir="auto">avgDifference()</code> function that
calculates the average difference between the current bar’s <code dir="auto">source</code>
value and all the values from <code dir="auto">length</code> previous bars. The script calls
this function to calculate the average difference between the current
<a href="https://www.tradingview.com/pine-script-reference/v6/#var_close">close</a>
price and <code dir="auto">lengthInput</code> previous prices, then it
<a href="/pine-script-docs/visuals/plots/">plots</a> the result on the
chart:</p>
<div class="pine-colorizer not-content colorized" data-id="y"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Eliminating&nbsp;loops&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;of&nbsp;bars&nbsp;in&nbsp;the&nbsp;calculation.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">20</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Length"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Calculates&nbsp;the&nbsp;average&nbsp;difference&nbsp;between&nbsp;the&nbsp;cur</span><span class="mtk9">rent&nbsp;`source`&nbsp;and&nbsp;`length`&nbsp;previous&nbsp;`source`&nbsp;value</span><span class="mtk9">s.</span></span><br><span><span class="mtk15">avgDifference</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">diffSum</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">diffSum</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">]</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">diffSum</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">avgDifference</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk13">))</span></span><br></code></div>
<p>After inspecting the script’s
<a href="/pine-script-docs/writing/profiling-and-optimization/#interpreting-profiled-results">profiled results</a> with the default settings, we see that it took about 64
milliseconds to execute 20,157 times:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Eliminating-loops-1.CagHTlaL_Z1XidNw.webp" alt="image" width="1072" height="304" loading="lazy" decoding="async"></p>
<p>Since we use the <code dir="auto">lengthInput</code> as the <code dir="auto">length</code> argument in the
<code dir="auto">avgDifference()</code> call and that argument controls how many times the
loop inside the function must iterate, our script’s runtime will
<strong>grow</strong> with the <code dir="auto">lengthInput</code> value. Here, we set the input’s value
to 2000 in the script’s settings. This time, the script completed its
executions in about 3.8 seconds:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Eliminating-loops-2.GHOgXfCo_Z2hwC8b.webp" alt="image" width="1072" height="304" loading="lazy" decoding="async"></p>
<p>As we see from these results, the <code dir="auto">avgDifference()</code> function can be
costly to call, depending on the specified <code dir="auto">lengthInput</code> value, due to
its <a href="https://www.tradingview.com/pine-script-reference/v6/#kw_for">for</a>
loop that executes on each bar. However,
<a href="/pine-script-docs/language/loops/">loops</a> are <strong>not</strong> necessary
to achieve the output. To understand why, let’s take a closer look at
the loop’s calculations. We can represent them with the following
expression:</p>
<div class="pine-colorizer not-content colorized" data-id="3ui"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk12">1</span><span class="mtk13">])</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk12">2</span><span class="mtk13">])</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;...&nbsp;+&nbsp;(</span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">length</span><span class="mtk13">])</span></span><br></code></div>
<p>Notice that it adds the <em>current</em> <code dir="auto">source</code> value <code dir="auto">length</code> times. These
iterative additions are not necessary. We can simplify that part of the
expression to <code dir="auto">source * length</code>, which reduces it to the following:</p>
<div class="pine-colorizer not-content colorized" data-id="6h7"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk12">1</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk12">2</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;...&nbsp;-&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">length</span><span class="mtk13">]</span></span><br></code></div>
<p>or equivalently:</p>
<div class="pine-colorizer not-content colorized" data-id="5u0"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk12">1</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk12">2</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;...&nbsp;+&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">length</span><span class="mtk13">])</span></span><br></code></div>
<p>After simplifying and rearranging this representation of the loop’s
calculations, we see that we can compute the result in a simpler way and
<strong>eliminate</strong> the loop by subtracting the previous bar’s rolling sum (<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_math.sum">math.sum()</a>)
of <code dir="auto">source</code> values from the <code dir="auto">source * length</code> value, i.e.:</p>
<div class="pine-colorizer not-content colorized" data-id="6jy"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sum</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)[</span><span class="mtk12">1</span><span class="mtk13">]</span></span><br></code></div>
<p>The <code dir="auto">fastAvgDifference()</code> function below is a <strong>loop-free</strong> alternative
to the original <code dir="auto">avgDifference()</code> function that uses the above
expression to calculate the sum of <code dir="auto">source</code> differences, then divides
the expression by the <code dir="auto">length</code> to return the average difference:</p>
<div class="pine-colorizer not-content colorized" data-id="5zf"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;A&nbsp;faster&nbsp;way&nbsp;to&nbsp;calculate&nbsp;the&nbsp;`avgDifference()`&nbsp;r</span><span class="mtk9">esult.&nbsp;</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Eliminates&nbsp;the&nbsp;`for`&nbsp;loop&nbsp;using&nbsp;the&nbsp;re</span><span class="mtk9">lationship:&nbsp;</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`(x&nbsp;-&nbsp;x[1])&nbsp;+&nbsp;(x&nbsp;-&nbsp;x[2])&nbsp;+&nbsp;...&nbsp;+&nbsp;(x&nbsp;-&nbsp;</span><span class="mtk9">x[n])&nbsp;=&nbsp;x&nbsp;*&nbsp;n&nbsp;-&nbsp;math.sum(x,&nbsp;n)[1]`.</span></span><br><span><span class="mtk15">fastAvgDifference</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sum</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)[</span><span class="mtk12">1</span><span class="mtk13">])</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br></code></div>
<p>Now that we’ve identified a potential optimized solution, we can
compare the performance of <code dir="auto">fastAvgDifference()</code> to the original
<code dir="auto">avgDifference()</code> function. The script below is a modified form of the
previous version that plots the results from calling both functions with
the <code dir="auto">lengthInput</code> as the <code dir="auto">length</code> argument:</p>
<div class="pine-colorizer not-content colorized" data-id="5yq"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Eliminating&nbsp;loops&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;of&nbsp;bars&nbsp;in&nbsp;the&nbsp;calculation.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">20</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Length"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Calculates&nbsp;the&nbsp;average&nbsp;difference&nbsp;between&nbsp;the&nbsp;cur</span><span class="mtk9">rent&nbsp;`source`&nbsp;and&nbsp;`length`&nbsp;previous&nbsp;`source`&nbsp;value</span><span class="mtk9">s.</span></span><br><span><span class="mtk15">avgDifference</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">diffSum</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">diffSum</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">]</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">diffSum</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;A&nbsp;faster&nbsp;way&nbsp;to&nbsp;calculate&nbsp;the&nbsp;`avgDifference()`&nbsp;r</span><span class="mtk9">esult.&nbsp;</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Eliminates&nbsp;the&nbsp;`for`&nbsp;loop&nbsp;using&nbsp;the&nbsp;re</span><span class="mtk9">lationship:&nbsp;</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`(x&nbsp;-&nbsp;x[1])&nbsp;+&nbsp;(x&nbsp;-&nbsp;x[2])&nbsp;+&nbsp;...&nbsp;+&nbsp;(x&nbsp;-&nbsp;</span><span class="mtk9">x[n])&nbsp;=&nbsp;x&nbsp;*&nbsp;n&nbsp;-&nbsp;math.sum(x,&nbsp;n)[1]`.</span></span><br><span><span class="mtk15">fastAvgDifference</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sum</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)[</span><span class="mtk12">1</span><span class="mtk13">])</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">avgDifference</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk13">))</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">fastAvgDifference</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk13">))</span></span><br></code></div>
<p>The
<a href="/pine-script-docs/writing/profiling-and-optimization/#interpreting-profiled-results">profiled results</a> for the script with the default <code dir="auto">lengthInput</code> of 20 show a
substantial difference in runtime spent on the two function calls. The
call to the original function took about 47.3 milliseconds to execute
20,157 times on this run, whereas our optimized function only took 4.5
milliseconds:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Eliminating-loops-3.DiuPpBDh_1dyGfx.webp" alt="image" width="1072" height="410" loading="lazy" decoding="async"></p>
<p>Now, let’s compare the performance with the <em>heavier</em> <code dir="auto">lengthInput</code>
value of 2000. As before, the runtime spent on the <code dir="auto">avgDifference()</code>
function increased significantly. However, the time spent executing the
<code dir="auto">fastAvgDifference()</code> call remained very close to the result from the
previous
<a href="/pine-script-docs/writing/profiling-and-optimization/#profiling-across-configurations">configuration</a>. In other words, while our original function’s runtime
scales directly with its <code dir="auto">length</code> argument, our optimized function
demonstrates relatively <em>consistent</em> performance since it does not
require a loop:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Eliminating-loops-4.V8AwhZcD_23XFmP.webp" alt="image" width="1072" height="410" loading="lazy" decoding="async"></p>
<aside aria-label="Note" class="tv-informer not-content" style="--informer-header-color:#6A6D78;--informer-back-color-light:#F0F3FA;--informer-back-color-dark:#2A2E39"><div class="tv-informer-icon"><svg viewBox="0 0 18 18" width="18" height="18"><path d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16ZM8 6a1 1 0 1 1 2 0 1 1 0 0 1-2 0Zm1 2c.49 0 1 .59 1 1v3.01c0 .42-.51.99-1 .99s-1-.57-1-.99V9c0-.41.51-1 1-1Z" fill="currentColor"></path></svg></div><div class="tv-informer-content"><p><span class="tv-informer-header">Note</span>Not all iterative calculations have loop-free alternatives. If the <strong>only</strong> way to achieve a calculation is through iteration, programmers can still aim to identify ways to optimize their loops for improved performance. See the <a href="/pine-script-docs/writing/profiling-and-optimization/#optimizing-loops">Optimizing loops</a> section below for more information.</p></div></aside>
<h3 id="optimizing-loops" class="md-heading"><a href="#optimizing-loops">Optimizing <span class="fancy-wrap">loops<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p>Although Pine’s
<a href="/pine-script-docs/language/execution-model/">execution model</a> and
the available built-ins often <em>eliminate</em> the need for
<a href="/pine-script-docs/language/loops/">loops</a> in many cases, there
are still instances where a script <strong>will</strong> require
<a href="/pine-script-docs/language/loops/">loops</a> for some types of
tasks, including:</p>
<ul>
<li>Manipulating
<a href="/pine-script-docs/language/type-system/#collections">collections</a> or executing calculations over a collection’s elements
when the available built-ins <strong>will not</strong> suffice</li>
<li>Performing calculations across historical bars that one <strong>cannot</strong>
achieve with simplified <em>loop-free</em> expressions or optimized
<em>built-ins</em></li>
<li>Calculating values that are <strong>only</strong> obtainable through iteration</li>
</ul>
<p>When a script uses <a href="/pine-script-docs/language/loops/">loops</a>
that a programmer cannot
<a href="/pine-script-docs/writing/profiling-and-optimization/#eliminating-loops">eliminate</a>, there are <a href="https://en.wikipedia.org/wiki/Loop_optimization" rel="nofollow">several
techniques</a> one can use
to reduce their performance impact. This section explains two of the
most common, useful techniques that can help improve a required loop’s
efficiency.</p>
<aside aria-label="Tip" class="tv-informer not-content" style="--informer-header-color:#089981;--informer-back-color-light:#DAF2EE;--informer-back-color-dark:#082621"><div class="tv-informer-icon"><svg viewBox="0 0 18 18" width="18" height="18"><path d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16Zm3.87-12.15c.36.2.49.66.28 1.02l-4 7a.75.75 0 0 1-1.18.16l-3-3a.75.75 0 1 1 1.06-1.06l2.3 2.3 3.52-6.14a.75.75 0 0 1 1.02-.28Z" fill="currentColor"></path></svg></div><div class="tv-informer-content"><p><span class="tv-informer-header">Tip</span>Before identifying ways to <em>optimize</em> a loop, we recommend searching for ways to <a href="/pine-script-docs/writing/profiling-and-optimization/#eliminating-loops">eliminate</a> it first. If <strong>no solution</strong> exists that makes the loop unnecessary, then proceed with attempting to reduce its overhead.</p></div></aside>
<h4 id="reducing-loop-calculations" class="md-heading"><a href="#reducing-loop-calculations">Reducing loop <span class="fancy-wrap">calculations<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h4>
<p>The code executed within a <a href="/pine-script-docs/language/loops/">loop’s</a> local scope can have a <strong>multiplicative</strong> impact on its
overall runtime, as each time a loop statement executes, it will
typically trigger <em>several</em> iterations of the local code. Therefore,
programmers should strive to keep a loop’s calculations as simple as
possible by eliminating unnecessary structures, function calls, and
operations to minimize the performance impact, especially when the
script must evaluate its loops <em>numerous times</em> throughout all its
executions.</p>
<p>For example, this script contains a <code dir="auto">filteredMA()</code> function that
calculates a moving average of up to <code dir="auto">length</code> unique <code dir="auto">source</code> values,
depending on the <code dir="auto">true</code> elements in a specified <code dir="auto">mask</code>
<a href="https://www.tradingview.com/pine-script-reference/v6/#type_array">array</a>.
The function queues the unique <code dir="auto">source</code> values into a <code dir="auto">data</code>
<a href="https://www.tradingview.com/pine-script-reference/v6/#type_array">array</a>,
uses a
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_for...in">for…in</a>
loop to iterate over the <code dir="auto">data</code> and calculate the <code dir="auto">numerator</code> and
<code dir="auto">denominator</code> sums, then returns the ratio of those sums. Within the
loop, it only adds values to the sums when the <code dir="auto">data</code> element is not
<a href="https://www.tradingview.com/pine-script-reference/v6/#var_na">na</a> and
the <code dir="auto">mask</code> element at the <code dir="auto">index</code> is <code dir="auto">true</code>. The script utilizes this
<a href="/pine-script-docs/language/user-defined-functions/">user-defined function</a> to calculate the average of up to 100 unique
<a href="https://www.tradingview.com/pine-script-reference/v6/#var_close">close</a>
prices filtered by a <code dir="auto">randMask</code> and plots the result on the chart:</p>
<div class="pine-colorizer not-content colorized" data-id="6jl"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Reducing&nbsp;loop&nbsp;calculations&nbsp;demo"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">overlay</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Calculates&nbsp;a&nbsp;moving&nbsp;average&nbsp;of&nbsp;up&nbsp;to&nbsp;`length`&nbsp;uni</span><span class="mtk9">que&nbsp;`source`&nbsp;values&nbsp;filtered&nbsp;by&nbsp;a&nbsp;`mask`&nbsp;array.</span></span><br><span><span class="mtk15">filteredMA</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">bool</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">mask</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Raise&nbsp;a&nbsp;runtime&nbsp;error&nbsp;if&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;`mask`</span><span class="mtk9">&nbsp;doesn't&nbsp;equal&nbsp;the&nbsp;`length`.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">mask</span><span class="mtk1">.</span><span class="mtk15">size</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">!=</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">runtime.error</span><span class="mtk13">(</span><span class="mtk29">"The&nbsp;size&nbsp;of&nbsp;the&nbsp;`mask`&nbsp;array&nbsp;used&nbsp;in&nbsp;the&nbsp;`filtere</span><span class="mtk29">dMA()`&nbsp;call&nbsp;must&nbsp;match&nbsp;the&nbsp;`length`."</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;containing&nbsp;`length`&nbsp;unique&nbsp;`source`&nbsp;valu</span><span class="mtk9">es.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">data</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Queue&nbsp;unique&nbsp;`source`&nbsp;values&nbsp;into&nbsp;the&nbsp;`data`&nbsp;ar</span><span class="mtk9">ray.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk18">not</span><span class="mtk1">&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">includes</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">shift</span><span class="mtk13">()</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;The&nbsp;numerator&nbsp;and&nbsp;denominator&nbsp;of&nbsp;the&nbsp;average.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">denominator</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Loop&nbsp;to&nbsp;calculate&nbsp;sums.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">item</span><span class="mtk1">&nbsp;</span><span class="mtk18">in</span><span class="mtk1">&nbsp;</span><span class="mtk33">data</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk16">na</span><span class="mtk13">(</span><span class="mtk33">item</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">continue</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">index</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.indexof</span><span class="mtk13">(</span><span class="mtk33">data</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">item</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">mask</span><span class="mtk1">.</span><span class="mtk15">get</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;&nbsp;&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk33">item</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">denominator</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Return&nbsp;the&nbsp;average,&nbsp;or&nbsp;the&nbsp;last&nbsp;non-`na`&nbsp;averag</span><span class="mtk9">e&nbsp;value&nbsp;if&nbsp;the&nbsp;current&nbsp;value&nbsp;is&nbsp;`na`.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">fixnan</span><span class="mtk13">(</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">denominator</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;of&nbsp;100&nbsp;pseudorandom&nbsp;"bool"&nbsp;values.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">bool</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">randMask</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">bool</span><span class="mtk13">&gt;(</span><span class="mtk12">100</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//&nbsp;Push&nbsp;the&nbsp;first&nbsp;element&nbsp;from&nbsp;`randMask`&nbsp;to&nbsp;the&nbsp;e</span><span class="mtk9">nd&nbsp;and&nbsp;queue&nbsp;a&nbsp;new&nbsp;pseudorandom&nbsp;value.</span></span><br><span><span class="mtk33">randMask</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">(</span><span class="mtk33">randMask</span><span class="mtk1">.</span><span class="mtk15">shift</span><span class="mtk13">())</span></span><br><span><span class="mtk33">randMask</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">(</span><span class="mtk16">math.random</span><span class="mtk13">(</span><span class="mtk33">seed</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">12345</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk13">)</span></span><br><span><span class="mtk33">randMask</span><span class="mtk1">.</span><span class="mtk15">shift</span><span class="mtk13">()</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;`filteredMA()`&nbsp;of&nbsp;up&nbsp;to&nbsp;100&nbsp;unique&nbsp;`cl</span><span class="mtk9">ose`&nbsp;values&nbsp;filtered&nbsp;by&nbsp;the&nbsp;`randMask`.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">filteredMA</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">randMask</span><span class="mtk13">))</span></span><br></code></div>
<p>After
<a href="/pine-script-docs/writing/profiling-and-optimization/#profiling-a-script">profiling the script</a>, we see it took about two seconds to execute 21,778 times.
The code with the highest performance impact is the expression on line
37, which calls the <code dir="auto">filteredMA()</code> function. Within the <code dir="auto">filteredMA()</code>
function’s scope, the
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_for...in">for…in</a>
loop has the highest impact, with the <code dir="auto">index</code> calculation in the loop’s
scope (line 22) contributing the most to the loop’s runtime:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Optimizing-loops-Reducing-loop-calculations-1.DATOq5cw_2jUPjt.webp" alt="image" width="1070" height="684" loading="lazy" decoding="async"></p>
<p>The above code demonstrates suboptimal usage of a
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_for...in">for…in</a>
loop, as we <strong>do not</strong> need to call
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_array.indexof">array.indexof()</a>
to retrieve the <code dir="auto">index</code> in this case. The
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_array.indexof">array.indexof()</a>
function can be <em>costly</em> to call within a loop since it must search
through the <a href="/pine-script-docs/language/arrays/">array’s</a>
contents and locate the corresponding element’s index <em>each time</em> the
script calls it.</p>
<p>To eliminate this costly call from our
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_for...in">for…in</a>
loop, we can use the <em>second form</em> of the structure, which produces a
<em>tuple</em> containing the <strong>index</strong> and the element’s value on each
iteration:</p>
<div class="pine-colorizer not-content colorized" data-id="73z"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk13">[</span><span class="mtk33">index</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">item</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">in</span><span class="mtk1">&nbsp;</span><span class="mtk33">data</span></span><br></code></div>
<p>In this version of the script, we removed the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_array.indexof">array.indexof()</a>
call on line 22 since it is <strong>not</strong> necessary to achieve the intended
result, and we changed the
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_for...in">for…in</a>
loop to use the alternative form:</p>
<div class="pine-colorizer not-content colorized" data-id="6pj"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Reducing&nbsp;loop&nbsp;calculations&nbsp;demo"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">overlay</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Calculates&nbsp;a&nbsp;moving&nbsp;average&nbsp;of&nbsp;up&nbsp;to&nbsp;`length`&nbsp;uni</span><span class="mtk9">que&nbsp;`source`&nbsp;values&nbsp;filtered&nbsp;by&nbsp;a&nbsp;`mask`&nbsp;array.</span></span><br><span><span class="mtk15">filteredMA</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">bool</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">mask</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Raise&nbsp;a&nbsp;runtime&nbsp;error&nbsp;if&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;`mask`</span><span class="mtk9">&nbsp;doesn't&nbsp;equal&nbsp;the&nbsp;`length`.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">mask</span><span class="mtk1">.</span><span class="mtk15">size</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">!=</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">runtime.error</span><span class="mtk13">(</span><span class="mtk29">"The&nbsp;size&nbsp;of&nbsp;the&nbsp;`mask`&nbsp;array&nbsp;used&nbsp;in&nbsp;the&nbsp;`filtere</span><span class="mtk29">dMA()`&nbsp;call&nbsp;must&nbsp;match&nbsp;the&nbsp;`length`."</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;containing&nbsp;`length`&nbsp;unique&nbsp;`source`&nbsp;valu</span><span class="mtk9">es.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">data</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Queue&nbsp;unique&nbsp;`source`&nbsp;values&nbsp;into&nbsp;the&nbsp;`data`&nbsp;ar</span><span class="mtk9">ray.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk18">not</span><span class="mtk1">&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">includes</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">shift</span><span class="mtk13">()</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;The&nbsp;numerator&nbsp;and&nbsp;denominator&nbsp;of&nbsp;the&nbsp;average.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">denominator</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Loop&nbsp;to&nbsp;calculate&nbsp;sums.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk13">[</span><span class="mtk33">index</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">item</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">in</span><span class="mtk1">&nbsp;</span><span class="mtk33">data</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk16">na</span><span class="mtk13">(</span><span class="mtk33">item</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">continue</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">mask</span><span class="mtk1">.</span><span class="mtk15">get</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;&nbsp;&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk33">item</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">denominator</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Return&nbsp;the&nbsp;average,&nbsp;or&nbsp;the&nbsp;last&nbsp;non-`na`&nbsp;averag</span><span class="mtk9">e&nbsp;value&nbsp;if&nbsp;the&nbsp;current&nbsp;value&nbsp;is&nbsp;`na`.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">fixnan</span><span class="mtk13">(</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">denominator</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;of&nbsp;100&nbsp;pseudorandom&nbsp;"bool"&nbsp;values.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">bool</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">randMask</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">bool</span><span class="mtk13">&gt;(</span><span class="mtk12">100</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//&nbsp;Push&nbsp;the&nbsp;first&nbsp;element&nbsp;from&nbsp;`randMask`&nbsp;to&nbsp;the&nbsp;e</span><span class="mtk9">nd&nbsp;and&nbsp;queue&nbsp;a&nbsp;new&nbsp;pseudorandom&nbsp;value.</span></span><br><span><span class="mtk33">randMask</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">(</span><span class="mtk33">randMask</span><span class="mtk1">.</span><span class="mtk15">shift</span><span class="mtk13">())</span></span><br><span><span class="mtk33">randMask</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">(</span><span class="mtk16">math.random</span><span class="mtk13">(</span><span class="mtk33">seed</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">12345</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk13">)</span></span><br><span><span class="mtk33">randMask</span><span class="mtk1">.</span><span class="mtk15">shift</span><span class="mtk13">()</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;`filteredMA()`&nbsp;of&nbsp;up&nbsp;to&nbsp;100&nbsp;unique&nbsp;`cl</span><span class="mtk9">ose`&nbsp;values&nbsp;filtered&nbsp;by&nbsp;the&nbsp;`randMask`.&nbsp;</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">filteredMA</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">randMask</span><span class="mtk13">))</span></span><br></code></div>
<p>With this simple change, our loop is much more efficient, as it no
longer needs to redundantly search through the
<a href="https://www.tradingview.com/pine-script-reference/v6/#type_array">array</a>
on each iteration to keep track of the index. The
<a href="/pine-script-docs/writing/profiling-and-optimization/#interpreting-profiled-results">profiled results</a> from this script run show that it took only 0.6 seconds to
complete its executions, a significant improvement over the previous
version’s result:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Optimizing-loops-Reducing-loop-calculations-2.ChKixPxa_1dGXff.webp" alt="image" width="1070" height="668" loading="lazy" decoding="async"></p>
<h4 id="loop-invariant-code-motion" class="md-heading"><a href="#loop-invariant-code-motion">Loop-invariant code <span class="fancy-wrap">motion<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h4>
<p><em>Loop-invariant code</em> is any code region within a
<a href="/pine-script-docs/language/loops/">loop’s</a> scope that produces
an <strong>unchanging</strong> result on each iteration. When a script’s
<a href="/pine-script-docs/language/loops/">loops</a> contain loop-invariant
code, it can substantially impact performance in some cases due to
excessive, <strong>unnecessary</strong> calculations.</p>
<p>Programmers can optimize a loop with invariant code by <em>moving</em> the
unchanging calculations <strong>outside</strong> the loop’s scope so the script only
needs to evaluate them once per execution rather than repetitively.</p>
<p>The following example contains a <code dir="auto">featureScale()</code> function that creates
a rescaled version of an
<a href="https://www.tradingview.com/pine-script-reference/v6/#type_array">array</a>.
Within the function’s
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_for...in">for…in</a>
loop, it scales each element by calculating its distance from the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_array.min">array.min()</a>
and dividing the value by the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_array.range">array.range()</a>.
The script uses this function to create a <code dir="auto">rescaled</code> version of a
<code dir="auto">prices</code> array, then <a href="/pine-script-docs/visuals/plots/">plots</a> the
difference between the array’s
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_array.first">array.first()</a>
and
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_array.avg">array.avg()</a>
method call results on the chart:</p>
<div class="pine-colorizer not-content colorized" data-id="ai"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Loop-invariant&nbsp;code&nbsp;motion&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Returns&nbsp;a&nbsp;feature&nbsp;scaled&nbsp;version&nbsp;of&nbsp;`this`&nbsp;array.</span></span><br><span><span class="mtk15">featureScale</span><span class="mtk13">(</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;()</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">item</span><span class="mtk1">&nbsp;</span><span class="mtk18">in</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">((</span><span class="mtk33">item</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.min</span><span class="mtk13">(</span><span class="mtk33">this</span><span class="mtk13">))</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.range</span><span class="mtk13">(</span><span class="mtk33">this</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;containing&nbsp;the&nbsp;most&nbsp;recent&nbsp;100&nbsp;`close`&nbsp;p</span><span class="mtk9">rices.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">prices</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk12">100</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//&nbsp;Queue&nbsp;the&nbsp;`close`&nbsp;through&nbsp;the&nbsp;`prices`&nbsp;array.</span></span><br><span><span class="mtk33">prices</span><span class="mtk1">.</span><span class="mtk15">unshift</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span class="mtk33">prices</span><span class="mtk1">.</span><span class="mtk15">pop</span><span class="mtk13">()</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;A&nbsp;feature&nbsp;scaled&nbsp;version&nbsp;of&nbsp;the&nbsp;`prices`&nbsp;array.</span></span><br><span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">rescaled</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">featureScale</span><span class="mtk13">(</span><span class="mtk33">prices</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;difference&nbsp;between&nbsp;the&nbsp;first&nbsp;element&nbsp;a</span><span class="mtk9">nd&nbsp;the&nbsp;average&nbsp;value&nbsp;in&nbsp;the&nbsp;`rescaled`&nbsp;array.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">rescaled</span><span class="mtk1">.</span><span class="mtk15">first</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">rescaled</span><span class="mtk1">.</span><span class="mtk15">avg</span><span class="mtk13">())</span></span><br></code></div>
<p>As we see below, the
<a href="/pine-script-docs/writing/profiling-and-optimization/#interpreting-profiled-results">profiled results</a> for this script after 20,187 executions show it completed
its run in about 3.3 seconds. The code with the highest impact on
performance is the line containing the <code dir="auto">featureScale()</code> function call,
and the function’s critical code is the
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_for...in">for…in</a>
loop block starting on line 7:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Optimizing-loops-Loop-invariant-code-motion-1.BAn098-h_10uiO5.webp" alt="image" width="1072" height="404" loading="lazy" decoding="async"></p>
<p>Upon examining the loop’s calculations, we can see that the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_array.min">array.min()</a>
and
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_array.range">array.range()</a>
calls on line 8 are <strong>loop-invariant</strong>, as they will always produce the
<strong>same result</strong> across each iteration. We can make our loop much more
efficient by assigning the results from these calls to variables
<strong>outside</strong> its scope and referencing them as needed.</p>
<p>The <code dir="auto">featureScale()</code> function in the script below assigns the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_array.min">array.min()</a>
and
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_array.range">array.range()</a>
values to <code dir="auto">minValue</code> and <code dir="auto">rangeValue</code> variables <em>before</em> executing the
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_for...in">for…in</a>
loop. Inside the loop’s local scope, it <em>references</em> the variables
across its iterations rather than repetitively calling these <code dir="auto">array.*()</code>
functions:</p>
<div class="pine-colorizer not-content colorized" data-id="26i"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Loop-invariant&nbsp;code&nbsp;motion&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Returns&nbsp;a&nbsp;feature&nbsp;scaled&nbsp;version&nbsp;of&nbsp;`this`&nbsp;array.</span></span><br><span><span class="mtk15">featureScale</span><span class="mtk13">(</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;()</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">minValue</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.min</span><span class="mtk13">(</span><span class="mtk33">this</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">rangeValue</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.range</span><span class="mtk13">(</span><span class="mtk33">this</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">item</span><span class="mtk1">&nbsp;</span><span class="mtk18">in</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">((</span><span class="mtk33">item</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">minValue</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">rangeValue</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;containing&nbsp;the&nbsp;most&nbsp;recent&nbsp;100&nbsp;`close`&nbsp;p</span><span class="mtk9">rices.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">prices</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk12">100</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//&nbsp;Queue&nbsp;the&nbsp;`close`&nbsp;through&nbsp;the&nbsp;`prices`&nbsp;array.</span></span><br><span><span class="mtk33">prices</span><span class="mtk1">.</span><span class="mtk15">unshift</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span class="mtk33">prices</span><span class="mtk1">.</span><span class="mtk15">pop</span><span class="mtk13">()</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;A&nbsp;feature&nbsp;scaled&nbsp;version&nbsp;of&nbsp;the&nbsp;`prices`&nbsp;array.</span></span><br><span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">rescaled</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">featureScale</span><span class="mtk13">(</span><span class="mtk33">prices</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;difference&nbsp;between&nbsp;the&nbsp;first&nbsp;element&nbsp;a</span><span class="mtk9">nd&nbsp;the&nbsp;average&nbsp;value&nbsp;in&nbsp;the&nbsp;`rescaled`&nbsp;array.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">rescaled</span><span class="mtk1">.</span><span class="mtk15">first</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">rescaled</span><span class="mtk1">.</span><span class="mtk15">avg</span><span class="mtk13">())</span></span><br></code></div>
<p>As we see from the script’s
<a href="/pine-script-docs/writing/profiling-and-optimization/#interpreting-profiled-results">profiled results</a>, moving the <em>loop-invariant</em> calculations outside the loop
leads to a substantial performance improvement. This time, the script
completed its executions in only 289.3 milliseconds:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Optimizing-loops-Loop-invariant-code-motion-2.9LhBcnjw_Zn7pRo.webp" alt="image" width="1072" height="438" loading="lazy" decoding="async"></p>
<h3 id="minimizing-historical-buffer-calculations" class="md-heading"><a href="#minimizing-historical-buffer-calculations">Minimizing historical buffer <span class="fancy-wrap">calculations<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p>Pine scripts create <em>historical buffers</em> for all variables and function
calls their outputs depend on. Each buffer contains information about
the range of historical values the script can access with the
history-referencing operator
<a href="https://www.tradingview.com/pine-script-reference/v6/#op_%5B%5D">[]</a>.</p>
<p>A script <em>automatically</em> determines the required buffer size for all its
variables and function calls by analyzing the historical references
executed during the <strong>first 244 bars</strong> in a dataset. When a script only
references the history of a calculated value <em>after</em> those initial bars,
it will <strong>restart</strong> its executions repetitively across previous bars
with successively larger historical buffers until it either determines
the appropriate size or raises a runtime error. Those repetitive
executions can significantly increase a script’s runtime in some cases.</p>
<p>When a script <em>excessively</em> executes across a dataset to calculate
historical buffers, one effective way to improve its performance is
<em>explicitly</em> defining suitable buffer sizes using the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_max_bars_back">max_bars_back()</a>
function. With appropriate buffer sizes declared explicitly, the script
does not need to re-execute across past data to determine the sizes.</p>
<p>For example, the script below uses a
<a href="/pine-script-docs/visuals/lines-and-boxes/#polylines">polyline</a>
to draw a basic histogram representing the distribution of calculated
<code dir="auto">source</code> values over 500 bars. On the <a href="/pine-script-docs/concepts/bar-states/#barstateislast">last available
bar</a>,
the script uses a
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_for">for</a> loop
to look back through historical values of the calculated <code dir="auto">source</code> series
and determine the
<a href="/pine-script-docs/language/type-system/#chart-points">chart points</a> used by the
<a href="https://www.tradingview.com/pine-script-reference/v6/#type_polyline">polyline</a>
drawing. It also <a href="/pine-script-docs/visuals/plots/">plots</a> the
value of <code dir="auto">bar_index + 1</code> to verify the number of bars it executed
across:</p>
<div class="pine-colorizer not-content colorized" data-id="14e"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Minimizing&nbsp;historical&nbsp;buffer&nbsp;calculations&nbsp;demo"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">overlay</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;A&nbsp;polyline&nbsp;with&nbsp;points&nbsp;that&nbsp;form&nbsp;a&nbsp;histogram&nbsp;of&nbsp;`</span><span class="mtk9">source`&nbsp;values.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">polyline</span><span class="mtk1">&nbsp;</span><span class="mtk33">display</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;difference&nbsp;Q3&nbsp;of&nbsp;`high`&nbsp;prices&nbsp;and&nbsp;Q1&nbsp;of&nbsp;`low</span><span class="mtk9">`&nbsp;prices&nbsp;over&nbsp;500&nbsp;bars.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">innerRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentile_nearest_rank</span><span class="mtk13">(</span><span class="mtk11">high</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">75</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentile_nearest_rank</span><span class="mtk13">(</span><span class="mtk11">low</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">25</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//&nbsp;Calculate&nbsp;the&nbsp;highest&nbsp;and&nbsp;lowest&nbsp;prices,&nbsp;and&nbsp;th</span><span class="mtk9">e&nbsp;total&nbsp;price&nbsp;range,&nbsp;over&nbsp;500&nbsp;bars.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">highest</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.highest</span><span class="mtk13">(</span><span class="mtk12">500</span><span class="mtk13">)</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowest</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.lowest</span><span class="mtk13">(</span><span class="mtk12">500</span><span class="mtk13">)</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">totalRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">highest</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowest</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;source&nbsp;series&nbsp;for&nbsp;histogram&nbsp;calculation.&nbsp;Its&nbsp;</span><span class="mtk9">value&nbsp;is&nbsp;the&nbsp;midpoint&nbsp;between&nbsp;the&nbsp;`open`&nbsp;and&nbsp;`clos</span><span class="mtk9">e`.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.avg</span><span class="mtk13">(</span><span class="mtk11">open</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">barstate.islast</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">polyline.delete</span><span class="mtk13">(</span><span class="mtk33">display</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Calculate&nbsp;the&nbsp;number&nbsp;of&nbsp;histogram&nbsp;bins&nbsp;and&nbsp;thei</span><span class="mtk9">r&nbsp;size.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;&nbsp;&nbsp;</span><span class="mtk33">bins</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">int</span><span class="mtk13">(</span><span class="mtk16">math.round</span><span class="mtk13">(</span><span class="mtk12">5</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">totalRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">innerRange</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">binSize</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">totalRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">bins</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;of&nbsp;chart&nbsp;points&nbsp;for&nbsp;the&nbsp;polyline.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">chart.point</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">points</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">chart.point</span><span class="mtk13">&gt;(</span><span class="mtk33">bins</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">chart.point.new</span><span class="mtk13">(</span><span class="mtk11">na</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Loop&nbsp;to&nbsp;build&nbsp;the&nbsp;histogram.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk12">499</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;histogram&nbsp;bin&nbsp;number.&nbsp;Uses&nbsp;past&nbsp;values&nbsp;of&nbsp;the</span><span class="mtk9">&nbsp;`source`&nbsp;for&nbsp;its&nbsp;calculation.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;script&nbsp;must&nbsp;execute&nbsp;across&nbsp;all&nbsp;pre</span><span class="mtk9">vious&nbsp;bars&nbsp;AGAIN&nbsp;to&nbsp;determine&nbsp;the&nbsp;historical&nbsp;buffe</span><span class="mtk9">r&nbsp;for&nbsp;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`source`,&nbsp;as&nbsp;initial&nbsp;references&nbsp;to&nbsp;the</span><span class="mtk9">&nbsp;calculated&nbsp;series&nbsp;occur&nbsp;AFTER&nbsp;the&nbsp;first&nbsp;244&nbsp;bars.</span><span class="mtk9">&nbsp;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">index</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">int</span><span class="mtk13">((</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowest</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">binSize</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk16">na</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">continue</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">chart.point</span><span class="mtk1">&nbsp;</span><span class="mtk33">currentPoint</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">points</span><span class="mtk1">.</span><span class="mtk15">get</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk16">na</span><span class="mtk13">(</span><span class="mtk33">currentPoint</span><span class="mtk1">.</span><span class="mtk33">index</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">points</span><span class="mtk1">.</span><span class="mtk15">set</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">chart.point.from_index</span><span class="mtk13">(</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">binSize</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowest</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">continue</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">currentPoint</span><span class="mtk1">.</span><span class="mtk33">index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Add&nbsp;final&nbsp;points&nbsp;to&nbsp;the&nbsp;`points`&nbsp;array&nbsp;and&nbsp;draw</span><span class="mtk9">&nbsp;the&nbsp;new&nbsp;`display`&nbsp;polyline.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">points</span><span class="mtk1">.</span><span class="mtk15">unshift</span><span class="mtk13">(</span><span class="mtk16">chart.point.now</span><span class="mtk13">(</span><span class="mtk33">lowest</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">points</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">(</span><span class="mtk16">chart.point.now</span><span class="mtk13">(</span><span class="mtk33">highest</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">display</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk16">polyline.new</span><span class="mtk13">(</span><span class="mtk33">points</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">closed</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Number&nbsp;of&nbsp;bars"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">display</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">display.data_window</span><span class="mtk13">)</span></span><br></code></div>
<p>Since the script <em>only</em> references past <code dir="auto">source</code> values on the <em>last
bar</em>, it will <strong>not</strong> construct a suitable historical buffer for the
series within the first 244 bars on a larger dataset. Consequently, it
will <strong>re-execute</strong> across all historical bars to identify the
appropriate buffer size.</p>
<p>As we see from the
<a href="/pine-script-docs/writing/profiling-and-optimization/#interpreting-profiled-results">profiled results</a> after running the script across 20,320 bars, the number of
<em>global</em> code executions was 162,560, which is <strong>eight times</strong> the
number of chart bars. In other words, the script had to <em>repeat</em> the
historical executions <strong>seven more times</strong> to determine the appropriate
buffer for the <code dir="auto">source</code> series in this case:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Minimizing-historical-buffer-calculations-1.Cyx3FoQJ_Z1xcPM1.webp" alt="image" width="1318" height="532" loading="lazy" decoding="async"></p>
<p>This script will only reference the most recent 500 <code dir="auto">source</code> values on
the last historical bar and all realtime bars. Therefore, we can help it
establish the correct buffer <em>without</em> re-execution by defining a
500-bar referencing length with
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_max_bars_back">max_bars_back()</a>.</p>
<p>In the following script version, we added <a href="https://www.tradingview.com/pine-script-reference/v6/#fun_max_bars_back">max_bars_back(source,
500)</a>
after the variable declaration to explicitly specify that the script
will access up to 500 historical <code dir="auto">source</code> values throughout its
executions:</p>
<div class="pine-colorizer not-content colorized" data-id="1h3"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Minimizing&nbsp;historical&nbsp;buffer&nbsp;calculations&nbsp;demo"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">overlay</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;A&nbsp;polyline&nbsp;with&nbsp;points&nbsp;that&nbsp;form&nbsp;a&nbsp;histogram&nbsp;of&nbsp;`</span><span class="mtk9">source`&nbsp;values.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">polyline</span><span class="mtk1">&nbsp;</span><span class="mtk33">display</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;difference&nbsp;Q3&nbsp;of&nbsp;`high`&nbsp;prices&nbsp;and&nbsp;Q1&nbsp;of&nbsp;`low</span><span class="mtk9">`&nbsp;prices&nbsp;over&nbsp;500&nbsp;bars.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">innerRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentile_nearest_rank</span><span class="mtk13">(</span><span class="mtk11">high</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">75</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentile_nearest_rank</span><span class="mtk13">(</span><span class="mtk11">low</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">25</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//&nbsp;Calculate&nbsp;the&nbsp;highest&nbsp;and&nbsp;lowest&nbsp;prices,&nbsp;and&nbsp;th</span><span class="mtk9">e&nbsp;total&nbsp;price&nbsp;range,&nbsp;over&nbsp;500&nbsp;bars.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">highest</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.highest</span><span class="mtk13">(</span><span class="mtk12">500</span><span class="mtk13">)</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowest</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.lowest</span><span class="mtk13">(</span><span class="mtk12">500</span><span class="mtk13">)</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">totalRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">highest</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowest</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;source&nbsp;series&nbsp;for&nbsp;histogram&nbsp;calculation.&nbsp;Its&nbsp;</span><span class="mtk9">value&nbsp;is&nbsp;the&nbsp;midpoint&nbsp;between&nbsp;the&nbsp;`open`&nbsp;and&nbsp;`clos</span><span class="mtk9">e`.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.avg</span><span class="mtk13">(</span><span class="mtk11">open</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//&nbsp;Explicitly&nbsp;define&nbsp;a&nbsp;500-bar&nbsp;historical&nbsp;buffer&nbsp;f</span><span class="mtk9">or&nbsp;the&nbsp;`source`&nbsp;to&nbsp;prevent&nbsp;recalculation.</span></span><br><span><span class="mtk16">max_bars_back</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">barstate.islast</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">polyline.delete</span><span class="mtk13">(</span><span class="mtk33">display</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Calculate&nbsp;the&nbsp;number&nbsp;of&nbsp;histogram&nbsp;bins&nbsp;and&nbsp;thei</span><span class="mtk9">r&nbsp;size.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;&nbsp;&nbsp;</span><span class="mtk33">bins</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">int</span><span class="mtk13">(</span><span class="mtk16">math.round</span><span class="mtk13">(</span><span class="mtk12">5</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">totalRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">innerRange</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">binSize</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">totalRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">bins</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;of&nbsp;chart&nbsp;points&nbsp;for&nbsp;the&nbsp;polyline.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">chart.point</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">points</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">chart.point</span><span class="mtk13">&gt;(</span><span class="mtk33">bins</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">chart.point.new</span><span class="mtk13">(</span><span class="mtk11">na</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Loop&nbsp;to&nbsp;build&nbsp;the&nbsp;histogram.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk12">499</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;histogram&nbsp;bin&nbsp;number.&nbsp;Uses&nbsp;past&nbsp;values&nbsp;of&nbsp;the</span><span class="mtk9">&nbsp;`source`&nbsp;for&nbsp;its&nbsp;calculation.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Since&nbsp;the&nbsp;`source`&nbsp;now&nbsp;has&nbsp;an&nbsp;appropri</span><span class="mtk9">ate&nbsp;predefined&nbsp;buffer,&nbsp;the&nbsp;script&nbsp;no&nbsp;longer&nbsp;needs&nbsp;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;recalculate&nbsp;across&nbsp;previous&nbsp;bars&nbsp;to</span><span class="mtk9">&nbsp;determine&nbsp;the&nbsp;referencing&nbsp;length.&nbsp;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">index</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">int</span><span class="mtk13">((</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowest</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">binSize</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk16">na</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">continue</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">chart.point</span><span class="mtk1">&nbsp;</span><span class="mtk33">currentPoint</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">points</span><span class="mtk1">.</span><span class="mtk15">get</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk16">na</span><span class="mtk13">(</span><span class="mtk33">currentPoint</span><span class="mtk1">.</span><span class="mtk33">index</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">points</span><span class="mtk1">.</span><span class="mtk15">set</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">chart.point.from_index</span><span class="mtk13">(</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">binSize</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowest</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">continue</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">currentPoint</span><span class="mtk1">.</span><span class="mtk33">index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Add&nbsp;final&nbsp;points&nbsp;to&nbsp;the&nbsp;`points`&nbsp;array&nbsp;and&nbsp;draw</span><span class="mtk9">&nbsp;the&nbsp;new&nbsp;`display`&nbsp;polyline.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">points</span><span class="mtk1">.</span><span class="mtk15">unshift</span><span class="mtk13">(</span><span class="mtk16">chart.point.now</span><span class="mtk13">(</span><span class="mtk33">lowest</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">points</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">(</span><span class="mtk16">chart.point.now</span><span class="mtk13">(</span><span class="mtk33">highest</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">display</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk16">polyline.new</span><span class="mtk13">(</span><span class="mtk33">points</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">closed</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Number&nbsp;of&nbsp;bars"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">display</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">display.data_window</span><span class="mtk13">)</span></span><br></code></div>
<p>With this change, our script no longer needs to re-execute across all
the historical data to determine the buffer size. As we see in the
<a href="/pine-script-docs/writing/profiling-and-optimization/#interpreting-profiled-results">profiled results</a> below, the number of global code executions now aligns with
the number of chart bars, and the script took substantially less time to
complete all of its historical executions:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Minimizing-historical-buffer-calculations-2.DPrfVLfJ_Z1XIu4W.webp" alt="image" width="1318" height="532" loading="lazy" decoding="async"></p>
<p>Note that:</p>
<ul>
<li>This script only requires up to the most recent 501 historical
bars to calculate its drawing output. In this case, another way
to optimize resource usage is to include <code dir="auto">calc_bars_count = 501</code>
in the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_indicator">indicator()</a>
function, which reduces unnecessary script executions by
restricting the historical data the script can calculate across
to 501 bars.</li>
</ul>
<aside aria-label="Notice" class="tv-informer not-content" style="--informer-header-color:#FF9800;--informer-back-color-light:#FFF3E0;--informer-back-color-dark:#33261A"><div class="tv-informer-icon"><svg viewBox="0 0 18 18" width="18" height="18"><path fill-rule="evenodd" d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16ZM9 4c-.79 0-1.38.7-1.25 1.48l.67 4.03a.59.59 0 0 0 1.16 0l.67-4.03A1.27 1.27 0 0 0 9 4Zm0 8a1 1 0 1 0 0 2 1 1 0 0 0 0-2Z" fill="currentColor"></path></svg></div><div class="tv-informer-content"><p><span class="tv-informer-header">Notice</span></p><p>When using <a href="https://www.tradingview.com/pine-script-reference/v6/#fun_max_bars_back">max_bars_back()</a> to explicitly define the buffer size for a series, ensure that the script <strong>does not</strong> reference more past bars than specified during its executions. If the specified buffer size is insufficient, the runtime system still re-executes the script across historical bars to calculate an appropriate size, leading to increased resource use.</p><br><p>Additionally, it’s crucial to understand that large buffers elevate a script’s <em>memory use</em>. Choosing buffer sizes that are larger than what a script needs is a suboptimal practice that yields no benefit. In some cases, excessively large buffers can cause a script to exceed its memory limits. Therefore, when defining a buffer’s size, choose the <strong>smallest</strong> possible size that accommodates the script’s historical references. For example, if a script requires only 500 past values from a series, set the buffer’s size to 500 bars. Setting the buffer to include 5000 bars in such a case causes the script to use significantly more memory than necessary.</p><p></p></div></aside>
<h2 id="tips" class="md-heading"><a href="#tips"> <span class="fancy-wrap">Tips<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h2>
<h3 id="working-around-profiler-overhead" class="md-heading"><a href="#working-around-profiler-overhead">Working around Profiler <span class="fancy-wrap">overhead<span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p>Since the
<a href="/pine-script-docs/writing/profiling-and-optimization/#pine-profiler">Pine Profiler</a> must perform <em>extra calculations</em> to collect performance
data, as explained in
<a href="/pine-script-docs/writing/profiling-and-optimization/#a-look-into-the-profilers-inner-workings">this section</a>, the time it takes to execute a script <strong>increases</strong> while
profiling.</p>
<p>Most scripts will run as expected with the Profiler’s overhead
included. However, when a complex script’s runtime approaches a
<a href="https://www.tradingview.com/support/solutions/43000579793/">plan’s
limit</a>,
using the
<a href="/pine-script-docs/writing/profiling-and-optimization/#pine-profiler">Profiler</a> on it may cause its runtime to <em>exceed</em> the limit. Such a
case indicates that the script likely needs
<a href="/pine-script-docs/writing/profiling-and-optimization/#optimization">optimization</a>, but it can be challenging to know where to start without
being able to
<a href="/pine-script-docs/writing/profiling-and-optimization/#profiling-a-script">profile the code</a>. The most effective workaround in this scenario is reducing
the number of bars the script must execute on. Users can achieve this
reduction in any of the following ways:</p>
<ul>
<li>Selecting a dataset that has fewer data points in its history, e.g.,
a higher timeframe or a symbol with limited data</li>
<li>Using conditional logic to limit code executions to a specific time
or bar range</li>
<li>Including a <code dir="auto">calc_bars_count</code> argument in the script’s declaration
statement to specify how many recent historical bars it can use</li>
</ul>
<p>Reducing the number of data points works in most cases because it
directly decreases the number of times the script must execute,
typically resulting in less accumulated runtime.</p>
<p>As a demonstration, this script contains a <code dir="auto">gcd()</code> function that uses a
<em>naive</em> algorithm to calculate the <a href="https://en.wikipedia.org/wiki/Greatest_common_divisor" rel="nofollow">greatest common
divisor</a> of two
integers. The function initializes its <code dir="auto">result</code> using the smallest
absolute value of the two numbers. Then, it reduces the value of the
<code dir="auto">result</code> by one within a
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_while">while</a>
loop until it can divide both numbers without remainders. This structure
entails that the loop will iterate up to <em>N</em> times, where <em>N</em> is the
smallest of the two arguments.</p>
<p>In this example, the script plots the value of
<code dir="auto">gcd(10000, 10000 + bar_index)</code>. The smallest of the two arguments is
always 10,000 in this case, meaning the
<a href="https://www.tradingview.com/pine-script-reference/v6/#kw_while">while</a>
loop within the function will require up to 10,000 iterations per script
execution, depending on the
<a href="https://www.tradingview.com/pine-script-reference/v6/#var_bar_index">bar_index</a>
value:</p>
<div class="pine-colorizer not-content colorized" data-id="35p"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Script&nbsp;takes&nbsp;too&nbsp;long&nbsp;while&nbsp;profiling&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Calculates&nbsp;the&nbsp;greatest&nbsp;common&nbsp;divisor&nbsp;of&nbsp;`a`&nbsp;and</span><span class="mtk9">&nbsp;`b`&nbsp;using&nbsp;a&nbsp;naive&nbsp;algorithm.</span></span><br><span><span class="mtk15">gcd</span><span class="mtk13">(</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">a</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">b</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;greatest&nbsp;common&nbsp;divisor.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk16">math.min</span><span class="mtk13">(</span><span class="mtk16">math.abs</span><span class="mtk13">(</span><span class="mtk33">a</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.abs</span><span class="mtk13">(</span><span class="mtk33">b</span><span class="mtk13">))</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Reduce&nbsp;the&nbsp;`result`&nbsp;by&nbsp;1&nbsp;until&nbsp;it&nbsp;divides&nbsp;`a`&nbsp;a</span><span class="mtk9">nd&nbsp;`b`&nbsp;without&nbsp;remainders.&nbsp;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">while</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">a</span><span class="mtk1">&nbsp;</span><span class="mtk18">%</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">==</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">and</span><span class="mtk1">&nbsp;</span><span class="mtk33">b</span><span class="mtk1">&nbsp;</span><span class="mtk18">%</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">==</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">break</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">-=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Return&nbsp;the&nbsp;`result`.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">gcd</span><span class="mtk13">(</span><span class="mtk12">10000</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">10000</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk11">bar_index</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"GCD"</span><span class="mtk13">)</span></span><br></code></div>
<p>When we add the script to our chart, it takes a while to execute across
our chart’s data, but it does not raise an error. However, <em>after</em>
enabling the
<a href="/pine-script-docs/writing/profiling-and-optimization/#pine-profiler">Profiler</a>, the script raises a runtime error stating that it exceeded
the Premium plan’s <a href="https://www.tradingview.com/support/solutions/43000579793/">runtime
limit</a> (40
seconds):</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Tips-Working-around-profiler-overhead-The-script-takes-too-long-to-execute-1.ChWuvP-N_1heDWT.webp" alt="image" width="1072" height="590" loading="lazy" decoding="async"></p>
<p>Our current chart has over 20,000 historical bars, which may be too many
for the script to handle within the alloted time while the
<a href="/pine-script-docs/writing/profiling-and-optimization/#pine-profiler">Profiler</a> is active. We can try limiting the number of historical
executions to work around the issue in this case.</p>
<p>Below, we included <code dir="auto">calc_bars_count = 10000</code> in the
<a href="https://www.tradingview.com/pine-script-reference/v6/#fun_indicator">indicator()</a>
function, which limits the script’s available history to the most
recent 10,000 historical bars. After restricting the script’s
historical executions, it no longer exceeds the Premium plan’s limit
while profiling, so we can now inspect its performance results:</p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Tips-Working-around-profiler-overhead-The-script-takes-too-long-to-execute-2.DN-scZLp_Z1HYEfF.webp" alt="image" width="1072" height="590" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="3nz"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs" target="_blank" rel="noopener"><span>Pine Script®</span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip">Copied</div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">6</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Script&nbsp;takes&nbsp;too&nbsp;long&nbsp;while&nbsp;profiling&nbsp;demo"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">calc_bars_count</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">10000</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Calculates&nbsp;the&nbsp;greatest&nbsp;common&nbsp;divisor&nbsp;of&nbsp;`a`&nbsp;and</span><span class="mtk9">&nbsp;`b`&nbsp;using&nbsp;a&nbsp;naive&nbsp;algorithm.</span></span><br><span><span class="mtk15">gcd</span><span class="mtk13">(</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">a</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">b</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;greatest&nbsp;common&nbsp;divisor.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk16">math.min</span><span class="mtk13">(</span><span class="mtk16">math.abs</span><span class="mtk13">(</span><span class="mtk33">a</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.abs</span><span class="mtk13">(</span><span class="mtk33">b</span><span class="mtk13">))</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Reduce&nbsp;the&nbsp;`result`&nbsp;by&nbsp;1&nbsp;until&nbsp;it&nbsp;divides&nbsp;`a`&nbsp;a</span><span class="mtk9">nd&nbsp;`b`&nbsp;without&nbsp;remainders.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">while</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">a</span><span class="mtk1">&nbsp;</span><span class="mtk18">%</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">==</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">and</span><span class="mtk1">&nbsp;</span><span class="mtk33">b</span><span class="mtk1">&nbsp;</span><span class="mtk18">%</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">==</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">break</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">-=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Return&nbsp;the&nbsp;`result`.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">gcd</span><span class="mtk13">(</span><span class="mtk12">10000</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">10000</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk11">bar_index</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"GCD"</span><span class="mtk13">)</span></span><br></code></div>
<aside aria-label="Tip" class="tv-informer not-content" style="--informer-header-color:#089981;--informer-back-color-light:#DAF2EE;--informer-back-color-dark:#082621"><div class="tv-informer-icon"><svg viewBox="0 0 18 18" width="18" height="18"><path d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16Zm3.87-12.15c.36.2.49.66.28 1.02l-4 7a.75.75 0 0 1-1.18.16l-3-3a.75.75 0 1 1 1.06-1.06l2.3 2.3 3.52-6.14a.75.75 0 0 1 1.02-.28Z" fill="currentColor"></path></svg></div><div class="tv-informer-content"><p><span class="tv-informer-header">Tip</span>This process might require trial and error, because identifying the number of executions that a computationally heavy script can handle before timing out is not necessarily straightforward. If a script takes too long to execute after enabling the <a href="/pine-script-docs/writing/profiling-and-optimization/#pine-profiler">Profiler</a>, experiment with different ways to limit its executions until you can profile it successfully.</p></div></aside>      </div> <div class="pagination-buttons not-content" data-astro-cid-xgirumru=""> <a href="/pine-script-docs/writing/debugging" class="pagination-card" data-pagefind-ignore="" data-astro-cid-assl6cvf=""> <p data-astro-cid-assl6cvf="">Previous</p> <h4 class="pagination-card-header" data-astro-cid-assl6cvf=""> <svg width="28" height="28" viewBox="0 0 28 28" data-astro-cid-assl6cvf="" data-icon="theme/arrow-back">  <use xlink:href="#ai:local:theme/arrow-back"></use>  </svg> Debugging  </h4> </a>  <a href="/pine-script-docs/writing/publishing" class="pagination-card" data-pagefind-ignore="" data-astro-cid-assl6cvf=""> <p data-astro-cid-assl6cvf="">Next</p> <h4 class="pagination-card-header" data-astro-cid-assl6cvf="">  Publishing scripts <svg width="28" height="28" viewBox="0 0 28 28" data-astro-cid-assl6cvf="" data-icon="theme/arrow">  <symbol id="ai:local:theme/arrow"><path fill="none" stroke="var(--arrow-fill-color, #131722)" d="m11 8 6 6-6 6"></path></symbol><use xlink:href="#ai:local:theme/arrow"></use>  </svg> </h4> </a>  </div>  </main>   <div id="toc" data-pagefind-ignore="all" data-astro-cid-oor6cujd=""><aside class="document-toc-container ml-4 w-48" data-astro-cid-oor6cujd=""><section id="toc-scroll-section" class="slick-scroll" data-astro-cid-oor6cujd=""><header data-astro-cid-oor6cujd=""><h2 class="toc-header" data-astro-cid-oor6cujd="">On this page</h2></header><ul class="" id="toc-entries" data-astro-cid-oor6cujd=""><a href="#introduction" aria-current="true" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-2" data-current="" data-astro-cid-oor6cujd="">Introduction</li></a><a href="#pine-profiler" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-2" data-astro-cid-oor6cujd="">Pine Profiler</li></a><a href="#profiling-a-script" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-3" data-astro-cid-oor6cujd="">Profiling a script</li></a><a href="#interpreting-profiled-results" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-3" data-astro-cid-oor6cujd="">Interpreting profiled results</li></a><a href="#single-line-results" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-4" data-astro-cid-oor6cujd="">Single-line results</li></a><a href="#code-block-results" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-4" data-astro-cid-oor6cujd="">Code block results</li></a><a href="#user-defined-function-calls" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-4" data-astro-cid-oor6cujd="">User-defined function calls</li></a><a href="#when-requesting-other-contexts" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-4" data-astro-cid-oor6cujd="">When requesting other contexts</li></a><a href="#insignificant-unused-and-redundant-code" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-4" data-astro-cid-oor6cujd="">Insignificant, unused, and redundant code</li></a><a href="#a-look-into-the-profilers-inner-workings" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-3" data-astro-cid-oor6cujd="">A look into the Profiler’s inner workings</li></a><a href="#profiling-across-configurations" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-3" data-astro-cid-oor6cujd="">Profiling across configurations</li></a><a href="#repetitive-profiling" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-3" data-astro-cid-oor6cujd="">Repetitive profiling</li></a><a href="#optimization" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-2" data-astro-cid-oor6cujd="">Optimization</li></a><a href="#using-built-ins" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-3" data-astro-cid-oor6cujd="">Using built-ins</li></a><a href="#reducing-repetition" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-3" data-astro-cid-oor6cujd="">Reducing repetition</li></a><a href="#minimizing-request-calls" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-3" data-astro-cid-oor6cujd="">Minimizing <code>request.*()</code> calls</li></a><a href="#avoiding-redrawing" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-3" data-astro-cid-oor6cujd="">Avoiding redrawing</li></a><a href="#reducing-drawing-updates" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-3" data-astro-cid-oor6cujd="">Reducing drawing updates</li></a><a href="#storing-calculated-values" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-3" data-astro-cid-oor6cujd="">Storing calculated values</li></a><a href="#eliminating-loops" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-3" data-astro-cid-oor6cujd="">Eliminating loops</li></a><a href="#optimizing-loops" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-3" data-astro-cid-oor6cujd="">Optimizing loops</li></a><a href="#reducing-loop-calculations" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-4" data-astro-cid-oor6cujd="">Reducing loop calculations</li></a><a href="#loop-invariant-code-motion" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-4" data-astro-cid-oor6cujd="">Loop-invariant code motion</li></a><a href="#minimizing-historical-buffer-calculations" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-3" data-astro-cid-oor6cujd="">Minimizing historical buffer calculations</li></a><a href="#tips" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-2" data-astro-cid-oor6cujd="">Tips</li></a><a href="#working-around-profiler-overhead" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-3" data-astro-cid-oor6cujd="">Working around Profiler overhead</li></a></ul></section><div class="toc-bottom-fade" data-astro-cid-oor6cujd=""></div><div class="back-top-space" data-astro-cid-oor6cujd=""><div class="not-content" style="" data-astro-cid-pkzv2hgs=""> <a id="back-top-button" title="Back to top" href="#top" data-astro-cid-pkzv2hgs="" class="floating-button not-content stvb-base stvb-pointer stvb-gray stvb-medium stvb-secondary stvb-icon stvb-icon-force-color stvb-force-no-border"> <svg width="18" height="18" viewBox="0 0 18 18" data-astro-cid-oor6cujd="" data-icon="theme/arrow-up">  <symbol id="ai:local:theme/arrow-up"><g fill="none"><g clip-path="url(#a)"><path fill="currentColor" fill-rule="evenodd" d="m9 3.5.5.44 4 3.5-1 1.12-2.75-2.4V14h-1.5V6.15L5.49 8.56l-.98-1.12 4-3.5z" clip-rule="evenodd"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h18v18H0z"></path></clipPath></defs></g></symbol><use xlink:href="#ai:local:theme/arrow-up"></use>  </svg> </a> </div> </div></aside></div> </main> </div>   <footer data-astro-cid-b6pf7ola=""> <div class="footer-content" data-astro-cid-b6pf7ola="">  <ul data-astro-cid-b6pf7ola=""> <li data-astro-cid-b6pf7ola=""> <a href="https://www.tradingview.com/chat/#BfmVowG1TZkKO235" data-astro-cid-b6pf7ola="">Pine Q&amp;A chat</a>  </li><li data-astro-cid-b6pf7ola=""> <a href="https://stackoverflow.com/questions/tagged/pine-script" data-astro-cid-b6pf7ola="">Stack Overflow</a>  ↗ </li><li data-astro-cid-b6pf7ola=""> <a href="https://t.me/PineCodersQA" data-astro-cid-b6pf7ola="">Telegram</a>  ↗ </li><li data-astro-cid-b6pf7ola=""> <a href="https://www.reddit.com/r/TradingView/" data-astro-cid-b6pf7ola="">Reddit</a>  ↗ </li> </ul> <div class="flex" data-astro-cid-b6pf7ola=""></div> <div class="copyright" data-astro-cid-b6pf7ola="">Copyright © 2025 TradingView, Inc.</div> </div> </footer>         </body></html>